<!DOCTYPE html>
<html lang="fr">
<head>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KGHT97MD');</script>
<!-- End Google Tag Manager -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-C2D5ENP3F1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-C2D5ENP3F1');
</script>

<link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
<link rel="shortcut icon" href="/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
<meta name="apple-mobile-web-app-title" content="TypixClin" />
<link rel="manifest" href="/site.webmanifest" />

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Planning de Révision EDN - Organisez et suivez vos révisions pour l'examen national">
<title>Planning Révision EDN - TypixClin</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
:root {
    --primary: #3b82f6;
    --primary-dark: #1d4ed8;
    --primary-light: #60a5fa;
    --primary-gradient: linear-gradient(135deg, #3b82f6, #2563eb);
    --secondary: #475569;
    --accent: #8b5cf6;
    --background: #f5f8ff;
    --white: #ffffff;
    --black: #111827;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --gray-900: #111827;
    --success: #10b981;
    --success-light: #d1fae5;
    --warning: #f59e0b;
    --warning-light: #fef3c7;
    --danger: #ef4444;
    --danger-light: #fee2e2;
    --confidence-1: #991b1b;
    --confidence-2: #dc2626;
    --confidence-3: #f59e0b;
    --confidence-4: #22c55e;
    --confidence-5: #15803d;
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    --shadow-blue: 0 10px 25px -5px rgba(59, 130, 246, 0.5);
    --header-height: 70px;
    --container-max-width: 1400px;
    --border-radius-sm: 0.375rem;
    --border-radius-md: 0.5rem;
    --border-radius-lg: 1rem;
    --border-radius-xl: 1.5rem;
    --border-radius-full: 9999px;
    --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-normal: 300ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-slow: 500ms cubic-bezier(0.4, 0, 0.2, 1);
    --font-display: 'Outfit', sans-serif;
    --font-body: 'Space Grotesk', sans-serif;
    --z-elevated: 10;
    --z-sticky: 100;
    --z-dropdown: 200;
    --z-modal: 300;
    --z-max: 9999;
}

[data-theme="dark"] {
    --primary: #60a5fa;
    --primary-dark: #3b82f6;
    --primary-light: #93c5fd;
    --primary-gradient: linear-gradient(135deg, #60a5fa, #3b82f6);
    --background: #0f172a;
    --white: #1e293b;
    --black: #f9fafb;
    --gray-900: #f9fafb;
    --gray-800: #f3f4f6;
    --gray-700: #e5e7eb;
    --gray-600: #d1d5db;
    --gray-500: #9ca3af;
    --gray-400: #6b7280;
    --gray-300: #4b5563;
    --gray-200: #374151;
    --gray-100: #1f2937;
    --gray-50: #111827;
    --success-light: rgba(16, 185, 129, 0.2);
    --warning-light: rgba(245, 158, 11, 0.2);
    --danger-light: rgba(239, 68, 68, 0.2);
}

*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
html { font-size: 16px; scroll-behavior: smooth; }
body { font-family: var(--font-body); background-color: var(--background); color: var(--gray-800); line-height: 1.6; overflow-x: hidden; min-height: 100vh; transition: background-color var(--transition-normal), color var(--transition-normal); }
h1, h2, h3, h4, h5, h6 { font-family: var(--font-display); font-weight: 700; line-height: 1.2; color: var(--gray-900); }
a { text-decoration: none; color: var(--primary); transition: color var(--transition-normal); }
button { cursor: pointer; font-family: var(--font-body); border: none; background: none; transition: all var(--transition-normal); }
.container { width: 100%; max-width: var(--container-max-width); margin: 0 auto; padding: 0 1.5rem; }

@keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
@keyframes gradientFlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

.loader-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--background); display: flex; justify-content: center; align-items: center; z-index: var(--z-max); transition: opacity var(--transition-slow), visibility var(--transition-slow); }
.loader { display: flex; flex-direction: column; align-items: center; gap: 2rem; }
.loader-logo { width: 120px; height: 120px; position: relative; }
.loader-logo::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; border: 4px solid var(--gray-200); border-top-color: var(--primary); animation: spin 1s linear infinite; }
.loader-text { font-family: var(--font-display); font-size: 2rem; font-weight: 800; color: var(--primary); letter-spacing: -0.05em; }

.header { position: fixed; top: 0; left: 0; width: 100%; height: var(--header-height); z-index: var(--z-sticky); background-color: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); transition: all var(--transition-normal); }
[data-theme="dark"] .header { background-color: rgba(30, 41, 59, 0.95); }
.header.scrolled { box-shadow: var(--shadow-md); }
.header-container { height: 100%; display: flex; justify-content: space-between; align-items: center; }
.logo { font-family: var(--font-display); font-size: 1.8rem; font-weight: 800; color: var(--primary); letter-spacing: -0.05em; display: flex; align-items: center; gap: 0.5rem; }
.logo-icon { display: inline-flex; align-items: center; justify-content: center; width: 2.5rem; height: 2.5rem; background: var(--primary-gradient); border-radius: var(--border-radius-md); color: white; font-size: 1.5rem; }
.nav { display: flex; align-items: center; }
.nav-items { display: flex; list-style: none; gap: 2rem; }
.nav-link { font-weight: 500; color: var(--gray-700); transition: color var(--transition-normal); position: relative; }
.nav-link:hover { color: var(--primary); }
.theme-toggle { display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: var(--gray-100); border-radius: var(--border-radius-full); color: var(--gray-600); font-size: 1.25rem; cursor: pointer; margin-left: 2rem; }
[data-theme="dark"] .theme-toggle { background: var(--gray-800); color: var(--gray-300); }
.theme-toggle:hover { background: var(--primary-light); color: white; }
.mobile-menu-btn { display: none; font-size: 1.5rem; color: var(--gray-700); }

.user-auth { display: flex; align-items: center; margin-left: 1rem; position: relative; }
.auth-btn { display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: var(--gray-100); border-radius: var(--border-radius-full); color: var(--gray-600); font-size: 1.1rem; cursor: pointer; border: none; }
[data-theme="dark"] .auth-btn { background: var(--gray-800); color: var(--gray-300); }
.auth-btn:hover { background: var(--primary-light); color: white; }
.user-avatar { width: 40px; height: 40px; border-radius: var(--border-radius-full); background: var(--primary-gradient); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1rem; cursor: pointer; border: 2px solid transparent; text-transform: uppercase; }
.user-avatar:hover { border-color: var(--primary-light); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
.user-avatar img { width: 100%; height: 100%; border-radius: var(--border-radius-full); object-fit: cover; }
.profile-dropdown { position: absolute; top: calc(100% + 10px); right: 0; background: var(--white); border-radius: var(--border-radius-lg); box-shadow: var(--shadow-xl); border: 1px solid var(--gray-200); min-width: 220px; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all var(--transition-normal); z-index: var(--z-dropdown); overflow: hidden; }
.profile-dropdown.active { opacity: 1; visibility: visible; transform: translateY(0); }
.profile-header { padding: 1rem; border-bottom: 1px solid var(--gray-200); background: var(--gray-50); }
.profile-name { font-weight: 600; color: var(--gray-900); font-size: 0.95rem; margin-bottom: 0.2rem; }
.profile-email { font-size: 0.8rem; color: var(--gray-500); word-break: break-all; }
.profile-menu { padding: 0.5rem 0; }
.profile-menu-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; color: var(--gray-700); font-size: 0.9rem; cursor: pointer; border: none; background: none; width: 100%; text-align: left; }
.profile-menu-item:hover { background: var(--gray-100); color: var(--primary); }
.profile-menu-item.logout { color: #dc2626; }
.profile-menu-item.logout:hover { background: #fef2f2; }
.user-auth .auth-btn { display: flex; }
.user-auth .user-avatar { display: none; }
.user-auth .profile-dropdown { display: none; }
.user-auth.logged-in .auth-btn { display: none; }
.user-auth.logged-in .user-avatar { display: flex; }
.user-auth.logged-in .profile-dropdown { display: block; }

@media (max-width: 992px) {
    .nav-items { display: none; }
    .mobile-menu-btn { display: block; }
    .theme-toggle { margin-left: 1.5rem; }
}

.mobile-menu { position: fixed; top: var(--header-height); left: 0; width: 100%; background-color: var(--white); padding: 2rem; z-index: calc(var(--z-sticky) - 1); box-shadow: var(--shadow-lg); transform: translateY(-100%); opacity: 0; visibility: hidden; transition: all var(--transition-normal); display: flex; flex-direction: column; gap: 1.5rem; }
.mobile-menu.active { transform: translateY(0); opacity: 1; visibility: visible; }

.page-header { padding-top: calc(var(--header-height) + 2rem); padding-bottom: 1.5rem; background: linear-gradient(135deg, rgba(239, 246, 255, 0.8) 0%, rgba(219, 234, 254, 0.8) 100%); text-align: center; }
[data-theme="dark"] .page-header { background: linear-gradient(135deg, rgba(17, 24, 39, 0.8) 0%, rgba(31, 41, 55, 0.8) 100%); }
.page-title { font-size: 2.2rem; font-weight: 800; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 0.5rem; animation: fadeInUp var(--transition-slow) forwards; }
.page-subtitle { font-size: 1rem; color: var(--gray-600); max-width: 600px; margin: 0 auto 1rem; }
.back-home-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.6rem 1.2rem; background: var(--primary-gradient); color: white; font-weight: 600; font-size: 0.9rem; border-radius: var(--border-radius-full); box-shadow: var(--shadow-md); }
.back-home-btn:hover { transform: translateY(-3px); box-shadow: var(--shadow-blue); color: white; }

.login-required { padding: 4rem 1.5rem; text-align: center; }
.login-required-card { background: var(--white); border-radius: var(--border-radius-xl); box-shadow: var(--shadow-xl); padding: 3rem 2rem; max-width: 500px; margin: 0 auto; border: 1px solid var(--gray-200); }
.login-required-icon { width: 80px; height: 80px; background: linear-gradient(135deg, var(--gray-100), var(--gray-200)); border-radius: var(--border-radius-full); display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; font-size: 2.5rem; color: var(--gray-400); }
.login-required-title { font-size: 1.5rem; font-weight: 700; color: var(--gray-900); margin-bottom: 0.75rem; }
.login-required-text { color: var(--gray-600); margin-bottom: 2rem; line-height: 1.7; }
.login-required-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 1rem 2rem; background: var(--primary-gradient); color: white; font-weight: 600; font-size: 1rem; border-radius: var(--border-radius-full); box-shadow: var(--shadow-blue); }
.login-required-btn:hover { transform: translateY(-3px); color: white; }

.main-content { padding: 1.5rem; display: none; min-height: calc(100vh - var(--header-height) - 200px); }
.main-content.active { display: block; }

.app-nav { background: var(--white); border-radius: var(--border-radius-xl); box-shadow: var(--shadow-md); padding: 0.5rem; margin-bottom: 1.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap; border: 1px solid var(--gray-200); }
.app-nav-btn { flex: 1; min-width: 140px; padding: 0.875rem 1.25rem; background: transparent; border: none; border-radius: var(--border-radius-lg); font-weight: 600; font-size: 0.95rem; color: var(--gray-600); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
.app-nav-btn:hover { background: var(--gray-100); color: var(--primary); }
.app-nav-btn.active { background: var(--primary-gradient); color: white; box-shadow: var(--shadow-md); }

.app-page { display: none; animation: fadeInUp 0.3s ease; }
.app-page.active { display: block; }

.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.25rem; margin-bottom: 2rem; }
.stat-card { background: var(--white); border-radius: var(--border-radius-lg); padding: 1.5rem; box-shadow: var(--shadow-md); border: 1px solid var(--gray-200); position: relative; overflow: hidden; }
.stat-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; }
.stat-card.blue::before { background: var(--primary); }
.stat-card.green::before { background: var(--success); }
.stat-card.orange::before { background: var(--warning); }
.stat-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }
.stat-icon { width: 50px; height: 50px; border-radius: var(--border-radius-md); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-bottom: 1rem; }
.stat-icon.blue { background: rgba(59, 130, 246, 0.1); color: var(--primary); }
.stat-icon.green { background: rgba(16, 185, 129, 0.1); color: var(--success); }
.stat-icon.orange { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
.stat-value { font-size: 2rem; font-weight: 800; color: var(--gray-900); margin-bottom: 0.25rem; }
.stat-label { font-size: 0.9rem; color: var(--gray-500); }
.stat-sublabel { font-size: 0.75rem; color: var(--gray-400); margin-top: 0.25rem; }
.stat-progress { margin-top: 1rem; }
.progress-bar { height: 6px; background: var(--gray-200); border-radius: var(--border-radius-full); overflow: hidden; }
.progress-fill { height: 100%; border-radius: var(--border-radius-full); transition: width 0.5s ease; }
.progress-fill.blue { background: var(--primary-gradient); }
.progress-fill.green { background: linear-gradient(135deg, #10b981, #059669); }

.section-card { background: var(--white); border-radius: var(--border-radius-xl); box-shadow: var(--shadow-md); border: 1px solid var(--gray-200); overflow: hidden; margin-bottom: 1.5rem; }
.section-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; background: var(--gray-50); }
.section-title { font-size: 1.25rem; font-weight: 700; color: var(--gray-900); display: flex; align-items: center; gap: 0.75rem; }
.section-title i { color: var(--primary); }
.section-body { padding: 1.5rem; }

.specialties-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.25rem; }
.specialty-card { background: var(--white); border-radius: var(--border-radius-lg); border: 1px solid var(--gray-200); padding: 1.25rem; cursor: pointer; position: relative; overflow: hidden; transition: all var(--transition-normal); }
.specialty-card:hover { box-shadow: var(--shadow-lg); transform: translateY(-2px); }
.specialty-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
.specialty-name { font-weight: 700; font-size: 1rem; color: var(--gray-900); flex: 1; display: flex; align-items: center; gap: 0.5rem; }
.specialty-icon { width: 32px; height: 32px; border-radius: var(--border-radius-sm); display: flex; align-items: center; justify-content: center; font-size: 0.9rem; color: white; flex-shrink: 0; }
.specialty-badge { color: white; font-size: 0.75rem; font-weight: 700; padding: 0.25rem 0.6rem; border-radius: var(--border-radius-full); }
.specialty-stats { display: flex; gap: 1rem; flex-wrap: wrap; }
.specialty-stat { display: flex; align-items: center; gap: 0.4rem; font-size: 0.85rem; color: var(--gray-600); }
.specialty-stat.completed { color: var(--success); }
.specialty-progress { margin-top: 1rem; }

.items-container { overflow-x: auto; }
.items-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
.items-table th { background: var(--gray-50); padding: 0.75rem; text-align: left; font-weight: 600; color: var(--gray-700); border-bottom: 2px solid var(--gray-200); white-space: nowrap; position: sticky; top: 0; cursor: pointer; user-select: none; }
.items-table th:hover { background: var(--gray-100); }
.items-table th .sort-icon { margin-left: 0.5rem; opacity: 0.5; font-size: 0.7rem; }
.items-table th.sorted .sort-icon { opacity: 1; color: var(--primary); }
.items-table td { padding: 0.75rem; border-bottom: 1px solid var(--gray-200); vertical-align: top; }
.items-table tr:hover { background: var(--gray-50); }
.items-table .item-num { font-weight: 700; color: var(--primary); min-width: 50px; }
.items-table .item-name { max-width: 200px; font-size: 0.8rem; }
.items-table .item-specialty { font-size: 0.75rem; color: var(--gray-500); white-space: nowrap; }

.tour-cell { min-width: 280px; }
.tour-badges { display: flex; gap: 2px; flex-wrap: nowrap; }
.tour-badge { width: 30px; height: 28px; border-radius: var(--border-radius-sm); display: flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 700; cursor: pointer; border: 2px solid var(--gray-300); background: var(--white); color: var(--gray-400); transition: all var(--transition-fast); }
.tour-badge:hover { border-color: var(--primary); color: var(--primary); transform: scale(1.05); }
.tour-badge.c1 { background: var(--confidence-1); border-color: var(--confidence-1); color: white; }
.tour-badge.c2 { background: var(--confidence-2); border-color: var(--confidence-2); color: white; }
.tour-badge.c3 { background: var(--confidence-3); border-color: var(--confidence-3); color: white; }
.tour-badge.c4 { background: var(--confidence-4); border-color: var(--confidence-4); color: white; }
.tour-badge.c5 { background: var(--confidence-5); border-color: var(--confidence-5); color: white; }
.tour-dates { display: flex; gap: 2px; margin-top: 2px; }
.tour-date { width: 30px; font-size: 0.5rem; color: var(--gray-500); text-align: center; overflow: hidden; }

.resources-cell { min-width: 130px; }
.resource-check { display: flex; align-items: center; gap: 0.3rem; font-size: 0.7rem; color: var(--gray-600); cursor: pointer; margin-bottom: 2px; }
.resource-check input { width: 12px; height: 12px; cursor: pointer; accent-color: var(--primary); }
.resource-check.checked { color: var(--success); font-weight: 600; }

.days-cell { min-width: 70px; text-align: center; }
.days-badge { display: inline-block; padding: 0.2rem 0.5rem; border-radius: var(--border-radius-full); font-size: 0.7rem; font-weight: 600; }
.days-badge.recent { background: var(--success-light); color: var(--success); }
.days-badge.moderate { background: var(--warning-light); color: var(--warning); }
.days-badge.old { background: var(--danger-light); color: var(--danger); }
.days-badge.never { background: var(--gray-200); color: var(--gray-500); }

.confidence-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: var(--z-modal); }
.confidence-modal.active { display: flex; }
.confidence-content { background: var(--white); border-radius: var(--border-radius-lg); padding: 1.5rem; max-width: 320px; width: 90%; box-shadow: var(--shadow-xl); }
.confidence-title { font-size: 1rem; font-weight: 700; margin-bottom: 1rem; text-align: center; color: var(--gray-900); }
.confidence-buttons { display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap; }
.confidence-btn { width: 45px; height: 45px; border-radius: var(--border-radius-md); border: none; font-size: 1.1rem; font-weight: 700; color: white; cursor: pointer; }
.confidence-btn:hover { transform: scale(1.1); }
.confidence-btn.c1 { background: var(--confidence-1); }
.confidence-btn.c2 { background: var(--confidence-2); }
.confidence-btn.c3 { background: var(--confidence-3); }
.confidence-btn.c4 { background: var(--confidence-4); }
.confidence-btn.c5 { background: var(--confidence-5); }
.confidence-btn.remove { background: var(--gray-400); font-size: 0.9rem; }
.confidence-close { width: 100%; margin-top: 1rem; padding: 0.75rem; background: var(--gray-200); border: none; border-radius: var(--border-radius-md); cursor: pointer; font-weight: 600; color: var(--gray-700); }

.filter-bar { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem; align-items: center; }
.search-box { flex: 1; min-width: 200px; position: relative; }
.search-box input { width: 100%; padding: 0.75rem 1rem 0.75rem 2.75rem; border: 1px solid var(--gray-300); border-radius: var(--border-radius-lg); font-size: 0.95rem; background: var(--white); }
.search-box input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
.search-box i { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gray-400); }
.filter-select { padding: 0.75rem 1rem; border: 1px solid var(--gray-300); border-radius: var(--border-radius-lg); font-size: 0.95rem; background: var(--white); min-width: 160px; cursor: pointer; }
.filter-select:focus { outline: none; border-color: var(--primary); }

.saving-indicator { position: fixed; bottom: 2rem; right: 2rem; background: var(--gray-900); color: white; padding: 0.75rem 1.25rem; border-radius: var(--border-radius-full); font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem; opacity: 0; transform: translateY(20px); transition: all var(--transition-normal); z-index: var(--z-elevated); }
.saving-indicator.visible { opacity: 1; transform: translateY(0); }
.saving-indicator i { animation: spin 1s linear infinite; }
.saving-indicator.saved i { animation: none; }

.quick-actions { display: flex; gap: 0.75rem; flex-wrap: wrap; }
.quick-action-btn { padding: 0.5rem 1rem; background: var(--gray-100); border: 1px solid var(--gray-200); border-radius: var(--border-radius-md); font-size: 0.85rem; font-weight: 500; color: var(--gray-700); cursor: pointer; display: flex; align-items: center; gap: 0.4rem; }
.quick-action-btn:hover { background: var(--primary-light); color: white; border-color: var(--primary-light); }

.empty-state { text-align: center; padding: 3rem 2rem; color: var(--gray-500); }
.empty-state i { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }

.back-to-top { position: fixed; bottom: 2rem; right: 2rem; width: 50px; height: 50px; border-radius: var(--border-radius-full); background: var(--primary-gradient); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; cursor: pointer; opacity: 0; visibility: hidden; transform: translateY(20px); transition: all var(--transition-normal); box-shadow: var(--shadow-md); z-index: var(--z-elevated); }
.back-to-top.visible { opacity: 1; visibility: visible; transform: translateY(0); }

.footer { background-color: var(--gray-900); color: var(--gray-400); padding: 3rem 0 1.5rem; }
.footer-container { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 3rem; }
.footer-brand { display: flex; flex-direction: column; gap: 1rem; }
.footer-logo { font-family: var(--font-display); font-size: 1.75rem; font-weight: 800; color: white; }
.footer-description { color: var(--gray-500); font-size: 0.9rem; max-width: 350px; }
.footer-social { display: flex; gap: 0.75rem; }
.social-link { display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; border-radius: var(--border-radius-full); background: var(--gray-800); color: var(--gray-400); font-size: 1.1rem; }
.social-link:hover { background: var(--primary); color: white; }
.footer-nav { display: flex; flex-direction: column; gap: 1rem; }
.footer-nav-title { font-size: 1.1rem; font-weight: 700; color: white; margin-bottom: 0.5rem; }
.footer-nav-links { display: flex; flex-direction: column; gap: 0.5rem; }
.footer-nav-link { color: var(--gray-500); font-size: 0.9rem; }
.footer-nav-link:hover { color: var(--primary-light); }
.footer-bottom { margin-top: 2.5rem; padding-top: 1.5rem; border-top: 1px solid var(--gray-800); display: flex; justify-content: space-between; align-items: center; }
.footer-copyright { color: var(--gray-500); font-size: 0.85rem; }

@media (max-width: 992px) { .footer-container { grid-template-columns: 1fr 1fr; gap: 2rem; } }
@media (max-width: 768px) {
    .page-title { font-size: 1.8rem; }
    .stats-grid { grid-template-columns: 1fr; }
    .specialties-grid { grid-template-columns: 1fr; }
    .app-nav-btn { min-width: 100px; padding: 0.75rem 1rem; font-size: 0.85rem; }
    .app-nav-btn span { display: none; }
    .filter-bar { flex-direction: column; }
    .search-box, .filter-select { width: 100%; }
    .items-table { font-size: 0.75rem; }
    .items-table th, .items-table td { padding: 0.5rem; }
    .footer-container { grid-template-columns: 1fr; gap: 1.5rem; }
    .footer-bottom { flex-direction: column; gap: 1rem; text-align: center; }
}
</style>
</head>

<body>
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KGHT97MD" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

<div class="loader-wrapper" id="loader">
    <div class="loader">
        <div class="loader-logo"></div>
        <div class="loader-text">TypixClin</div>
    </div>
</div>

<header class="header" id="header">
    <div class="container header-container">
        <a href="index.html" class="logo">
            <span class="logo-icon"><i class="fas fa-stethoscope"></i></span>
            TypixClin
        </a>
        <nav class="nav">
            <ul class="nav-items">
                <li><a href="index.html#tools" class="nav-link">Outils</a></li>
                <li><a href="index.html#resources" class="nav-link">Ressources</a></li>
                <li><a href="index.html#ai" class="nav-link">IA</a></li>
                <li><a href="index.html#feedback" class="nav-link">Feedback</a></li>
            </ul>
            <button class="theme-toggle" id="theme-toggle"><i class="fas fa-sun"></i></button>
            <div class="user-auth" id="user-auth">
                <a href="auth.html" class="auth-btn" title="Se connecter"><i class="fas fa-user"></i></a>
                <div class="user-avatar" id="user-avatar" title="Mon profil"><span id="avatar-initials">JD</span></div>
                <div class="profile-dropdown" id="profile-dropdown">
                    <div class="profile-header">
                        <div class="profile-name" id="profile-name">Jean Dupont</div>
                        <div class="profile-email" id="profile-email">jean@example.com</div>
                    </div>
                    <div class="profile-menu">
                        <button class="profile-menu-item logout" id="logout-btn"><i class="fas fa-sign-out-alt"></i><span>Se déconnecter</span></button>
                    </div>
                </div>
            </div>
            <button class="mobile-menu-btn" id="mobile-menu-btn"><i class="fas fa-bars"></i></button>
        </nav>
    </div>
</header>

<div class="mobile-menu" id="mobile-menu">
    <a href="index.html#tools" class="nav-link">Outils</a>
    <a href="index.html#resources" class="nav-link">Ressources</a>
    <a href="index.html#ai" class="nav-link">IA</a>
    <a href="index.html#feedback" class="nav-link">Feedback</a>
</div>

<section class="page-header">
    <div class="container">
        <h1 class="page-title"><i class="fas fa-calendar-check"></i> Tableur de Révision EDN</h1>
        <p class="page-subtitle">Organisez et suivez vos révisions pour les 24 spécialités</p>
        <a href="index.html" class="back-home-btn"><i class="fas fa-arrow-left"></i> Retour à l'accueil</a>
    </div>
</section>

<section class="login-required" id="login-required">
    <div class="login-required-card">
        <div class="login-required-icon"><i class="fas fa-lock"></i></div>
        <h2 class="login-required-title">Connexion requise</h2>
        <p class="login-required-text">Pour accéder à votre tableur de révision personnel et sauvegarder votre progression, vous devez créer un compte gratuit ou vous connecter.<br><br><strong>Tous les items</strong> répartis dans <strong>24 spécialités</strong> vous attendent !</p>
        <a href="auth.html" class="login-required-btn"><i class="fas fa-sign-in-alt"></i> Se connecter / Créer un compte</a>
    </div>
</section>

<section class="main-content" id="main-content">
    <div class="container">
        <nav class="app-nav">
            <button class="app-nav-btn active" data-page="dashboard"><i class="fas fa-home"></i><span>Accueil</span></button>
            <button class="app-nav-btn" data-page="items"><i class="fas fa-list-check"></i><span>Liste des Items</span></button>
        </nav>

        <div class="app-page active" id="page-dashboard">
            <div class="stats-grid">
                <div class="stat-card blue">
                    <div class="stat-icon blue"><i class="fas fa-book-open"></i></div>
                    <div class="stat-value" id="stat-items-done">0</div>
                    <div class="stat-label">Items révisés (≥1 tour)</div>
                    <div class="stat-progress"><div class="progress-bar"><div class="progress-fill blue" id="progress-items" style="width: 0%"></div></div></div>
                </div>
                <div class="stat-card green">
                    <div class="stat-icon green"><i class="fas fa-check-double"></i></div>
                    <div class="stat-value" id="stat-tours-done">0</div>
                    <div class="stat-label">Tours effectués</div>
                    <div class="stat-progress"><div class="progress-bar"><div class="progress-fill green" id="progress-tours" style="width: 0%"></div></div></div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-icon orange"><i class="fas fa-trophy"></i></div>
                    <div class="stat-value" id="stat-specialties-done">0</div>
                    <div class="stat-label">Spécialités terminées</div>
                    <div class="stat-sublabel">(tous items vus ≥1 fois)</div>
                </div>
            </div>
            <div class="section-card">
                <div class="section-header"><h2 class="section-title"><i class="fas fa-chart-line"></i> Progression par spécialité</h2></div>
                <div class="section-body"><div class="specialties-grid" id="dashboard-specialties"></div></div>
            </div>
        </div>

        <div class="app-page" id="page-items">
            <div class="filter-bar">
                <div class="search-box"><i class="fas fa-search"></i><input type="text" id="search-item" placeholder="Rechercher un item..."></div>
                <select class="filter-select" id="filter-item-specialty"><option value="all">Toutes les spécialités</option></select>
                <select class="filter-select" id="filter-item-status">
                    <option value="all">Tous les statuts</option>
                    <option value="not-started">Non commencés</option>
                    <option value="in-progress">En cours</option>
                    <option value="completed">Tous tours faits</option>
                </select>
            </div>
            <div class="section-card">
                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-list-check"></i> Liste des Items</h2>
                    <div class="quick-actions"><button class="quick-action-btn" id="btn-reset-filters"><i class="fas fa-filter-circle-xmark"></i> Réinitialiser</button></div>
                </div>
                <div class="section-body">
                    <div class="items-container">
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th data-sort="num">N° <i class="fas fa-sort sort-icon"></i></th>
                                    <th data-sort="name">Nom <i class="fas fa-sort sort-icon"></i></th>
                                    <th data-sort="specialty">Spécialité <i class="fas fa-sort sort-icon"></i></th>
                                    <th>Tours (T1-T8)</th>
                                    <th>Ressources</th>
                                    <th data-sort="days">Dernière révision <i class="fas fa-sort sort-icon"></i></th>
                                </tr>
                            </thead>
                            <tbody id="items-table-body"></tbody>
                        </table>
                    </div>
                    <div class="empty-state" id="items-empty" style="display: none;"><i class="fas fa-search"></i><p>Aucun item ne correspond</p></div>
                </div>
            </div>
        </div>
    </div>
</section>

<div class="confidence-modal" id="confidence-modal">
    <div class="confidence-content">
        <div class="confidence-title">Niveau de confiance</div>
        <div class="confidence-buttons">
            <button class="confidence-btn c1" data-confidence="1">1</button>
            <button class="confidence-btn c2" data-confidence="2">2</button>
            <button class="confidence-btn c3" data-confidence="3">3</button>
            <button class="confidence-btn c4" data-confidence="4">4</button>
            <button class="confidence-btn c5" data-confidence="5">5</button>
            <button class="confidence-btn remove" data-confidence="0">✕</button>
        </div>
        <button class="confidence-close" id="confidence-close">Annuler</button>
    </div>
</div>

<div class="saving-indicator" id="saving-indicator"><i class="fas fa-spinner"></i><span>Sauvegarde...</span></div>
<div class="back-to-top" id="back-to-top"><i class="fas fa-arrow-up"></i></div>

<footer class="footer">
    <div class="container">
        <div class="footer-container">
            <div class="footer-brand">
                <div class="footer-logo">TypixClin</div>
                <p class="footer-description">Plateforme d'aide à la rédaction des examens cliniques pour étudiants en médecine.</p>
                <div class="footer-social"><a href="https://github.com/JEZENN/TypixClin" class="social-link"><i class="fab fa-github"></i></a></div>
            </div>
            <div class="footer-nav">
                <h4 class="footer-nav-title">Outils</h4>
                <div class="footer-nav-links">
                    <a href="examen-adulte.html" class="footer-nav-link">Examen Adulte</a>
                    <a href="examen-pédiatrique.html" class="footer-nav-link">Examen Pédiatrique</a>
                    <a href="ecg.html" class="footer-nav-link">ECG</a>
                </div>
            </div>
            <div class="footer-nav">
                <h4 class="footer-nav-title">Ressources</h4>
                <div class="footer-nav-links">
                    <a href="Fiche-examen-clinique.html" class="footer-nav-link">Fiche Examen Clinique</a>
                    <a href="Fiche-ECG.html" class="footer-nav-link">Fiche ECG</a>
                </div>
            </div>
            <div class="footer-nav">
                <h4 class="footer-nav-title">À propos</h4>
                <div class="footer-nav-links">
                    <a href="index.html#tools" class="footer-nav-link">Outils</a>
                    <a href="MentionsLégales.html" class="footer-nav-link">Mentions légales</a>
                </div>
            </div>
        </div>
        <div class="footer-bottom"><p class="footer-copyright">© 2025 TypixClin. Tous droits réservés.</p></div>
    </div>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBSJPwPWOAGnWwQN3j2qwu8pxf2iCdO-Gc",
    authDomain: "typixclin-b5fa9.firebaseapp.com",
    projectId: "typixclin-b5fa9",
    storageBucket: "typixclin-b5fa9.firebasestorage.app",
    messagingSenderId: "726560091078",
    appId: "1:726560091078:web:5ce8b31da0bfbbc1f720c7",
    measurementId: "G-9CZ2QB6TNK"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const SPECIALTY_CONFIG = {
    'cardiologie': { color: '#ef4444', icon: 'fa-heart-pulse' },
    'hge': { color: '#f97316', icon: 'fa-disease' },
    'pneumologie': { color: '#3b82f6', icon: 'fa-lungs' },
    'gynecologie': { color: '#ec4899', icon: 'fa-venus' },
    'orl': { color: '#8b5cf6', icon: 'fa-ear-listen' },
    'neurologie': { color: '#6366f1', icon: 'fa-brain' },
    'psychiatrie': { color: '#a855f7', icon: 'fa-head-side-medical' },
    'osteo': { color: '#14b8a6', icon: 'fa-bone' },
    'pediatrie': { color: '#f472b6', icon: 'fa-baby' },
    'hematologie': { color: '#dc2626', icon: 'fa-droplet' },
    'endocrinologie': { color: '#eab308', icon: 'fa-dna' },
    'mir': { color: '#ef4444', icon: 'fa-truck-medical' },
    'nephrologie': { color: '#0ea5e9', icon: 'fa-filter' },
    'infectiologie': { color: '#22c55e', icon: 'fa-virus' },
    'dermatologie': { color: '#f59e0b', icon: 'fa-hand-dots' },
    'therapeutique': { color: '#6366f1', icon: 'fa-pills' },
    'geriatrie': { color: '#78716c', icon: 'fa-person-cane' },
    'douleur': { color: '#a855f7', icon: 'fa-hand-holding-medical' },
    'medecine-interne': { color: '#0d9488', icon: 'fa-stethoscope' },
    'oncologie': { color: '#be123c', icon: 'fa-ribbon' },
    'ophtalmologie': { color: '#0284c7', icon: 'fa-eye' },
    'urologie': { color: '#ca8a04', icon: 'fa-mars' },
    'medecine-legale': { color: '#475569', icon: 'fa-scale-balanced' },
    'sante-publique': { color: '#059669', icon: 'fa-chart-pie' }
};

const SPECIALTIES_DATA = [
  {"id":"cardiologie","name":"Cardiologie - Chir Vasc.","items":[{"fc":"FC01","num":"113","name":"Hémangiomes et malformations vasc cutanées"},{"fc":"FC02","num":"153","name":"Surveillance des porteurs de valves"},{"fc":"FC03","num":"221","name":"Athérome et patient polyathéromateux"},{"fc":"FC04","num":"222","name":"Facteurs de risque CV et prévention"},{"fc":"FC05","num":"224","name":"HTA"},{"fc":"FC06","num":"230","name":"Douleur thoracique"},{"fc":"FC07","num":"231","name":"ECG"},{"fc":"FC08","num":"232","name":"Fibrillation atriale"},{"fc":"FC09","num":"233","name":"Valvulopathies"},{"fc":"FC10","num":"227","name":"Insuffisance veineuse chronique"},{"fc":"FC11","num":"235","name":"Péricardite aigue"},{"fc":"FC12","num":"236","name":"Troubles de la conduction"},{"fc":"FC13","num":"237","name":"Palpitations et trouble du rythme"},{"fc":"FC14","num":"342","name":"Malaise et perte de connaissance"},{"fc":"FC15","num":"339","name":"Angor chronique stable et SCA"},{"fc":"FC16","num":"225","name":"Artériopathies aorte, MI"},{"fc":"FC17","num":"223","name":"Dyslipidémies"},{"fc":"FC18","num":"234","name":"Insuffisance cardiaque"},{"fc":"FC19","num":"238","name":"Souffle cardiaque enfant"},{"fc":"FC20","num":"331","name":"Arrêt cardiocirculatoire"},{"fc":"FC21","num":"226","name":"TVP et EP"},{"fc":"FC22","num":"330","name":"AAP, anticoagulants"},{"fc":"FC23","num":"152","name":"Endocardite infectieuse"},{"fc":"FC24","num":"228","name":"Ulcère de jambe"},{"fc":"FC25","num":"239","name":"Acrosyndromes"}]},
  {"id":"hge","name":"HGE - Chirurgie digestive","items":[{"fc":"FC01","num":"167","name":"Hépatites virales"},{"fc":"FC02","num":"219","name":"Pathologies du fer"},{"fc":"FC03","num":"269","name":"Douleurs abdominales aigues"},{"fc":"FC04","num":"271","name":"RGO et Hernie hiatale"},{"fc":"FC05","num":"272","name":"Ulcère gastrique et duodénal"},{"fc":"FC06","num":"273","name":"Dysphagie oro-pharyngée"},{"fc":"FC07","num":"274","name":"Vomissements de l'adulte"},{"fc":"FC08","num":"276","name":"Hépatomégalie"},{"fc":"FC09","num":"277","name":"Lithiase biliaire"},{"fc":"FC10","num":"278","name":"Ictère de l'adulte"},{"fc":"FC11","num":"279","name":"Cirrhose"},{"fc":"FC12","num":"280","name":"Ascite"},{"fc":"FC13","num":"281","name":"Pancréatite chronique"},{"fc":"FC14","num":"282","name":"MICI"},{"fc":"FC15","num":"283","name":"Constipation"},{"fc":"FC16","num":"284","name":"Colopathie fonctionnelle"},{"fc":"FC17","num":"285","name":"Diarrhée chronique"},{"fc":"FC18","num":"286","name":"Diarrhée aigue"},{"fc":"FC19","num":"287","name":"Diverticulose"},{"fc":"FC20","num":"288","name":"Pathologie hémorroidaire"},{"fc":"FC21","num":"301","name":"Tumeurs colorectales"},{"fc":"FC22","num":"303","name":"Tumeurs estomac"},{"fc":"FC23","num":"304","name":"Tumeurs foie"},{"fc":"FC24","num":"305","name":"Tumeurs oesophage"},{"fc":"FC25","num":"308","name":"Tumeurs pancréas"},{"fc":"FC26","num":"355","name":"Hémorragie digestive"},{"fc":"FC27","num":"358","name":"Pancréatite aigue"},{"fc":"FC28","num":"354","name":"Syndrome occlusif"},{"fc":"FC29","num":"356","name":"Appendicite"},{"fc":"FC30","num":"357","name":"Péritonite aigue"},{"fc":"FC31","num":"201","name":"Transplantation hépatique"},{"fc":"FC32","num":"289","name":"Hernie pariétale"}]},
  {"id":"pneumologie","name":"Pneumologie","items":[{"fc":"FC01","num":"186","name":"Allergies respiratoires"},{"fc":"FC02","num":"188","name":"Asthme, rhinite"},{"fc":"FC03","num":"209","name":"BPCO"},{"fc":"FC04","num":"204","name":"Toux chez l'adulte"},{"fc":"FC05","num":"226","name":"TVP et EP"},{"fc":"FC06","num":"203","name":"Dyspnée aigue et chronique"},{"fc":"FC07","num":"360","name":"Pneumothorax"},{"fc":"FC08","num":"159","name":"Tuberculose"},{"fc":"FC09","num":"206","name":"Epanchement pleural"},{"fc":"FC10","num":"211","name":"Sarcoidose"},{"fc":"FC11","num":"210","name":"PID"},{"fc":"FC12","num":"208","name":"Insuffisance respiratoire chronique"},{"fc":"FC13","num":"75","name":"Addiction tabac"},{"fc":"FC14","num":"205","name":"Hémoptysie"},{"fc":"FC15","num":"359","name":"Détresse respiratoire"},{"fc":"FC16","num":"207","name":"Opacités intrathoraciques"},{"fc":"FC17","num":"306","name":"Tumeurs poumon"},{"fc":"FC18","num":"155","name":"Infections broncho-pulmonaires"}]},
  {"id":"gynecologie","name":"Gynécologie - Obstétrique","items":[{"fc":"FC01","num":"34","name":"Anomalies du cycle menstruel"},{"fc":"FC02","num":"35","name":"Contraception"},{"fc":"FC03","num":"36","name":"IVG"},{"fc":"FC04","num":"37","name":"Infertilité du couple"},{"fc":"FC05","num":"38","name":"AMP"},{"fc":"FC06","num":"39","name":"Algies pelviennes"},{"fc":"FC07","num":"40","name":"Aménorrhée"},{"fc":"FC08","num":"41","name":"Hémorragie génitale"},{"fc":"FC09","num":"42","name":"Tuméfaction pelvienne"},{"fc":"FC10","num":"43","name":"Ménopause"},{"fc":"FC11","num":"22","name":"Grossesse normale"},{"fc":"FC12","num":"23","name":"Complications grossesse"},{"fc":"FC13","num":"24","name":"GEU"},{"fc":"FC14","num":"25","name":"Douleur abdo enceinte"},{"fc":"FC15","num":"26","name":"Prévention risques foetaux"},{"fc":"FC16","num":"27","name":"Infection urinaire grossesse"},{"fc":"FC17","num":"28","name":"VIH grossesse"},{"fc":"FC18","num":"29","name":"Prématurité et RCIU"},{"fc":"FC19","num":"30","name":"Accouchement normal"},{"fc":"FC20","num":"31","name":"Hémorragie post-partum"},{"fc":"FC21","num":"32","name":"Allaitement"},{"fc":"FC22","num":"33","name":"Suites de couches"},{"fc":"FC23","num":"162","name":"Infections génitales"},{"fc":"FC24","num":"302","name":"Tumeurs col utérin"},{"fc":"FC25","num":"300","name":"Tumeurs sein"},{"fc":"FC26","num":"309","name":"Tumeurs ovariennes"},{"fc":"FC27","num":"307","name":"Tumeurs utérus"}]},
  {"id":"orl","name":"ORL - CMF","items":[{"fc":"FC01","num":"87","name":"Epistaxis"},{"fc":"FC02","num":"88","name":"Glandes salivaires"},{"fc":"FC03","num":"89","name":"Fonction auditive"},{"fc":"FC04","num":"90","name":"Annexes oeil"},{"fc":"FC05","num":"99","name":"Paralysie faciale"},{"fc":"FC06","num":"101","name":"Vertige"},{"fc":"FC07","num":"148","name":"Angines"},{"fc":"FC08","num":"149","name":"Otites"},{"fc":"FC09","num":"150","name":"Rhinites sinusites"},{"fc":"FC10","num":"216","name":"Adénopathie"},{"fc":"FC11","num":"270","name":"Dysphagie"},{"fc":"FC12","num":"275","name":"Otalgie otorrhée"},{"fc":"FC13","num":"298","name":"Tumeurs cavum"},{"fc":"FC14","num":"299","name":"Tumeurs buccales"}]},
  {"id":"neurologie","name":"Neurologie - Neurochirurgie","items":[{"fc":"FC01","num":"91","name":"Compression médullaire"},{"fc":"FC02","num":"92","name":"Rachialgie"},{"fc":"FC03","num":"93","name":"Radiculalgie"},{"fc":"FC04","num":"94","name":"Neuropathies périphériques"},{"fc":"FC05","num":"95","name":"Polyradiculonévrite"},{"fc":"FC06","num":"96","name":"Myasthénie"},{"fc":"FC07","num":"97","name":"Migraine, névralgie"},{"fc":"FC08","num":"98","name":"Céphalée"},{"fc":"FC09","num":"100","name":"Diplopie"},{"fc":"FC10","num":"102","name":"SEP"},{"fc":"FC11","num":"103","name":"Épilepsie"},{"fc":"FC12","num":"104","name":"Parkinson"},{"fc":"FC13","num":"105","name":"Mouvements anormaux"},{"fc":"FC14","num":"106","name":"Confusion, démences"},{"fc":"FC15","num":"107","name":"Troubles marche"},{"fc":"FC16","num":"108","name":"Troubles cognitifs"},{"fc":"FC17","num":"336","name":"AVC"},{"fc":"FC18","num":"337","name":"Malaise, crise comitiale"},{"fc":"FC19","num":"338","name":"État confusionnel"},{"fc":"FC20","num":"340","name":"Coma non traumatique"},{"fc":"FC21","num":"341","name":"Hémorragie méningée"},{"fc":"FC22","num":"344","name":"HTIC"},{"fc":"FC23","num":"296","name":"Tumeurs intracrâniennes"},{"fc":"FC24","num":"332","name":"Traumatisé crânien"}]},
  {"id":"psychiatrie","name":"Psychiatrie","items":[{"fc":"FC01","num":"63","name":"Trouble dépressif"},{"fc":"FC02","num":"64","name":"Trouble bipolaire"},{"fc":"FC03","num":"65","name":"Troubles anxieux"},{"fc":"FC04","num":"66","name":"TOC"},{"fc":"FC05","num":"67","name":"Troubles grossesse post-partum"},{"fc":"FC06","num":"68","name":"Troubles sujet âgé"},{"fc":"FC07","num":"69","name":"TCA"},{"fc":"FC08","num":"70","name":"Troubles somatoformes"},{"fc":"FC09","num":"71","name":"Psychothérapies"},{"fc":"FC10","num":"72","name":"Troubles somatiques"},{"fc":"FC11","num":"73","name":"Addiction tabac"},{"fc":"FC12","num":"74","name":"Addiction alcool"},{"fc":"FC13","num":"75","name":"Addiction tabac"},{"fc":"FC14","num":"76","name":"Addiction alcool"},{"fc":"FC15","num":"77","name":"Addiction psychotropes"},{"fc":"FC16","num":"78","name":"Addiction cannabis cocaïne"},{"fc":"FC17","num":"79","name":"Addictions comportementales"},{"fc":"FC18","num":"80","name":"Troubles psychotiques"},{"fc":"FC19","num":"81","name":"Personnalité"},{"fc":"FC20","num":"82","name":"Risque suicidaire"},{"fc":"FC21","num":"83","name":"Psychotropes"},{"fc":"FC22","num":"349","name":"Agitation délire"}]},
  {"id":"osteo","name":"Ostéo-articulaire","items":[{"fc":"FC01","num":"92","name":"Rachialgie"},{"fc":"FC02","num":"93","name":"Radiculalgie"},{"fc":"FC03","num":"125","name":"Arthrose"},{"fc":"FC04","num":"126","name":"PR"},{"fc":"FC05","num":"127","name":"Psoriasis"},{"fc":"FC06","num":"128","name":"Ostéopathies fragilisantes"},{"fc":"FC07","num":"129","name":"Arthropathie microcristalline"},{"fc":"FC08","num":"130","name":"Spondyloarthrite"},{"fc":"FC09","num":"153","name":"Prothèses"},{"fc":"FC10","num":"192","name":"Pathologies auto-immunes"},{"fc":"FC11","num":"193","name":"Raynaud"},{"fc":"FC12","num":"194","name":"Lupus"},{"fc":"FC13","num":"195","name":"Artérite cellules géantes"},{"fc":"FC14","num":"199","name":"SDRC"},{"fc":"FC15","num":"357","name":"Lésion genou"},{"fc":"FC16","num":"358","name":"Prothèses ostéosynthèses"},{"fc":"FC17","num":"359","name":"Fractures adulte"},{"fc":"FC18","num":"360","name":"Fractures enfant"},{"fc":"FC19","num":"361","name":"Malade sous plâtre"},{"fc":"FC20","num":"362","name":"Tumeurs os"}]},
  {"id":"pediatrie","name":"Pédiatrie","items":[{"fc":"FC01","num":"45","name":"Alimentation nourrisson"},{"fc":"FC02","num":"46","name":"Développement buccodentaire"},{"fc":"FC03","num":"47","name":"Puberté"},{"fc":"FC04","num":"48","name":"Pathologie génitoscrotale"},{"fc":"FC05","num":"49","name":"Troubles miction enfant"},{"fc":"FC06","num":"50","name":"Strabisme enfant"},{"fc":"FC07","num":"51","name":"Retard croissance"},{"fc":"FC08","num":"52","name":"Boiterie enfant"},{"fc":"FC09","num":"53","name":"Développement psychomoteur"},{"fc":"FC10","num":"54","name":"Enfant handicapé"},{"fc":"FC11","num":"55","name":"Maltraitance"},{"fc":"FC12","num":"56","name":"Sexualité"},{"fc":"FC13","num":"57","name":"Précarité"},{"fc":"FC14","num":"58","name":"Classifications troubles mentaux"},{"fc":"FC15","num":"59","name":"Troubles langage"},{"fc":"FC16","num":"60","name":"Autisme"},{"fc":"FC17","num":"61","name":"TDAH"},{"fc":"FC18","num":"62","name":"Trouble dépressif"},{"fc":"FC19","num":"151","name":"Infections bronchopulmonaires"},{"fc":"FC20","num":"340","name":"Malaise nourrisson"},{"fc":"FC21","num":"341","name":"Convulsions enfant"},{"fc":"FC22","num":"344","name":"Détresse respiratoire enfant"}]},
  {"id":"hematologie","name":"Hématologie","items":[{"fc":"FC01","num":"209","name":"Anémie"},{"fc":"FC02","num":"210","name":"Thrombopénie"},{"fc":"FC03","num":"211","name":"Purpuras"},{"fc":"FC04","num":"212","name":"Syndrome hémorragique"},{"fc":"FC05","num":"213","name":"Syndrome mononucléosique"},{"fc":"FC06","num":"214","name":"Éosinophilie"},{"fc":"FC07","num":"215","name":"Pathologie fer"},{"fc":"FC08","num":"216","name":"Adénopathie"},{"fc":"FC09","num":"217","name":"Amylose"},{"fc":"FC10","num":"218","name":"Splénomégalie"},{"fc":"FC11","num":"313","name":"SMD"},{"fc":"FC12","num":"314","name":"SMP"},{"fc":"FC13","num":"315","name":"LLC"},{"fc":"FC14","num":"316","name":"Lymphomes"},{"fc":"FC15","num":"317","name":"Myélome"},{"fc":"FC16","num":"318","name":"Leucémies aiguës"},{"fc":"FC17","num":"319","name":"Transfusion"},{"fc":"FC18","num":"320","name":"TVP EP"},{"fc":"FC19","num":"321","name":"Anticoagulants"},{"fc":"FC20","num":"208","name":"Hémogramme"}]},
  {"id":"endocrinologie","name":"Endocrinologie - Nutrition","items":[{"fc":"FC01","num":"220","name":"Adénome hypophysaire"},{"fc":"FC02","num":"221","name":"Insuffisance surrénale"},{"fc":"FC03","num":"222","name":"Hypercalcémie"},{"fc":"FC04","num":"223","name":"Dyslipidémies"},{"fc":"FC05","num":"224","name":"Hyperthyroïdie"},{"fc":"FC06","num":"225","name":"Hypothyroïdie"},{"fc":"FC07","num":"226","name":"Goitre nodules cancers thyroïdiens"},{"fc":"FC08","num":"227","name":"Diabète type 1 et 2"},{"fc":"FC09","num":"228","name":"Complications diabète"},{"fc":"FC10","num":"229","name":"Diabète gestationnel"},{"fc":"FC11","num":"230","name":"Hypoglycémie"},{"fc":"FC12","num":"231","name":"Obésité"},{"fc":"FC13","num":"232","name":"Dénutrition"},{"fc":"FC14","num":"247","name":"Mode de vie"},{"fc":"FC15","num":"248","name":"Régime diététique"},{"fc":"FC16","num":"249","name":"Besoins nutritionnels"},{"fc":"FC17","num":"250","name":"Troubles nutritionnels sujet âgé"},{"fc":"FC18","num":"251","name":"TCA"}]},
  {"id":"mir","name":"MIR - Anesthésie","items":[{"fc":"FC01","num":"329","name":"Prise en charge pré-hospitalière"},{"fc":"FC02","num":"330","name":"Traumatisme crânien"},{"fc":"FC03","num":"331","name":"Coma non traumatique"},{"fc":"FC04","num":"332","name":"État de choc"},{"fc":"FC05","num":"333","name":"Œdème Quincke anaphylaxie"},{"fc":"FC06","num":"334","name":"Arrêt cardiocirculatoire"},{"fc":"FC07","num":"335","name":"AVC"},{"fc":"FC08","num":"336","name":"Hémorragie méningée"},{"fc":"FC09","num":"337","name":"Malaise crise comitiale"},{"fc":"FC10","num":"338","name":"État confusionnel"},{"fc":"FC11","num":"339","name":"SCA"},{"fc":"FC12","num":"340","name":"Malaise nourrisson"},{"fc":"FC13","num":"341","name":"Convulsions enfant"},{"fc":"FC14","num":"343","name":"IRA Anurie"},{"fc":"FC15","num":"344","name":"Détresse respiratoire nourrisson"},{"fc":"FC16","num":"345","name":"Grosse jambe rouge"},{"fc":"FC17","num":"346","name":"Agitation délire"},{"fc":"FC18","num":"347","name":"Rétention urine"},{"fc":"FC19","num":"349","name":"Syndrome occlusif"},{"fc":"FC20","num":"350","name":"Hémorragie digestive"},{"fc":"FC21","num":"351","name":"Appendicite"},{"fc":"FC22","num":"352","name":"Péritonite"},{"fc":"FC23","num":"353","name":"Pancréatite aiguë"},{"fc":"FC24","num":"354","name":"Détresse respiratoire adulte"},{"fc":"FC25","num":"355","name":"Insuffisance respiratoire"},{"fc":"FC26","num":"356","name":"Pneumothorax"},{"fc":"FC27","num":"133","name":"Anesthésie"}]},
  {"id":"nephrologie","name":"Néphrologie","items":[{"fc":"FC01","num":"256","name":"Protéinurie syndrome néphrotique"},{"fc":"FC02","num":"257","name":"Hématurie"},{"fc":"FC03","num":"258","name":"Néphropathie glomérulaire"},{"fc":"FC04","num":"259","name":"Néphropathie vasculaire"},{"fc":"FC05","num":"260","name":"IRC"},{"fc":"FC06","num":"261","name":"IRA"},{"fc":"FC07","num":"262","name":"Troubles acido-basiques"},{"fc":"FC08","num":"263","name":"Hyperkaliémie Hypokaliémie"},{"fc":"FC09","num":"264","name":"Hyponatrémie Hypernatrémie"},{"fc":"FC10","num":"265","name":"Lithiase urinaire"},{"fc":"FC11","num":"266","name":"Hypercalcémie"},{"fc":"FC12","num":"267","name":"Diurétiques"},{"fc":"FC13","num":"310","name":"Tumeurs prostate"},{"fc":"FC14","num":"311","name":"Tumeur rein"},{"fc":"FC15","num":"161","name":"Infections urinaires"},{"fc":"FC16","num":"201","name":"Transplantation"}]},
  {"id":"infectiologie","name":"Infectiologie","items":[{"fc":"FC01","num":"145","name":"Surveillance maladies infectieuses"},{"fc":"FC02","num":"146","name":"Vaccinations"},{"fc":"FC03","num":"147","name":"Fièvre aiguë"},{"fc":"FC04","num":"148","name":"Méningites"},{"fc":"FC05","num":"149","name":"Endocardite"},{"fc":"FC06","num":"150","name":"Infections broncho-pulmonaires"},{"fc":"FC07","num":"151","name":"Infections cutanéo-muqueuses"},{"fc":"FC08","num":"152","name":"Infections ostéo-articulaires"},{"fc":"FC09","num":"153","name":"Infections urinaires"},{"fc":"FC10","num":"154","name":"IST"},{"fc":"FC11","num":"155","name":"Infections digestives"},{"fc":"FC12","num":"156","name":"Herpès virus"},{"fc":"FC13","num":"157","name":"VIH"},{"fc":"FC14","num":"158","name":"Paludisme"},{"fc":"FC15","num":"159","name":"Tuberculose"},{"fc":"FC16","num":"160","name":"Zoonoses"},{"fc":"FC17","num":"161","name":"Voyages"},{"fc":"FC18","num":"162","name":"Grippe"},{"fc":"FC19","num":"163","name":"Hépatites virales"},{"fc":"FC20","num":"172","name":"Anti-infectieux"}]},
  {"id":"dermatologie","name":"Dermatologie","items":[{"fc":"FC01","num":"109","name":"Dermatoses faciales"},{"fc":"FC02","num":"110","name":"Dermatose bulleuse"},{"fc":"FC03","num":"111","name":"Hémangiomes"},{"fc":"FC04","num":"112","name":"Exanthème érythrodermie"},{"fc":"FC05","num":"113","name":"Prurit"},{"fc":"FC06","num":"114","name":"Psoriasis"},{"fc":"FC07","num":"115","name":"Toxidermies"},{"fc":"FC08","num":"116","name":"Dermatoses eczématiformes"},{"fc":"FC09","num":"117","name":"Lupus cutané"},{"fc":"FC10","num":"118","name":"Maladies solaires"},{"fc":"FC11","num":"119","name":"Gale pédiculose"},{"fc":"FC12","num":"151","name":"Infections cutanées"},{"fc":"FC13","num":"164","name":"Herpès"},{"fc":"FC14","num":"300","name":"Tumeurs cutanées"},{"fc":"FC15","num":"345","name":"Grosse jambe rouge"},{"fc":"FC16","num":"228","name":"Ulcère jambe"}]},
  {"id":"therapeutique","name":"Thérapeutique","items":[{"fc":"FC01","num":"322","name":"Risques médicaments"},{"fc":"FC02","num":"323","name":"Études cliniques"},{"fc":"FC03","num":"324","name":"Thérapeutiques non médicamenteuses"},{"fc":"FC04","num":"325","name":"Bon usage médicament"},{"fc":"FC05","num":"326","name":"Médicaments courants"},{"fc":"FC06","num":"83","name":"Psychotropes"},{"fc":"FC07","num":"84","name":"Antithrombotiques"},{"fc":"FC08","num":"172","name":"Anti-infectieux"},{"fc":"FC09","num":"202","name":"Accidents iatrogènes"},{"fc":"FC10","num":"267","name":"Diurétiques"},{"fc":"FC11","num":"319","name":"Transfusion"},{"fc":"FC12","num":"320","name":"Douleur postopératoire"},{"fc":"FC13","num":"321","name":"Éducation thérapeutique"},{"fc":"FC14","num":"131","name":"Douleur"},{"fc":"FC15","num":"132","name":"Antalgiques"}]},
  {"id":"geriatrie","name":"Gériatrie - MPR","items":[{"fc":"FC01","num":"106","name":"Confusion démences"},{"fc":"FC02","num":"107","name":"Troubles marche équilibre"},{"fc":"FC03","num":"108","name":"Troubles cognitifs sujet âgé"},{"fc":"FC04","num":"126","name":"Personne âgée malade"},{"fc":"FC05","num":"127","name":"Déficit neurosensoriel"},{"fc":"FC06","num":"128","name":"Autonomie dépendance"},{"fc":"FC07","num":"129","name":"Troubles marche"},{"fc":"FC08","num":"130","name":"Chutes sujet âgé"},{"fc":"FC09","num":"119","name":"Vieillissement normal"},{"fc":"FC10","num":"120","name":"Ménopause andropause"},{"fc":"FC11","num":"123","name":"Ostéopathies fragilisantes"},{"fc":"FC12","num":"124","name":"Arthrose"},{"fc":"FC13","num":"118","name":"Rééducation réadaptation"},{"fc":"FC14","num":"359","name":"Fractures adulte sujet âgé"},{"fc":"FC15","num":"136","name":"Soins palliatifs"}]},
  {"id":"douleur","name":"Douleur - Soins palliatifs","items":[{"fc":"FC01","num":"131","name":"Douleur aiguë chronique"},{"fc":"FC02","num":"132","name":"Antalgiques"},{"fc":"FC03","num":"133","name":"Anesthésie"},{"fc":"FC04","num":"134","name":"Évaluation douleur"},{"fc":"FC05","num":"135","name":"Douleur enfant"},{"fc":"FC06","num":"136","name":"Soins palliatifs"},{"fc":"FC07","num":"137","name":"Repères cliniques palliatifs"},{"fc":"FC08","num":"138","name":"Sédation"},{"fc":"FC09","num":"139","name":"Palliatifs pédiatrie"},{"fc":"FC10","num":"140","name":"Palliatifs réanimation"},{"fc":"FC11","num":"141","name":"Deuil"},{"fc":"FC12","num":"320","name":"Douleur postopératoire"},{"fc":"FC13","num":"292","name":"Accompagnement cancéreux"},{"fc":"FC14","num":"14","name":"La mort"}]},
  {"id":"medecine-interne","name":"Médecine interne","items":[{"fc":"FC01","num":"185","name":"Réaction inflammatoire"},{"fc":"FC02","num":"186","name":"Fièvre prolongée"},{"fc":"FC03","num":"187","name":"Allergies cutanéo-muqueuses"},{"fc":"FC04","num":"188","name":"Allergies respiratoires"},{"fc":"FC05","num":"189","name":"Anaphylaxie"},{"fc":"FC06","num":"190","name":"Lupus"},{"fc":"FC07","num":"191","name":"Vascularites"},{"fc":"FC08","num":"192","name":"PR"},{"fc":"FC09","num":"193","name":"Spondyloarthrite"},{"fc":"FC10","num":"194","name":"Arthropathie microcristalline"},{"fc":"FC11","num":"195","name":"Raynaud"},{"fc":"FC12","num":"196","name":"Artérite cellules géantes"},{"fc":"FC13","num":"197","name":"Sarcoïdose"},{"fc":"FC14","num":"198","name":"Gougerot-Sjögren"},{"fc":"FC15","num":"199","name":"SDRC"},{"fc":"FC16","num":"200","name":"Déficit immunitaire"},{"fc":"FC17","num":"217","name":"Amylose"},{"fc":"FC18","num":"218","name":"Splénomégalie"}]},
  {"id":"oncologie","name":"Oncologie - Immunologie","items":[{"fc":"FC01","num":"290","name":"Épidémiologie cancers"},{"fc":"FC02","num":"291","name":"Traitements cancers"},{"fc":"FC03","num":"292","name":"Accompagnement cancéreux"},{"fc":"FC04","num":"293","name":"Agranulocytose"},{"fc":"FC05","num":"294","name":"Cancer enfant"},{"fc":"FC06","num":"295","name":"Tumeurs buccales"},{"fc":"FC07","num":"296","name":"Tumeurs intracrâniennes"},{"fc":"FC08","num":"297","name":"Tumeurs utérus"},{"fc":"FC09","num":"298","name":"Tumeurs colorectales"},{"fc":"FC10","num":"299","name":"Tumeurs cutanées"},{"fc":"FC11","num":"300","name":"Tumeurs estomac"},{"fc":"FC12","num":"301","name":"Tumeurs foie"},{"fc":"FC13","num":"302","name":"Tumeurs oesophage"},{"fc":"FC14","num":"303","name":"Tumeurs ovaire"},{"fc":"FC15","num":"304","name":"Tumeurs os"},{"fc":"FC16","num":"305","name":"Tumeurs pancréas"},{"fc":"FC17","num":"306","name":"Tumeurs poumon"},{"fc":"FC18","num":"307","name":"Tumeurs prostate"},{"fc":"FC19","num":"308","name":"Tumeurs rein"},{"fc":"FC20","num":"309","name":"Tumeurs sein"},{"fc":"FC21","num":"200","name":"Déficit immunitaire"},{"fc":"FC22","num":"201","name":"Transplantation"}]},
  {"id":"ophtalmologie","name":"Ophtalmologie","items":[{"fc":"FC01","num":"79","name":"Altération fonction visuelle"},{"fc":"FC02","num":"80","name":"Anomalie vision brutale"},{"fc":"FC03","num":"81","name":"Œil rouge douloureux"},{"fc":"FC04","num":"82","name":"Glaucome chronique"},{"fc":"FC05","num":"83","name":"Troubles réfraction"},{"fc":"FC06","num":"84","name":"Pathologie paupières"},{"fc":"FC07","num":"50","name":"Strabisme enfant"},{"fc":"FC08","num":"127","name":"Déficit neurosensoriel"},{"fc":"FC09","num":"100","name":"Diplopie"},{"fc":"FC10","num":"164","name":"Herpès"},{"fc":"FC11","num":"247","name":"Rétinopathie diabétique"},{"fc":"FC12","num":"224","name":"Rétinopathie hypertensive"}]},
  {"id":"urologie","name":"Urologie","items":[{"fc":"FC01","num":"125","name":"Troubles miction incontinence"},{"fc":"FC02","num":"126","name":"Troubles érection"},{"fc":"FC03","num":"127","name":"HBP"},{"fc":"FC04","num":"260","name":"Hématurie"},{"fc":"FC05","num":"265","name":"Lithiase urinaire"},{"fc":"FC06","num":"310","name":"Tumeurs prostate"},{"fc":"FC07","num":"311","name":"Tumeur rein"},{"fc":"FC08","num":"313","name":"Tumeurs testicule"},{"fc":"FC09","num":"314","name":"Tumeurs vésicales"},{"fc":"FC10","num":"347","name":"Rétention urine"},{"fc":"FC11","num":"36","name":"Contraception masculine"},{"fc":"FC12","num":"161","name":"Infections urinaires"},{"fc":"FC13","num":"201","name":"Transplantation"},{"fc":"FC14","num":"348","name":"IRA Anurie"}]},
  {"id":"medecine-legale","name":"MT - Médecine légale","items":[{"fc":"FC01","num":"05","name":"Responsabilités médicales"},{"fc":"FC02","num":"07","name":"Droits du patient"},{"fc":"FC03","num":"09","name":"Éthique médicale"},{"fc":"FC04","num":"11","name":"Violence et santé"},{"fc":"FC05","num":"12","name":"Violences sexuelles"},{"fc":"FC06","num":"13","name":"Certificats médicaux décès"},{"fc":"FC07","num":"14","name":"La mort"},{"fc":"FC08","num":"57","name":"Maltraitance enfants"},{"fc":"FC09","num":"182","name":"Environnement travail"},{"fc":"FC10","num":"183","name":"Services santé travail"},{"fc":"FC11","num":"184","name":"Accidents travail"}]},
  {"id":"sante-publique","name":"Santé publique","items":[{"fc":"FC01","num":"03","name":"Raisonnement décision médecine"},{"fc":"FC02","num":"04","name":"Infections associées soins"},{"fc":"FC03","num":"05","name":"Responsabilité médicale"},{"fc":"FC04","num":"06","name":"Organisation exercice clinique"},{"fc":"FC05","num":"08","name":"Discriminations santé"},{"fc":"FC06","num":"16","name":"Organisation système soins"},{"fc":"FC07","num":"17","name":"Télémédecine"},{"fc":"FC08","num":"18","name":"Santé numérique"},{"fc":"FC09","num":"19","name":"Protection sociale"},{"fc":"FC10","num":"20","name":"Recherche en santé"},{"fc":"FC11","num":"21","name":"Mesure état santé"},{"fc":"FC12","num":"145","name":"Surveillance maladies infectieuses"},{"fc":"FC13","num":"146","name":"Vaccinations"},{"fc":"FC14","num":"290","name":"Épidémiologie cancers"},{"fc":"FC15","num":"323","name":"Études cliniques"}]}
];

const TOTAL_ITEMS = SPECIALTIES_DATA.reduce((sum, s) => sum + s.items.length, 0);
const MAX_TOURS = 8;

const loader = document.getElementById('loader');
const header = document.getElementById('header');
const mobileMenuBtn = document.getElementById('mobile-menu-btn');
const mobileMenu = document.getElementById('mobile-menu');
const themeToggle = document.getElementById('theme-toggle');
const themeIcon = themeToggle.querySelector('i');
const backToTop = document.getElementById('back-to-top');
const userAuth = document.getElementById('user-auth');
const userAvatar = document.getElementById('user-avatar');
const avatarInitials = document.getElementById('avatar-initials');
const profileDropdown = document.getElementById('profile-dropdown');
const profileName = document.getElementById('profile-name');
const profileEmail = document.getElementById('profile-email');
const logoutBtn = document.getElementById('logout-btn');
const loginRequired = document.getElementById('login-required');
const mainContent = document.getElementById('main-content');
const savingIndicator = document.getElementById('saving-indicator');
const confidenceModal = document.getElementById('confidence-modal');
const statItemsDone = document.getElementById('stat-items-done');
const statToursDone = document.getElementById('stat-tours-done');
const statSpecialtiesDone = document.getElementById('stat-specialties-done');
const progressItems = document.getElementById('progress-items');
const progressTours = document.getElementById('progress-tours');

let currentUser = null;
let userData = null;
let unsubscribe = null;
let saveTimeout = null;
let currentSort = { field: 'num', direction: 'asc' };
let pendingTour = null;

// === SAUVEGARDE LOCALE ===
const isLocalMode = window.location.protocol === 'file:';

function initLocalMode() {
    const saved = localStorage.getItem('planningRevision_local');
    userData = saved ? JSON.parse(saved) : initializeUserData();
    if (loginRequired) loginRequired.style.display = 'none';
    if (mainContent) mainContent.classList.add('active');
    if (userAuth) userAuth.style.display = 'none';
    renderAll();
}

currentUser = null

window.addEventListener('load', () => { setTimeout(() => { loader.style.opacity = '0'; setTimeout(() => loader.style.display = 'none', 500); }, 800); });

mobileMenuBtn?.addEventListener('click', () => {
    mobileMenu.classList.toggle('active');
    mobileMenuBtn.innerHTML = mobileMenu.classList.contains('active') ? '<i class="fas fa-times"></i>' : '<i class="fas fa-bars"></i>';
});

function setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
    themeIcon.classList.remove('fa-sun', 'fa-moon');
    themeIcon.classList.add(theme === 'dark' ? 'fa-moon' : 'fa-sun');
}
setTheme(localStorage.getItem('theme') || 'light');
themeToggle?.addEventListener('click', () => setTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'));

window.addEventListener('scroll', () => {
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    header?.classList.toggle('scrolled', scrollTop > 0);
    backToTop?.classList.toggle('visible', scrollTop > 600);
});
backToTop?.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

document.querySelectorAll('.app-nav-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.app-nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.app-page').forEach(p => p.classList.remove('active'));
        this.classList.add('active');
        document.getElementById('page-' + this.dataset.page).classList.add('active');
    });
});

function getInitials(name) {
    if (!name) return 'U';
    const names = name.trim().split(' ');
    return names.length >= 2 ? (names[0][0] + names[names.length-1][0]).toUpperCase() : name.substring(0,2).toUpperCase();
}

async function updateUserUI(user) {
    if (user) {
        currentUser = user;
        userAuth.classList.add('logged-in');
        loginRequired.style.display = 'none';
        mainContent.classList.add('active');
        try {
            const userDoc = await getDoc(doc(db, 'users', user.uid));
            const userInfo = userDoc.exists() ? userDoc.data() : {};
            const displayName = userInfo.displayName || user.displayName || 'Utilisateur';
            avatarInitials.textContent = getInitials(displayName);
            profileName.textContent = displayName;
            profileEmail.textContent = user.email || '';
        } catch (e) {
            avatarInitials.textContent = getInitials(user.displayName || user.email);
            profileName.textContent = user.displayName || 'Utilisateur';
            profileEmail.textContent = user.email || '';
        }
        loadUserData(user.uid);
		} else {
			currentUser = null;
			userAuth.classList.remove('logged-in');
			if (unsubscribe) { unsubscribe(); unsubscribe = null; }
			
			// Charger les données locales
			const saved = localStorage.getItem('planningRevision_local');
			userData = saved ? JSON.parse(saved) : initializeUserData();
			loginRequired.style.display = 'none';
			mainContent.classList.add('active');
			renderAll();
		}
}

if (isLocalMode) {
    initLocalMode();
} else {
    onAuthStateChanged(auth, updateUserUI);
}

userAvatar?.addEventListener('click', e => { e.stopPropagation(); profileDropdown.classList.toggle('active'); });
document.addEventListener('click', e => { if (profileDropdown && !profileDropdown.contains(e.target) && !userAvatar?.contains(e.target)) profileDropdown.classList.remove('active'); });
logoutBtn?.addEventListener('click', async () => { try { await signOut(auth); profileDropdown.classList.remove('active'); } catch (e) { console.error(e); } });

function initializeUserData() { return { items: {}, lastUpdated: new Date().toISOString() }; }

function loadUserData(userId) {
    if (userId) {
        // Utilisateur connecté → Firebase
        unsubscribe = onSnapshot(doc(db, 'planningRevision', userId), docSnap => {
            userData = docSnap.exists() ? docSnap.data() : initializeUserData();
            if (!docSnap.exists()) saveUserData();
            localStorage.setItem('planningRevision_backup', JSON.stringify(userData));
            renderAll();
        }, e => { console.error(e); userData = initializeUserData(); renderAll(); });
    } else {
        // Pas connecté → localStorage
        const saved = localStorage.getItem('planningRevision_local');
        userData = saved ? JSON.parse(saved) : initializeUserData();
        renderAll();
    }
}

async function saveUserData() {
    if (!userData) return;
    
    // TOUJOURS sauvegarder en localStorage
    userData.lastUpdated = new Date().toISOString();
    localStorage.setItem('planningRevision_local', JSON.stringify(userData));
    
    // Afficher confirmation
    savingIndicator.classList.add('visible');
    
    // Si pas connecté ou mode local, juste confirmer la sauvegarde locale
    if (!currentUser || isLocalMode) {
        savingIndicator.innerHTML = '<i class="fas fa-check"></i><span>Sauvegardé</span>';
        savingIndicator.classList.add('saved');
        setTimeout(() => savingIndicator.classList.remove('visible', 'saved'), 1000);
        return;
    }
    
    // Si connecté, sauvegarder aussi sur Firebase
    savingIndicator.innerHTML = '<i class="fas fa-spinner"></i><span>Sauvegarde...</span>';
    try {
        await setDoc(doc(db, 'planningRevision', currentUser.uid), userData);
        savingIndicator.innerHTML = '<i class="fas fa-check"></i><span>Sauvegardé</span>';
        savingIndicator.classList.add('saved');
        setTimeout(() => savingIndicator.classList.remove('visible', 'saved'), 1500);
    } catch (e) {
        console.error(e);
        savingIndicator.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Erreur cloud</span>';
        setTimeout(() => savingIndicator.classList.remove('visible'), 2000);
    }
}

function debouncedSave() { if (saveTimeout) clearTimeout(saveTimeout); saveTimeout = setTimeout(saveUserData, 1000); }

function getItemKey(sId, fc) { return sId + '-' + fc; }

function getItemData(sId, fc) {
    const key = getItemKey(sId, fc);
    if (!userData.items[key]) userData.items[key] = { tours: [null,null,null,null,null,null,null,null], tourDates: [null,null,null,null,null,null,null,null], resources: { edni: false, hypocampus: false, fichesPerso: false, anki: false }, lastRevision: null };
    const d = userData.items[key];
    if (d.tours && typeof d.tours[0] === 'boolean') d.tours = d.tours.map(t => t ? 3 : null);
    if (!d.tourDates) d.tourDates = [null,null,null,null,null,null,null,null];
    if (!d.resources) d.resources = { edni: false, hypocampus: false, fichesPerso: false, anki: false };
    return d;
}

function calculateStats() {
    let itemsWithOneTour = 0, totalTours = 0, specialtiesComplete = 0;
    SPECIALTIES_DATA.forEach(s => {
        let allSeen = true;
        s.items.forEach(item => {
            const d = getItemData(s.id, item.fc);
            const tc = d.tours.filter(t => t !== null).length;
            if (tc > 0) itemsWithOneTour++; else allSeen = false;
            totalTours += tc;
        });
        if (allSeen && s.items.length > 0) specialtiesComplete++;
    });
    return { itemsWithOneTour, totalTours, specialtiesComplete, maxTours: TOTAL_ITEMS * MAX_TOURS };
}

function getSpecialtyProgress(s) {
    let itemsSeen = 0, totalTours = 0;
    s.items.forEach(item => {
        const d = getItemData(s.id, item.fc);
        const tc = d.tours.filter(t => t !== null).length;
        if (tc > 0) itemsSeen++;
        totalTours += tc;
    });
    return { itemsSeen, totalItems: s.items.length, totalTours, percentage: s.items.length > 0 ? Math.round((itemsSeen / s.items.length) * 100) : 0 };
}

function getDaysSince(dateStr) {
    if (!dateStr) return null;
    return Math.floor(Math.abs(new Date() - new Date(dateStr)) / (1000 * 60 * 60 * 24));
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    return new Date(dateStr).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
}

function renderAll() {
    if (!userData) return;
    renderStats();
    renderDashboardSpecialties();
    renderItemsTable();
    populateFilters();
}

function renderStats() {
    const stats = calculateStats();
    statItemsDone.textContent = stats.itemsWithOneTour;
    statToursDone.textContent = stats.totalTours;
    statSpecialtiesDone.textContent = stats.specialtiesComplete;
    progressItems.style.width = Math.round((stats.itemsWithOneTour / TOTAL_ITEMS) * 100) + '%';
    progressTours.style.width = Math.round((stats.totalTours / stats.maxTours) * 100) + '%';
}

function renderDashboardSpecialties() {
    const container = document.getElementById('dashboard-specialties');
    container.innerHTML = SPECIALTIES_DATA.map(s => {
        const cfg = SPECIALTY_CONFIG[s.id] || { color: '#6b7280', icon: 'fa-book-medical' };
        const prog = getSpecialtyProgress(s);
        return '<div class="specialty-card" onclick="navigateToSpecialty(\'' + s.id + '\')" style="border-left: 4px solid ' + cfg.color + ';">' +
            '<div class="specialty-header"><span class="specialty-name"><span class="specialty-icon" style="background:' + cfg.color + ';"><i class="fas ' + cfg.icon + '"></i></span>' + s.name + '</span><span class="specialty-badge" style="background:' + cfg.color + ';">' + s.items.length + '</span></div>' +
            '<div class="specialty-stats"><span class="specialty-stat ' + (prog.percentage === 100 ? 'completed' : '') + '"><i class="fas fa-check-circle"></i> ' + prog.itemsSeen + '/' + prog.totalItems + ' items</span><span class="specialty-stat"><i class="fas fa-redo"></i> ' + prog.totalTours + ' tours</span></div>' +
            '<div class="specialty-progress"><div class="progress-bar"><div class="progress-fill" style="width:' + prog.percentage + '%;background:linear-gradient(135deg,' + cfg.color + ',' + cfg.color + 'dd);"></div></div></div></div>';
    }).join('');
}

function renderItemsTable() {
    const tbody = document.getElementById('items-table-body');
    const emptyState = document.getElementById('items-empty');
    const searchTerm = (document.getElementById('search-item')?.value || '').toLowerCase();
    const filterSpecialty = document.getElementById('filter-item-specialty')?.value || 'all';
    const filterStatus = document.getElementById('filter-item-status')?.value || 'all';
    
    let allItems = [];
    SPECIALTIES_DATA.forEach(s => {
        s.items.forEach(item => {
            const d = getItemData(s.id, item.fc);
            const lastDate = d.tourDates.filter(x => x).pop() || d.lastRevision;
            allItems.push({ ...item, specialtyId: s.id, specialtyName: s.name, daysSince: getDaysSince(lastDate), toursCompleted: d.tours.filter(t => t !== null).length });
        });
    });
    
    let filtered = allItems.filter(item => {
        const matchSearch = item.name.toLowerCase().includes(searchTerm) || item.num.includes(searchTerm);
        const matchSpec = filterSpecialty === 'all' || item.specialtyId === filterSpecialty;
        let matchStatus = true;
        if (filterStatus === 'not-started') matchStatus = item.toursCompleted === 0;
        else if (filterStatus === 'in-progress') matchStatus = item.toursCompleted > 0 && item.toursCompleted < MAX_TOURS;
        else if (filterStatus === 'completed') matchStatus = item.toursCompleted === MAX_TOURS;
        return matchSearch && matchSpec && matchStatus;
    });
    
    filtered.sort((a, b) => {
        let cmp = 0;
        if (currentSort.field === 'num') cmp = parseInt(a.num) - parseInt(b.num);
        else if (currentSort.field === 'name') cmp = a.name.localeCompare(b.name);
        else if (currentSort.field === 'specialty') cmp = a.specialtyName.localeCompare(b.specialtyName);
        else if (currentSort.field === 'days') cmp = (a.daysSince ?? 9999) - (b.daysSince ?? 9999);
        return currentSort.direction === 'desc' ? -cmp : cmp;
    });
    
    if (filtered.length === 0) { tbody.innerHTML = ''; emptyState.style.display = 'block'; return; }
    emptyState.style.display = 'none';
    
    tbody.innerHTML = filtered.map(item => {
        const d = getItemData(item.specialtyId, item.fc);
        const tourBadges = d.tours.map((c, i) => '<span class="tour-badge ' + (c ? 'c' + c : '') + '" data-specialty="' + item.specialtyId + '" data-fc="' + item.fc + '" data-tour="' + i + '" onclick="openConfidenceModal(this)">T' + (i + 1) + '</span>').join('');
        const tourDates = d.tourDates.map(dt => '<span class="tour-date">' + formatDate(dt) + '</span>').join('');
        const days = item.daysSince;
        let daysBadge = '<span class="days-badge never">Jamais</span>';
        if (days !== null) {
            if (days <= 7) daysBadge = '<span class="days-badge recent">' + days + 'j</span>';
            else if (days <= 30) daysBadge = '<span class="days-badge moderate">' + days + 'j</span>';
            else daysBadge = '<span class="days-badge old">' + days + 'j</span>';
        }
        const res = d.resources;
        const resourcesHtml = '<label class="resource-check ' + (res.edni ? 'checked' : '') + '"><input type="checkbox" ' + (res.edni ? 'checked' : '') + ' onchange="toggleResource(\'' + item.specialtyId + '\',\'' + item.fc + '\',\'edni\',this.checked)"> QCM EDNi</label>' +
            '<label class="resource-check ' + (res.hypocampus ? 'checked' : '') + '"><input type="checkbox" ' + (res.hypocampus ? 'checked' : '') + ' onchange="toggleResource(\'' + item.specialtyId + '\',\'' + item.fc + '\',\'hypocampus\',this.checked)"> Hypocampus</label>' +
            '<label class="resource-check ' + (res.fichesPerso ? 'checked' : '') + '"><input type="checkbox" ' + (res.fichesPerso ? 'checked' : '') + ' onchange="toggleResource(\'' + item.specialtyId + '\',\'' + item.fc + '\',\'fichesPerso\',this.checked)"> Fiches Perso</label>' +
            '<label class="resource-check ' + (res.anki ? 'checked' : '') + '"><input type="checkbox" ' + (res.anki ? 'checked' : '') + ' onchange="toggleResource(\'' + item.specialtyId + '\',\'' + item.fc + '\',\'anki\',this.checked)"> Anki</label>';
        
        return '<tr><td class="item-num">' + item.num + '</td><td class="item-name">' + item.name + '</td><td class="item-specialty">' + item.specialtyName + '</td>' +
            '<td class="tour-cell"><div class="tour-badges">' + tourBadges + '</div><div class="tour-dates">' + tourDates + '</div></td>' +
            '<td class="resources-cell">' + resourcesHtml + '</td><td class="days-cell">' + daysBadge + '</td></tr>';
    }).join('');
}

function populateFilters() {
    const select = document.getElementById('filter-item-specialty');
    if (!select) return;
    const first = select.options[0];
    select.innerHTML = '';
    select.appendChild(first);
    SPECIALTIES_DATA.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.name;
        select.appendChild(opt);
    });
}

window.openConfidenceModal = function(el) {
    pendingTour = { specialtyId: el.dataset.specialty, fc: el.dataset.fc, tour: parseInt(el.dataset.tour) };
    confidenceModal.classList.add('active');
};

document.querySelectorAll('.confidence-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        if (!pendingTour) return;
        const conf = parseInt(this.dataset.confidence);
        const d = getItemData(pendingTour.specialtyId, pendingTour.fc);
        if (conf === 0) {
            d.tours[pendingTour.tour] = null;
            d.tourDates[pendingTour.tour] = null;
        } else {
            d.tours[pendingTour.tour] = conf;
            d.tourDates[pendingTour.tour] = new Date().toISOString();
            d.lastRevision = new Date().toISOString();
        }
        confidenceModal.classList.remove('active');
        pendingTour = null;
        debouncedSave();
        renderAll();
    });
});

document.getElementById('confidence-close')?.addEventListener('click', () => { confidenceModal.classList.remove('active'); pendingTour = null; });
confidenceModal?.addEventListener('click', e => { if (e.target === confidenceModal) { confidenceModal.classList.remove('active'); pendingTour = null; } });

window.toggleResource = function(sId, fc, resource, checked) {
    const d = getItemData(sId, fc);
    d.resources[resource] = checked;
    debouncedSave();
    renderItemsTable();
};

window.navigateToSpecialty = function(sId) {
    document.querySelectorAll('.app-nav-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.app-page').forEach(p => p.classList.remove('active'));
    document.querySelector('[data-page="items"]').classList.add('active');
    document.getElementById('page-items').classList.add('active');
    const select = document.getElementById('filter-item-specialty');
    if (select) { select.value = sId; renderItemsTable(); }
};

document.querySelectorAll('.items-table th[data-sort]').forEach(th => {
    th.addEventListener('click', function() {
        const field = this.dataset.sort;
        if (currentSort.field === field) currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        else { currentSort.field = field; currentSort.direction = 'asc'; }
        document.querySelectorAll('.items-table th').forEach(h => h.classList.remove('sorted'));
        this.classList.add('sorted');
        renderItemsTable();
    });
});

document.getElementById('search-item')?.addEventListener('input', renderItemsTable);
document.getElementById('filter-item-specialty')?.addEventListener('change', renderItemsTable);
document.getElementById('filter-item-status')?.addEventListener('change', renderItemsTable);
document.getElementById('btn-reset-filters')?.addEventListener('click', () => {
    document.getElementById('search-item').value = '';
    document.getElementById('filter-item-specialty').value = 'all';
    document.getElementById('filter-item-status').value = 'all';
    renderItemsTable();
});
</script>
</body>
</html>

