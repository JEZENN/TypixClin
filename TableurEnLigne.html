<!DOCTYPE html>
<html lang="fr">
<head>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KGHT97MD');</script>
<!-- End Google Tag Manager -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-C2D5ENP3F1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-C2D5ENP3F1');
</script>

<link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
<link rel="shortcut icon" href="/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
<meta name="apple-mobile-web-app-title" content="TypixClin" />
<link rel="manifest" href="/site.webmanifest" />

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Planning de Révision EDN - Organisez et suivez vos révisions pour l'examen national">
<title>Tableur Révision EDN - TypixClin</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
:root {
    --primary: #3b82f6;
    --primary-dark: #1d4ed8;
    --primary-light: #60a5fa;
    --primary-gradient: linear-gradient(135deg, #3b82f6, #2563eb);
    --secondary: #475569;
    --accent: #8b5cf6;
    --background: #f5f8ff;
    --white: #ffffff;
    --black: #111827;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-400: #9ca3af;
    --gray-500: #6b7280;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-800: #1f2937;
    --gray-900: #111827;
    --success: #10b981;
    --success-light: #d1fae5;
    --warning: #f59e0b;
    --warning-light: #fef3c7;
    --danger: #ef4444;
    --danger-light: #fee2e2;
    --confidence-1: #991b1b;
    --confidence-2: #dc2626;
    --confidence-3: #f59e0b;
    --confidence-4: #22c55e;
    --confidence-5: #15803d;
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    --shadow-blue: 0 10px 25px -5px rgba(59, 130, 246, 0.5);
    --header-height: 70px;
    --container-max-width: 1400px;
    --border-radius-sm: 0.375rem;
    --border-radius-md: 0.5rem;
    --border-radius-lg: 1rem;
    --border-radius-xl: 1.5rem;
    --border-radius-full: 9999px;
    --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-normal: 300ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-slow: 500ms cubic-bezier(0.4, 0, 0.2, 1);
    --font-display: 'Outfit', sans-serif;
    --font-body: 'Space Grotesk', sans-serif;
    --z-elevated: 10;
    --z-sticky: 100;
    --z-dropdown: 200;
    --z-modal: 300;
    --z-max: 9999;
}

[data-theme="dark"] {
    --primary: #60a5fa;
    --primary-dark: #3b82f6;
    --primary-light: #93c5fd;
    --primary-gradient: linear-gradient(135deg, #60a5fa, #3b82f6);
    --background: #0f172a;
    --white: #1e293b;
    --black: #f9fafb;
    --gray-900: #f9fafb;
    --gray-800: #f3f4f6;
    --gray-700: #e5e7eb;
    --gray-600: #d1d5db;
    --gray-500: #9ca3af;
    --gray-400: #6b7280;
    --gray-300: #4b5563;
    --gray-200: #374151;
    --gray-100: #1f2937;
    --gray-50: #111827;
    --success-light: rgba(16, 185, 129, 0.2);
    --warning-light: rgba(245, 158, 11, 0.2);
    --danger-light: rgba(239, 68, 68, 0.2);
}

*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
html { font-size: 16px; scroll-behavior: smooth; }
body { font-family: var(--font-body); background-color: var(--background); color: var(--gray-800); line-height: 1.6; overflow-x: hidden; min-height: 100vh; transition: background-color var(--transition-normal), color var(--transition-normal); }
h1, h2, h3, h4, h5, h6 { font-family: var(--font-display); font-weight: 700; line-height: 1.2; color: var(--gray-900); }
a { text-decoration: none; color: var(--primary); transition: color var(--transition-normal); }
button { cursor: pointer; font-family: var(--font-body); border: none; background: none; transition: all var(--transition-normal); }
.container { width: 100%; max-width: var(--container-max-width); margin: 0 auto; padding: 0 1.5rem; }

@media (max-width: 768px) {
    .container {
        padding: 0 0.75rem;
    }
}

@media (max-width: 480px) {
    .container {
        padding: 0 0.5rem;
    }
    
    .section-card {
        border-radius: var(--border-radius-md);
    }
    
    .section-body {
        padding: 0.75rem;
    }
}




@keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
@keyframes gradientFlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

.loader-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--background); display: flex; justify-content: center; align-items: center; z-index: var(--z-max); transition: opacity var(--transition-slow), visibility var(--transition-slow); }
.loader { display: flex; flex-direction: column; align-items: center; gap: 2rem; }
.loader-logo { width: 120px; height: 120px; position: relative; }
.loader-logo::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; border: 4px solid var(--gray-200); border-top-color: var(--primary); animation: spin 1s linear infinite; }
.loader-text { font-family: var(--font-display); font-size: 2rem; font-weight: 800; color: var(--primary); letter-spacing: -0.05em; }

/* ===== HEADER ===== */
.header {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: var(--header-height);
    z-index: var(--z-sticky);
    transition: transform var(--transition-normal), background-color var(--transition-normal), box-shadow var(--transition-normal);
    background-color: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

[data-theme="dark"] .header {
    background-color: rgba(30, 41, 59, 0.9);
}

.header.scrolled {
    box-shadow: var(--shadow-md);
}

.header-container {
    height: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.logo {
    font-family: var(--font-display);
    font-size: 1.8rem;
    font-weight: 800;
    color: var(--primary);
    letter-spacing: -0.05em;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.logo-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    height: 2.5rem;
    background: var(--primary-gradient);
    border-radius: var(--border-radius-md);
    color: white;
    font-size: 1.5rem;
}

.logo:hover .logo-icon {
    animation: pulse 1s infinite;
}

.nav {
    display: flex;
    align-items: center;
}

.nav-items {
    display: flex;
    list-style: none;
    gap: 2rem;
}

.nav-link {
    font-weight: 500;
    color: var(--gray-700);
    transition: color var(--transition-normal), transform var(--transition-normal);
    position: relative;
}

.nav-link::after {
    content: '';
    position: absolute;
    bottom: -4px;
    left: 0;
    width: 0;
    height: 2px;
    background: var(--primary-gradient);
    transition: width var(--transition-normal);
}

.nav-link:hover {
    color: var(--primary);
    transform: translateY(-2px);
}

.nav-link:hover::after {
    width: 100%;
}

.theme-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: var(--gray-100);
    border-radius: var(--border-radius-full);
    color: var(--gray-600);
    font-size: 1.25rem;
    cursor: pointer;
    margin-left: 2rem;
    transition: all var(--transition-normal);
}

[data-theme="dark"] .theme-toggle {
    background: var(--gray-800);
    color: var(--gray-300);
}

.theme-toggle:hover {
    background: var(--primary-light);
    color: white;
    transform: rotate(15deg);
}

.mobile-menu-btn {
    display: none;
    font-size: 1.5rem;
    color: var(--gray-700);
    transition: color var(--transition-normal);
}

.mobile-menu-btn:hover {
    color: var(--primary);
}

@media (max-width: 992px) {
    .nav-items {
        display: none;
    }
    
    .mobile-menu-btn {
        display: block;
    }
    
    .theme-toggle {
        margin-left: 1.5rem;
        margin-right: 0.5rem;
    }
}

/* Mobile menu */
.mobile-menu {
    position: fixed;
    top: var(--header-height);
    left: 0;
    width: 100%;
    background-color: var(--white);
    padding: 2rem;
    z-index: calc(var(--z-sticky) - 1);
    box-shadow: var(--shadow-lg);
    transform: translateY(-100%);
    opacity: 0;
    visibility: hidden;
    transition: transform var(--transition-normal), opacity var(--transition-normal), visibility var(--transition-normal);
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.mobile-menu.active {
    transform: translateY(0);
    opacity: 1;
    visibility: visible;
}

.mobile-menu .nav-link {
    font-size: 1.25rem;
    display: block;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--gray-200);
}

.user-auth { display: flex; align-items: center; margin-left: 1rem; position: relative; }
.auth-btn { display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background: var(--gray-100); border-radius: var(--border-radius-full); color: var(--gray-600); font-size: 1.1rem; cursor: pointer; border: none; }
[data-theme="dark"] .auth-btn { background: var(--gray-800); color: var(--gray-300); }
.auth-btn:hover { background: var(--primary-light); color: white; }
.user-avatar { width: 40px; height: 40px; border-radius: var(--border-radius-full); background: var(--primary-gradient); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1rem; cursor: pointer; border: 2px solid transparent; text-transform: uppercase; }
.user-avatar:hover { border-color: var(--primary-light); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
.user-avatar img { width: 100%; height: 100%; border-radius: var(--border-radius-full); object-fit: cover; }
.profile-dropdown { position: absolute; top: calc(100% + 10px); right: 0; background: var(--white); border-radius: var(--border-radius-lg); box-shadow: var(--shadow-xl); border: 1px solid var(--gray-200); min-width: 220px; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all var(--transition-normal); z-index: var(--z-dropdown); overflow: hidden; }
.profile-dropdown.active { opacity: 1; visibility: visible; transform: translateY(0); }
.profile-header { padding: 1rem; border-bottom: 1px solid var(--gray-200); background: var(--gray-50); }
.profile-name { font-weight: 600; color: var(--gray-900); font-size: 0.95rem; margin-bottom: 0.2rem; }
.profile-email { font-size: 0.8rem; color: var(--gray-500); word-break: break-all; }
.profile-menu { padding: 0.5rem 0; }
.profile-menu-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; color: var(--gray-700); font-size: 0.9rem; cursor: pointer; border: none; background: none; width: 100%; text-align: left; }
.profile-menu-item:hover { background: var(--gray-100); color: var(--primary); }
.profile-menu-item.logout { color: #dc2626; }
.profile-menu-item.logout:hover { background: #fef2f2; }
.user-auth .auth-btn { display: flex; }
.user-auth .user-avatar { display: none; }
.user-auth .profile-dropdown { display: none; }
.user-auth.logged-in .auth-btn { display: none; }
.user-auth.logged-in .user-avatar { display: flex; }
.user-auth.logged-in .profile-dropdown { display: block; }

@media (max-width: 992px) {
    .nav-items { display: none; }
    .mobile-menu-btn { display: block; }
    .theme-toggle { margin-left: 1.5rem; }
}

.mobile-menu { position: fixed; top: var(--header-height); left: 0; width: 100%; background-color: var(--white); padding: 2rem; z-index: calc(var(--z-sticky) - 1); box-shadow: var(--shadow-lg); transform: translateY(-100%); opacity: 0; visibility: hidden; transition: all var(--transition-normal); display: flex; flex-direction: column; gap: 1.5rem; }
.mobile-menu.active { transform: translateY(0); opacity: 1; visibility: visible; }

.page-header { padding-top: calc(var(--header-height) + 2rem); padding-bottom: 1.5rem; background: linear-gradient(135deg, rgba(239, 246, 255, 0.8) 0%, rgba(219, 234, 254, 0.8) 100%); text-align: center; }
[data-theme="dark"] .page-header { background: linear-gradient(135deg, rgba(17, 24, 39, 0.8) 0%, rgba(31, 41, 55, 0.8) 100%); }
.page-title { font-size: 2.2rem; font-weight: 800; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 0.5rem; animation: fadeInUp var(--transition-slow) forwards; }
.page-subtitle { font-size: 1rem; color: var(--gray-600); max-width: 600px; margin: 0 auto 1rem; }
.back-home-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.6rem 1.2rem; background: var(--primary-gradient); color: white; font-weight: 600; font-size: 0.9rem; border-radius: var(--border-radius-full); box-shadow: var(--shadow-md); transition: all var(--transition-normal); }
.back-home-btn:hover { transform: translateY(-3px); box-shadow: var(--shadow-blue); color: white; }

.login-required { padding: 4rem 1.5rem; text-align: center; }
.login-required-card { background: var(--white); border-radius: var(--border-radius-xl); box-shadow: var(--shadow-xl); padding: 3rem 2rem; max-width: 500px; margin: 0 auto; border: 1px solid var(--gray-200); }
.login-required-icon { width: 80px; height: 80px; background: linear-gradient(135deg, var(--gray-100), var(--gray-200)); border-radius: var(--border-radius-full); display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; font-size: 2.5rem; color: var(--gray-400); }
.login-required-title { font-size: 1.5rem; font-weight: 700; color: var(--gray-900); margin-bottom: 0.75rem; }
.login-required-text { color: var(--gray-600); margin-bottom: 2rem; line-height: 1.7; }
.login-required-btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 1rem 2rem; background: var(--primary-gradient); color: white; font-weight: 600; font-size: 1rem; border-radius: var(--border-radius-full); box-shadow: var(--shadow-blue); transition: all var(--transition-normal); }
.login-required-btn:hover { transform: translateY(-3px); color: white; }

.main-content { padding: 1.5rem; display: none; min-height: calc(100vh - var(--header-height) - 200px); }
.main-content.active { display: block; }

.app-nav { background: var(--white); border-radius: var(--border-radius-xl); box-shadow: var(--shadow-md); padding: 0.5rem; margin-bottom: 1.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap; border: 1px solid var(--gray-200); }
.app-nav-btn { flex: 1; min-width: 140px; padding: 0.875rem 1.25rem; background: transparent; border: none; border-radius: var(--border-radius-lg); font-weight: 600; font-size: 0.95rem; color: var(--gray-600); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
.app-nav-btn:hover { background: var(--gray-100); color: var(--primary); }
.app-nav-btn.active { background: var(--primary-gradient); color: white; box-shadow: var(--shadow-md); }

.app-page { display: none; animation: fadeInUp 0.3s ease; }
.app-page.active { display: block; }

.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.25rem; margin-bottom: 2rem; }
.stat-card { background: var(--white); border-radius: var(--border-radius-lg); padding: 1.5rem; box-shadow: var(--shadow-md); border: 1px solid var(--gray-200); position: relative; overflow: hidden; transition: all var(--transition-normal); }
.stat-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; }
.stat-card.blue::before { background: var(--primary); }
.stat-card.green::before { background: var(--success); }
.stat-card.orange::before { background: var(--warning); }
.stat-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }
.stat-icon { width: 50px; height: 50px; border-radius: var(--border-radius-md); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-bottom: 1rem; }
.stat-icon.blue { background: rgba(59, 130, 246, 0.1); color: var(--primary); }
.stat-icon.green { background: rgba(16, 185, 129, 0.1); color: var(--success); }
.stat-icon.orange { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
.stat-value { font-size: 2rem; font-weight: 800; color: var(--gray-900); margin-bottom: 0.25rem; }
.stat-label { font-size: 0.9rem; color: var(--gray-500); }
.stat-sublabel { font-size: 0.75rem; color: var(--gray-400); margin-top: 0.25rem; }
.stat-progress { margin-top: 1rem; }
.progress-bar { height: 6px; background: var(--gray-200); border-radius: var(--border-radius-full); overflow: hidden; }
.progress-fill { height: 100%; border-radius: var(--border-radius-full); transition: width 0.5s ease; }
.progress-fill.blue { background: var(--primary-gradient); }
.progress-fill.green { background: linear-gradient(135deg, #10b981, #059669); }

.progress-fill.purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }

/* ===== STYLES STATISTIQUES AMÉLIORÉES ===== */
.stat-card.purple::before { background: var(--accent); }
.stat-icon.purple { background: rgba(139, 92, 246, 0.1); color: var(--accent); }

.stats-section-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--gray-700);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--gray-200);
}
.stats-section-title i { font-size: 1rem; }
.stats-section-title.general i { color: var(--primary); }
.stats-section-title.daily i { color: #f59e0b; }

.daily-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.daily-stat-card {
    background: var(--white);
    border-radius: var(--border-radius-lg);
    padding: 1.25rem;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--gray-200);
    position: relative;
    overflow: hidden;
    transition: all var(--transition-normal);
}
.daily-stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
}
.daily-stat-card.items-today::before { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
.daily-stat-card.delay-caught::before { background: linear-gradient(90deg, #10b981, #34d399); }
.daily-stat-card.time-today::before { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
.daily-stat-card.feeling-today::before { background: linear-gradient(90deg, #ec4899, #f472b6); }
.daily-stat-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }

.daily-stat-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
}

.daily-stat-icon {
    width: 40px;
    height: 40px;
    border-radius: var(--border-radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
}
.daily-stat-card.items-today .daily-stat-icon { background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(96, 165, 250, 0.15)); color: #3b82f6; }
.daily-stat-card.delay-caught .daily-stat-icon { background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(52, 211, 153, 0.15)); color: #10b981; }
.daily-stat-card.time-today .daily-stat-icon { background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(251, 191, 36, 0.15)); color: #f59e0b; }
.daily-stat-card.feeling-today .daily-stat-icon { background: linear-gradient(135deg, rgba(236, 72, 153, 0.15), rgba(244, 114, 182, 0.15)); color: #ec4899; }

.daily-stat-label { font-size: 0.8rem; color: var(--gray-500); font-weight: 500; }
.daily-stat-value {
    font-size: 1.75rem;
    font-weight: 800;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    line-height: 1.2;
}
.daily-stat-card.items-today .daily-stat-value { background: linear-gradient(135deg, #3b82f6, #60a5fa); -webkit-background-clip: text; background-clip: text; }
.daily-stat-card.delay-caught .daily-stat-value { background: linear-gradient(135deg, #10b981, #34d399); -webkit-background-clip: text; background-clip: text; }
.daily-stat-card.time-today .daily-stat-value { background: linear-gradient(135deg, #f59e0b, #fbbf24); -webkit-background-clip: text; background-clip: text; }
.daily-stat-card.feeling-today .daily-stat-value { background: linear-gradient(135deg, #ec4899, #f472b6); -webkit-background-clip: text; background-clip: text; }
.daily-stat-unit { font-size: 0.85rem; color: var(--gray-400); font-weight: 500; margin-left: 0.25rem; }

.feeling-indicator { display: flex; gap: 4px; margin-top: 0.5rem; }
.feeling-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--gray-300); transition: all var(--transition-fast); }
.feeling-dot.active { transform: scale(1.2); }
.feeling-dot.active.c1 { background: var(--confidence-1); }
.feeling-dot.active.c2 { background: var(--confidence-2); }
.feeling-dot.active.c3 { background: var(--confidence-3); }
.feeling-dot.active.c4 { background: var(--confidence-4); }
.feeling-dot.active.c5 { background: var(--confidence-5); }

@keyframes countUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

@media (max-width: 768px) {
    .daily-stats-grid { grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
    .daily-stat-card { padding: 1rem; }
    .daily-stat-value { font-size: 1.4rem; }
    .daily-stat-icon { width: 35px; height: 35px; font-size: 1rem; }
}
@media (max-width: 480px) {
    .daily-stats-grid { grid-template-columns: 1fr; }
}




.section-card { background: var(--white); border-radius: var(--border-radius-xl); box-shadow: var(--shadow-md); border: 1px solid var(--gray-200); overflow: hidden; margin-bottom: 1.5rem; }
.section-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; background: var(--gray-50); }
.section-title { font-size: 1.25rem; font-weight: 700; color: var(--gray-900); display: flex; align-items: center; gap: 0.75rem; }
.section-title i { color: var(--primary); }
.section-body { padding: 1.5rem; }

.specialties-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.25rem; }
.specialty-card { background: var(--white); border-radius: var(--border-radius-lg); border: 1px solid var(--gray-200); padding: 1.25rem; cursor: pointer; position: relative; overflow: hidden; transition: all var(--transition-normal); }
.specialty-card:hover { box-shadow: var(--shadow-lg); transform: translateY(-2px); }
.specialty-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
.specialty-name { font-weight: 700; font-size: 1rem; color: var(--gray-900); flex: 1; display: flex; align-items: center; gap: 0.5rem; }
.specialty-icon { width: 32px; height: 32px; border-radius: var(--border-radius-sm); display: flex; align-items: center; justify-content: center; font-size: 0.9rem; color: white; flex-shrink: 0; }
.specialty-badge { color: white; font-size: 0.75rem; font-weight: 700; padding: 0.25rem 0.6rem; border-radius: var(--border-radius-full); }
.specialty-stats { display: flex; gap: 1rem; flex-wrap: wrap; }
.specialty-stat { display: flex; align-items: center; gap: 0.4rem; font-size: 0.85rem; color: var(--gray-600); }
.specialty-stat.completed { color: var(--success); }
.specialty-progress { margin-top: 1rem; }

.items-container { overflow-x: auto; }
.items-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
.items-table th { background: var(--gray-50); padding: 0.75rem; text-align: left; font-weight: 600; color: var(--gray-700); border-bottom: 2px solid var(--gray-200); white-space: nowrap; position: sticky; top: 0; cursor: pointer; user-select: none; }
.items-table th:hover { background: var(--gray-100); }
.items-table th .sort-icon { margin-left: 0.5rem; opacity: 0.5; font-size: 0.7rem; }
.items-table th.sorted .sort-icon { opacity: 1; color: var(--primary); }
.items-table td { padding: 0.75rem; border-bottom: 1px solid var(--gray-200); vertical-align: top; }
.items-table tr:hover { background: var(--gray-50); }
.items-table .item-num { font-weight: 700; color: var(--primary); min-width: 50px; }
.items-table .item-name { max-width: 200px; font-size: 0.8rem; }
.items-table .item-specialty { font-size: 0.75rem; color: var(--gray-500); white-space: nowrap; }

.tour-cell { min-width: 280px; }
.tour-badges { display: flex; gap: 2px; flex-wrap: nowrap; }
.tour-badge { width: 30px; height: 28px; border-radius: var(--border-radius-sm); display: flex; align-items: center; justify-content: center; font-size: 0.65rem; font-weight: 700; cursor: pointer; border: 2px solid var(--gray-300); background: var(--white); color: var(--gray-400); transition: all var(--transition-fast); }
.tour-badge:hover { border-color: var(--primary); color: var(--primary); transform: scale(1.05); }
.tour-badge.c1 { background: var(--confidence-1); border-color: var(--confidence-1); color: white; }
.tour-badge.c2 { background: var(--confidence-2); border-color: var(--confidence-2); color: white; }
.tour-badge.c3 { background: var(--confidence-3); border-color: var(--confidence-3); color: white; }
.tour-badge.c4 { background: var(--confidence-4); border-color: var(--confidence-4); color: white; }
.tour-badge.c5 { background: var(--confidence-5); border-color: var(--confidence-5); color: white; }
.tour-dates { display: flex; gap: 2px; margin-top: 2px; }
.tour-date { width: 30px; font-size: 0.6rem; color: var(--gray-500); text-align: center; overflow: hidden; font-family: var(--font-body); }

.resources-cell { min-width: 130px; }
.resource-check { display: flex; align-items: center; gap: 0.3rem; font-size: 0.7rem; color: var(--gray-600); cursor: pointer; margin-bottom: 2px; transition: all var(--transition-normal); }
.resource-check input { width: 12px; height: 12px; cursor: pointer; accent-color: var(--primary); }
.resource-check.checked { color: var(--success); font-weight: 600; }

.days-cell { min-width: 70px; text-align: center; }
.days-badge { display: inline-block; padding: 0.2rem 0.5rem; border-radius: var(--border-radius-full); font-size: 0.7rem; font-weight: 600; }
.days-badge.recent { background: var(--success-light); color: var(--success); }
.days-badge.moderate { background: var(--warning-light); color: var(--warning); }
.days-badge.old { background: var(--danger-light); color: var(--danger); }
.days-badge.never { background: var(--gray-200); color: var(--gray-500); }

.modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: var(--z-modal); backdrop-filter: blur(4px); }
.modal.active { display: flex; }
.modal-content { background: #ffffff; border-radius: var(--border-radius-xl); padding: 2rem; max-width: 400px; width: 90%; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); position: relative; }
.modal-close { position: absolute; top: 1rem; right: 1rem; width: 36px; height: 36px; border-radius: 50%; background: var(--gray-100); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: var(--gray-500); transition: all var(--transition-fast); }
.modal-close:hover { background: var(--danger-light); color: var(--danger); transform: rotate(90deg); }
.modal-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem; text-align: center; color: var(--gray-900); }

.modal-section { margin-bottom: 1.25rem; }
.modal-label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--gray-500); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px; }
.modal-input { width: 100%; padding: 0.75rem 1rem; border: 2px solid var(--gray-200); border-radius: var(--border-radius-md); font-size: 0.95rem; text-align: center; background: var(--gray-50); transition: all var(--transition-fast); box-sizing: border-box; max-width: 100%; }
.modal-input:focus { outline: none; border-color: var(--primary); background: #ffffff; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1); }

@media (max-width: 480px) {
    .modal-content {
        padding: 1.5rem 1rem;
        width: 92%;
        max-width: 92%;
    }
    
    .modal-input {
        width: 100%;
        max-width: 100%;
        padding: 0.6rem 0.5rem;
        font-size: 0.9rem;
    }
}


.confidence-buttons { display: flex; gap: 0.5rem; justify-content: center; }
.confidence-btn { width: 50px; height: 50px; border-radius: var(--border-radius-md); border: 3px solid transparent; font-size: 1.2rem; font-weight: 700; color: white; cursor: pointer; transition: all var(--transition-fast); opacity: 0.7; }
.confidence-btn:hover { transform: scale(1.1); opacity: 1; }
.confidence-btn.selected { opacity: 1; transform: scale(1.15); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
.confidence-btn.c1 { background: var(--confidence-1); }
.confidence-btn.c2 { background: var(--confidence-2); }
.confidence-btn.c3 { background: var(--confidence-3); }
.confidence-btn.c4 { background: var(--confidence-4); }
.confidence-btn.c5 { background: var(--confidence-5); }

.duration-input-wrapper { display: flex; align-items: center; justify-content: center; gap: 0.5rem; background: var(--gray-50); padding: 0.5rem 1rem; border-radius: var(--border-radius-md); border: 2px solid var(--gray-200); }
@media (max-width: 480px) {
    .modal-content {
        padding: 1.5rem 1rem;
        width: 95%;
    }
    
    .duration-input-wrapper {
        width: 100%;
        padding: 0.5rem 0.75rem;
        box-sizing: border-box;
    }
    
    .duration-input {
        width: 45px;
        padding: 0.4rem;
        font-size: 1rem;
    }
    
    .confidence-btn {
        width: 42px;
        height: 42px;
        font-size: 1rem;
    }
    
    .support-buttons {
        gap: 0.4rem;
    }
    
    .support-btn {
        padding: 0.4rem 0.6rem;
        font-size: 0.75rem;
    }
}

.duration-input { width: 50px; padding: 0.5rem; border: none; border-radius: var(--border-radius-sm); font-size: 1.1rem; text-align: center; background: #ffffff; font-weight: 600; }
.duration-input:focus { outline: none; box-shadow: 0 0 0 2px var(--primary); }
.duration-separator { font-size: 0.9rem; color: var(--gray-500); font-weight: 500; }

.support-buttons { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; }
.support-btn { padding: 0.5rem 0.75rem; font-size: 0.8rem; border-radius: var(--border-radius-md); border: 2px solid var(--gray-200); background: #ffffff; color: var(--gray-600); cursor: pointer; transition: all var(--transition-fast); display: flex; align-items: center; gap: 0.4rem; }
.support-btn i { font-size: 0.85rem; }
.support-btn:hover { border-color: var(--gray-300); background: var(--gray-50); }
.support-btn[data-support="qcm"] { --support-color: #3b82f6; }
.support-btn[data-support="college"] { --support-color: #8b5cf6; }
.support-btn[data-support="anki"] { --support-color: #ef4444; }
.support-btn[data-support="perso"] { --support-color: #f59e0b; }
.support-btn[data-support="codex"] { --support-color: #10b981; }
.support-btn[data-support="conf"] { --support-color: #ec4899; }
.support-btn:hover { border-color: var(--support-color); color: var(--support-color); }
.support-btn.selected { background: var(--support-color); border-color: var(--support-color); color: white; }

.modal-actions { display: flex; gap: 0.75rem; margin-top: 1.75rem; }
.btn-validate { flex: 1; padding: 0.85rem; background: var(--primary-gradient); color: white; border-radius: var(--border-radius-md); font-weight: 600; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; box-shadow: var(--shadow-md); }
.btn-validate:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
.btn-reset { padding: 0.85rem 1.25rem; background: var(--gray-100); color: var(--gray-600); border-radius: var(--border-radius-md); font-weight: 500; display: flex; align-items: center; gap: 0.5rem; }
.btn-reset:hover { background: var(--danger-light); color: var(--danger); }

.tour-info { display: flex; flex-direction: column; align-items: center; gap: 2px; margin-top: 4px; }
.tour-duration { font-size: 0.6rem; color: var(--gray-500); font-family: var(--font-body); }
.tour-support { font-size: 0.6rem; padding: 1px 4px; border-radius: 3px; color: white; font-weight: 500; }
.tour-support.qcm { background: #3b82f6; }
.tour-support.college { background: #8b5cf6; }
.tour-support.anki { background: #ef4444; }
.tour-support.perso { background: #f59e0b; }
.tour-support.codex { background: #10b981; }
.tour-support.conf { background: #ec4899; }


.support-legend { display: flex; gap: 0.5rem; align-items: center; margin-left: auto; margin-right: 1rem; flex-wrap: wrap; }
.legend-item { font-size: 0.7rem; padding: 3px 8px; border-radius: 4px; color: white; display: flex; align-items: center; gap: 4px; }
.legend-item strong { font-weight: 700; }
.legend-item.qcm { background: #3b82f6; }
.legend-item.college { background: #8b5cf6; }
.legend-item.anki { background: #ef4444; }
.legend-item.perso { background: #f59e0b; }
.legend-item.codex { background: #10b981; }
.legend-item.conf { background: #ec4899; }


.filter-bar { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.5rem; align-items: center; }
.search-box { flex: 1; min-width: 200px; position: relative; }
.search-box input { width: 100%; padding: 0.75rem 1rem 0.75rem 2.75rem; border: 1px solid var(--gray-300); border-radius: var(--border-radius-lg); font-size: 0.95rem; background: var(--white); }
.search-box input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
.search-box i { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--gray-400); }
.filter-select { padding: 0.75rem 1rem; border: 1px solid var(--gray-300); border-radius: var(--border-radius-lg); font-size: 0.95rem; background: var(--white); min-width: 160px; cursor: pointer; }
.filter-select:focus { outline: none; border-color: var(--primary); }

.saving-indicator { position: fixed; bottom: 2rem; right: 2rem; background: var(--gray-900); color: white; padding: 0.75rem 1.25rem; border-radius: var(--border-radius-full); font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem; opacity: 0; transform: translateY(20px); transition: all var(--transition-normal); z-index: var(--z-elevated); }
.saving-indicator.visible { opacity: 1; transform: translateY(0); }
.saving-indicator i { animation: spin 1s linear infinite; }
.saving-indicator.saved i { animation: none; }

.quick-actions { display: flex; gap: 0.75rem; flex-wrap: wrap; }
.quick-action-btn { padding: 0.5rem 1rem; background: var(--gray-100); border: 1px solid var(--gray-200); border-radius: var(--border-radius-md); font-size: 0.85rem; font-weight: 500; color: var(--gray-700); cursor: pointer; display: flex; align-items: center; gap: 0.4rem; }
.quick-action-btn:hover { background: var(--primary-light); color: white; border-color: var(--primary-light); }

.empty-state { text-align: center; padding: 3rem 2rem; color: var(--gray-500); }
.empty-state i { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }

.back-to-top { position: fixed; bottom: 2rem; left: 2rem; width: 50px; height: 50px; border-radius: var(--border-radius-full); background: var(--primary-gradient); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; cursor: pointer; opacity: 0; visibility: hidden; transform: translateY(20px); transition: all var(--transition-normal); box-shadow: var(--shadow-md); z-index: var(--z-elevated); }
.back-to-top.visible { opacity: 1; visibility: visible; transform: translateY(0); }

.tour-badge-wrapper { display: flex; flex-direction: column; align-items: center; }

/* ===== FOOTER ===== */
.footer {
    background-color: var(--gray-900);
    color: var(--gray-400);
    padding: 3rem 0 1.5rem;
}

.footer-container {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr;
    gap: 3rem;
}

.footer-brand {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.footer-logo {
    font-family: var(--font-display);
    font-size: 1.75rem;
    font-weight: 800;
    color: white;
    letter-spacing: -0.05em;
}

.footer-description {
    color: var(--gray-500);
    font-size: 0.9rem;
    max-width: 350px;
}

.footer-social {
    display: flex;
    gap: 0.75rem;
}

.social-link {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: var(--border-radius-full);
    background: var(--gray-800);
    color: var(--gray-400);
    font-size: 1.1rem;
    transition: all var(--transition-normal);
}

.social-link:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-3px);
}

.footer-nav {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.footer-nav-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: white;
    margin-bottom: 0.5rem;
}

.footer-nav-links {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.footer-nav-link {
    color: var(--gray-500);
    font-size: 0.9rem;
    transition: all var(--transition-normal);
}

.footer-nav-link:hover {
    color: var(--primary-light);
    transform: translateX(5px);
}

.footer-bottom {
    margin-top: 2.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--gray-800);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.footer-copyright {
    color: var(--gray-500);
    font-size: 0.85rem;
}


@media (max-width: 992px) {
    .footer-container {
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }
}

@media (max-width: 768px) {
    .footer-container {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
    
    .footer-bottom {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .footer-legal {
        justify-content: center;
    }
}

/* Footer dark mode */
[data-theme="dark"] .footer {
    background-color: #0d1320;
}

[data-theme="dark"] .footer-logo {
    color: white;
}

[data-theme="dark"] .social-link {
    background: #1e293b;
    color: var(--gray-300);
}

[data-theme="dark"] .social-link:hover {
    background: var(--primary);
    color: white;
}

[data-theme="dark"] .footer-bottom {
    border-top: 1px solid #1e293b;
}

/* Back to top */
.back-to-top {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 45px;
    height: 45px;
    border-radius: var(--border-radius-full);
    background: var(--primary-gradient);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    cursor: pointer;
    opacity: 0;
    visibility: hidden;
    transform: translateY(20px);
    transition: all var(--transition-normal);
    box-shadow: var(--shadow-md);
    z-index: var(--z-elevated);
}

.back-to-top.visible {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.back-to-top:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-blue);
}

@media (max-width: 768px) {
    .footer {
        text-align: center;
    }

    .footer-description {
        margin-left: auto;
        margin-right: auto;
    }

    .footer-social {
        justify-content: center;
    }

    .footer-nav-links {
        align-items: center;
    }
}

@media (max-width: 992px) {
    .user-auth {
        margin-left: 0.5rem;
        margin-right: 0.75rem;
    }
}

@media (max-width: 480px) {
    .user-auth {
        margin-left: 0.5rem;
        margin-right: 0.5rem;
    }
    
    .auth-btn,
    .user-avatar {
        width: 36px;
        height: 36px;
        font-size: 0.9rem;
    }
    
    .profile-dropdown {
        position: fixed;
        top: var(--header-height);
        right: 1rem;
        left: 1rem;
        min-width: auto;
    }
}

#page-items .section-header {
    position: sticky;
    top: 70px;
    z-index: 60;
}

#page-items .items-container {
    overflow-x: visible;
}

#page-items .section-card {
    overflow: visible;
}

#page-items .items-table th {
    top: 140px;
    z-index: 50;
}

.tour-badge.locked {
    background: var(--gray-200);
    border-color: var(--gray-300);
    color: var(--gray-400);
    cursor: not-allowed;
    opacity: 0.6;
}

.tour-badge.locked:hover {
    transform: none;
    border-color: var(--gray-300);
    color: var(--gray-400);
}

/* ===== RESPONSIVE TABLEUR ===== */
@media (max-width: 1024px) {
    #page-items .section-header {
        flex-direction: column;
        align-items: flex-start;
        top: 70px;
    }
    
    #page-items .support-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    #page-items .items-table th {
        top: 180px;
    }
	
	
}

@media (max-width: 768px) {
    #page-items .section-header {
        position: relative;
        top: auto;
        padding: 1rem;
    }
    
#page-items .items-table th {
        position: static;
        top: auto;
    }
    
    #page-items .filter-bar {
        flex-direction: column;
        gap: 0.75rem;
    }
    
    #page-items .filter-select {
        width: 100%;
    }
    
    #page-items .search-box {
        width: 100%;
    }
    
    #page-items .items-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    #page-items .section-card {
        overflow: visible;
    }
    
    #page-items .items-table {
        min-width: 800px;
    }
    
    #page-items .support-legend {
        display: none;
    }
    
    #page-items .section-title {
        font-size: 1rem;
    }
    
    .tour-badge-wrapper {
        min-width: 28px;
    }
    
    .tour-badge {
        width: 28px;
        height: 26px;
        font-size: 0.6rem;
    }
	
	    .section-body {
        padding: 0.75rem;
    }
}

@media (max-width: 480px) {
    #page-items .section-header {
        position: relative;
        top: auto;
        padding: 0.75rem;
    }
    
#page-items .items-table th {
        position: static;
        top: auto;
        padding: 0.5rem;
        font-size: 0.75rem;
    }
    
    #page-items .items-table td {
        padding: 0.5rem;
        font-size: 0.75rem;
    }
    
    #page-items .items-table .item-name {
        max-width: 120px;
        font-size: 0.7rem;
    }
    
    .tour-badge {
        width: 26px;
        height: 24px;
        font-size: 0.55rem;
    }
    
.tour-info {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1px;
    }
    
    .tour-duration {
        font-size: 0.5rem;
    }
    
    .tour-support {
        font-size: 0.5rem;
        padding: 0px 3px;
    }
    
    .app-nav-btn span {
        display: none;
    }
    
    .app-nav-btn i {
        font-size: 1.2rem;
    }
    
    .app-nav-btn {
        min-width: auto;
        padding: 0.75rem 1.5rem;
    }
	
		    /* Réduire les marges autour du tableau */
    .section-body {
        padding: 0.5rem;
    }
    
    .section-card {
        margin-bottom: 1rem;
        border-radius: var(--border-radius-md);
    }
    
    #page-items .section-header {
        padding: 0.5rem 0.75rem;
    }
    
    .items-container {
        margin: 0 -0.25rem;
    }
	
	
}

@media (max-width: 768px) {
    .main-content > .container {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
    }
    
    #page-items > .section-card {
        margin-left: -0.25rem;
        margin-right: -0.25rem;
        border-radius: var(--border-radius-md);
    }
}

@media (max-width: 480px) {
    .main-content > .container {
        padding-left: 0.25rem;
        padding-right: 0.25rem;
    }
    
    #page-items > .section-card {
        margin-left: 0;
        margin-right: 0;
        border-radius: var(--border-radius-sm);
        border-left: none;
        border-right: none;
    }
    
    #page-items .section-body {
        padding: 0.25rem;
    }
}


@media (max-width: 768px) {
    .main-content {
        padding: 1rem 0.5rem;
    }
}

@media (max-width: 480px) {
    .main-content {
        padding: 0.75rem 0.25rem;
    }
}


/* ===== CUSTOM SELECT DROPDOWNS ===== */
.custom-select {
    position: relative;
    min-width: 180px;
}

.custom-select-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    width: 100%;
    padding: 0.5rem 0.75rem;
    background: var(--white);
    border: 2px solid var(--gray-200);
    border-radius: var(--border-radius-md);
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--gray-700);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.custom-select-btn:hover {
    border-color: var(--primary-light);
}

.custom-select.open .custom-select-btn {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
}

.custom-select-icon {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary);
    font-size: 0.85rem;
}

.custom-select-text {
    flex: 1;
    text-align: left;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.custom-select-arrow {
    font-size: 0.7rem;
    color: var(--gray-400);
    transition: transform var(--transition-fast);
}

.custom-select.open .custom-select-arrow {
    transform: rotate(180deg);
}

.custom-select-menu {
    position: absolute;
    top: calc(100% + 0.5rem);
    left: 0;
    width: 100%;
    min-width: 220px;
    max-height: 300px;
    overflow-y: auto;
    background: var(--white);
    border: 2px solid var(--gray-200);
    border-radius: var(--border-radius-md);
    box-shadow: var(--shadow-lg);
    z-index: var(--z-dropdown);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all var(--transition-fast);
}

.custom-select.open .custom-select-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.custom-select-option {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.65rem 1rem;
    cursor: pointer;
    transition: all var(--transition-fast);
    color: var(--gray-700);
    font-size: 0.85rem;
}

.custom-select-option:hover {
    background: rgba(59, 130, 246, 0.08);
    color: var(--primary);
}

.custom-select-option.selected {
    background: var(--primary);
    color: white;
}

.custom-select-option.selected .option-icon {
    color: white;
}

.option-icon {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    color: var(--gray-500);
}

.custom-select-option:hover .option-icon {
    color: var(--primary);
}

/* Scrollbar du menu */
.custom-select-menu::-webkit-scrollbar {
    width: 6px;
}

.custom-select-menu::-webkit-scrollbar-track {
    background: var(--gray-100);
    border-radius: 3px;
}

.custom-select-menu::-webkit-scrollbar-thumb {
    background: var(--gray-300);
    border-radius: 3px;
}

.custom-select-menu::-webkit-scrollbar-thumb:hover {
    background: var(--gray-400);
}

/* Responsive */
@media (max-width: 768px) {
    .custom-select {
        width: 100%;
        min-width: auto;
    }
    
    .custom-select-menu {
        min-width: 100%;
    }
}

/* ===== MODE SOMBRE - CORRECTIONS ===== */

/* Modal de validation des tours */
[data-theme="dark"] .modal-content {
    background: #1e293b;
    border: 1px solid #374151;
}

[data-theme="dark"] .modal-title {
    color: #f9fafb;
}

[data-theme="dark"] .modal-label {
    color: #9ca3af;
}

[data-theme="dark"] .modal-input {
    background: #0f172a;
    border-color: #374151;
    color: #f9fafb;
}

[data-theme="dark"] .modal-input:focus {
    background: #1e293b;
    border-color: var(--primary);
}

/* Inputs de durée */
[data-theme="dark"] .duration-input-wrapper {
    background: #0f172a;
    border-color: #374151;
}

[data-theme="dark"] .duration-input {
    background: #1e293b;
    color: #f9fafb;
}

[data-theme="dark"] .duration-input:focus {
    box-shadow: 0 0 0 2px var(--primary);
}

[data-theme="dark"] .duration-separator {
    color: #9ca3af;
}

/* Boutons de support */
[data-theme="dark"] .support-btn {
    background: #0f172a;
    border-color: #374151;
    color: #d1d5db;
}

[data-theme="dark"] .support-btn:hover {
    background: #1e293b;
    border-color: var(--support-color);
    color: var(--support-color);
}

[data-theme="dark"] .support-btn.selected {
    background: var(--support-color);
    border-color: var(--support-color);
    color: white;
}

/* Bouton fermer modal */
[data-theme="dark"] .modal-close {
    background: #374151;
    color: #9ca3af;
}

[data-theme="dark"] .modal-close:hover {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

/* Bouton Réinitialiser dans modal */
[data-theme="dark"] .btn-reset {
    background: #374151;
    color: #d1d5db;
}

[data-theme="dark"] .btn-reset:hover {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

/* ===== RECHERCHE ET FILTRES ===== */

/* Champ de recherche */
[data-theme="dark"] .search-box input {
    background: #1e293b;
    border-color: #374151;
    color: #f9fafb;
}

[data-theme="dark"] .search-box input::placeholder {
    color: #6b7280;
}

[data-theme="dark"] .search-box input:focus {
    border-color: var(--primary);
    background: #0f172a;
}

[data-theme="dark"] .search-box i {
    color: #6b7280;
}

/* Boutons d'action rapide (Réinitialiser les filtres, etc.) */
[data-theme="dark"] .quick-action-btn {
    background: #374151;
    border-color: #4b5563;
    color: #f9fafb;
}

[data-theme="dark"] .quick-action-btn:hover {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
}

/* Custom select dropdowns */
[data-theme="dark"] .custom-select-btn {
    background: #1e293b;
    border-color: #374151;
    color: #f9fafb;
}

[data-theme="dark"] .custom-select-menu {
    background: #1e293b;
    border-color: #374151;
}

[data-theme="dark"] .custom-select-option {
    color: #d1d5db;
}

[data-theme="dark"] .custom-select-option:hover {
    background: rgba(59, 130, 246, 0.15);
    color: var(--primary-light);
}

[data-theme="dark"] .custom-select-option.selected {
    background: var(--primary);
    color: white;
}

/* Scrollbar du menu en mode sombre */
[data-theme="dark"] .custom-select-menu::-webkit-scrollbar-track {
    background: #1e293b;
}

[data-theme="dark"] .custom-select-menu::-webkit-scrollbar-thumb {
    background: #4b5563;
}

[data-theme="dark"] .custom-select-menu::-webkit-scrollbar-thumb:hover {
    background: #6b7280;
}

/* ===== INDICATEUR DE SAUVEGARDE - MODE SOMBRE ===== */
[data-theme="dark"] .saving-indicator {
    background: #f9fafb;
    color: #111827;
}

[data-theme="dark"] .saving-indicator.saved {
    background: #10b981;
    color: white;
}



/* ===== STATISTIQUES HEBDOMADAIRES ===== */
.stats-section-title.weekly i { color: #8b5cf6; }

.weekly-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 1.25rem;
    margin-bottom: 2rem;
}

.weekly-chart-card {
    background: var(--white);
    border-radius: var(--border-radius-lg);
    padding: 1.25rem;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--gray-200);
    position: relative;
    overflow: hidden;
    transition: all var(--transition-normal);
}

.weekly-chart-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
}

.weekly-chart-card.tours-weekly::before { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
.weekly-chart-card.time-weekly::before { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
.weekly-chart-card.feeling-weekly::before { background: linear-gradient(90deg, #ec4899, #f472b6); }

.weekly-chart-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-lg);
}

.weekly-chart-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.weekly-chart-icon {
    width: 40px;
    height: 40px;
    border-radius: var(--border-radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
}

.weekly-chart-card.tours-weekly .weekly-chart-icon {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(96, 165, 250, 0.15));
    color: #3b82f6;
}

.weekly-chart-card.time-weekly .weekly-chart-icon {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(251, 191, 36, 0.15));
    color: #f59e0b;
}

.weekly-chart-card.feeling-weekly .weekly-chart-icon {
    background: linear-gradient(135deg, rgba(236, 72, 153, 0.15), rgba(244, 114, 182, 0.15));
    color: #ec4899;
}

.weekly-chart-title {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--gray-800);
}

.weekly-chart-container {
    height: 180px;
    position: relative;
    margin-bottom: 1rem;
}

.weekly-chart-summary {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 0.75rem;
    border-top: 1px solid var(--gray-200);
}

.summary-label {
    font-size: 0.8rem;
    color: var(--gray-500);
    font-weight: 500;
}

.summary-value {
    font-size: 1.1rem;
    font-weight: 700;
}

.weekly-chart-card.tours-weekly .summary-value { color: #3b82f6; }
.weekly-chart-card.time-weekly .summary-value { color: #f59e0b; }
.weekly-chart-card.feeling-weekly .summary-value { color: #ec4899; }

/* Mode sombre */
[data-theme="dark"] .weekly-chart-card {
    background: var(--white);
    border-color: var(--gray-200);
}

[data-theme="dark"] .weekly-chart-title {
    color: var(--gray-800);
}

[data-theme="dark"] .weekly-chart-summary {
    border-top-color: var(--gray-200);
}

/* Responsive */
@media (max-width: 768px) {
    .weekly-stats-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .weekly-chart-container {
        height: 150px;
    }
}


/* ===== MESSAGE DE BIENVENUE ===== */
.welcome-message {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--gray-700);
    margin-bottom: 0.25rem;
    display: none;
}

.welcome-message.visible {
    display: block;
}

.welcome-message .user-name {
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-weight: 700;
}


</style>
</head>

<body>
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KGHT97MD" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

<div class="loader-wrapper" id="loader">
    <div class="loader">
        <div class="loader-logo"></div>
        <div class="loader-text">TypixClin</div>
    </div>
</div>

<header class="header" id="header">
    <div class="container header-container">
        <a href="index.html" class="logo">
            <span class="logo-icon"><i class="fas fa-stethoscope"></i></span>
            TypixClin
        </a>
        <nav class="nav">
            <ul class="nav-items">
                <li><a href="index.html#tools" class="nav-link">Outils</a></li>
                <li><a href="index.html#resources" class="nav-link">Ressources</a></li>
                <li><a href="index.html#ai" class="nav-link">IA</a></li>
                <li><a href="index.html#feedback" class="nav-link">Feedback</a></li>
            </ul>
            <button class="theme-toggle" id="theme-toggle"><i class="fas fa-sun"></i></button>
            <div class="user-auth" id="user-auth">
                <a href="auth.html" class="auth-btn" title="Se connecter"><i class="fas fa-user"></i></a>
                <div class="user-avatar" id="user-avatar" title="Mon profil"><span id="avatar-initials">JD</span></div>
                <div class="profile-dropdown" id="profile-dropdown">
                    <div class="profile-header">
                        <div class="profile-name" id="profile-name">Jean Dupont</div>
                        <div class="profile-email" id="profile-email">jean@example.com</div>
                    </div>
                    <div class="profile-menu">
                        <button class="profile-menu-item logout" id="logout-btn"><i class="fas fa-sign-out-alt"></i><span>Se déconnecter</span></button>
                    </div>
                </div>
            </div>
            <button class="mobile-menu-btn" id="mobile-menu-btn"><i class="fas fa-bars"></i></button>
        </nav>
    </div>
</header>

<div class="mobile-menu" id="mobile-menu">
    <a href="index.html#tools" class="nav-link">Outils</a>
    <a href="index.html#resources" class="nav-link">Ressources</a>
    <a href="index.html#ai" class="nav-link">IA</a>
    <a href="index.html#feedback" class="nav-link">Feedback</a>
</div>

<section class="page-header">
    <div class="container">
        <h1 class="page-title"><i class="fas fa-calendar-check"></i> Tableur de Révision EDN</h1>
        <p class="welcome-message" id="welcome-message"></p>
        <p class="page-subtitle">Organisez et suivez vos révisions</p>
        <a href="index.html" class="back-home-btn"><i class="fas fa-arrow-left"></i> Retour à l'accueil</a>
    </div>
</section>

<section class="login-required" id="login-required">
    <div class="login-required-card">
        <div class="login-required-icon"><i class="fas fa-lock"></i></div>
        <h2 class="login-required-title">Connexion requise</h2>
        <p class="login-required-text">Pour accéder à votre tableur de révision personnel et sauvegarder votre progression, vous devez créer un compte gratuit ou vous connecter.<br><br><strong>Tous les items</strong> répartis dans <strong>24 spécialités</strong> vous attendent !</p>
		<a href="auth.html?redirect=TableurEnLigne.html" class="login-required-btn"><i class="fas fa-sign-in-alt"></i> Se connecter / Créer un compte</a>
    </div>
</section>

<section class="main-content" id="main-content">
    <div class="container">
<nav class="app-nav">
    <button class="app-nav-btn" data-page="stats"><i class="fas fa-chart-pie"></i><span>Statistiques</span></button>
    <button class="app-nav-btn active" data-page="dashboard"><i class="fas fa-hospital"></i><span>Liste des spécialités</span></button>
    <button class="app-nav-btn" data-page="items"><i class="fas fa-list-check"></i><span>Liste des Items</span></button>
</nav>

<div class="app-page" id="page-stats">
    
    <!-- Titre Section Quotidienne -->
    <div class="stats-section-title daily">
        <i class="fas fa-calendar-day"></i> Statistiques du Jour
    </div>
    
    <div class="daily-stats-grid">
        <div class="daily-stat-card items-today">
            <div class="daily-stat-header">
                <div class="daily-stat-icon"><i class="fas fa-redo-alt"></i></div>
                <div class="daily-stat-label">Tours effectués aujourd'hui</div>
            </div>
            <div class="daily-stat-value" id="stat-items-today">0</div>
        </div>
        
        <div class="daily-stat-card delay-caught">
            <div class="daily-stat-header">
                <div class="daily-stat-icon"><i class="fas fa-forward"></i></div>
                <div class="daily-stat-label">Retard rattrapé</div>
            </div>
            <div class="daily-stat-value" id="stat-delay-caught">0<span class="daily-stat-unit">jours</span></div>
        </div>
        
        <div class="daily-stat-card time-today">
            <div class="daily-stat-header">
                <div class="daily-stat-icon"><i class="fas fa-hourglass-half"></i></div>
                <div class="daily-stat-label">Temps de travail ce jour</div>
            </div>
            <div class="daily-stat-value" id="stat-time-today">0h00</div>
        </div>
        
        <div class="daily-stat-card feeling-today">
            <div class="daily-stat-header">
                <div class="daily-stat-icon"><i class="fas fa-smile"></i></div>
                <div class="daily-stat-label">Ressenti moyen du jour</div>
            </div>
            <div class="daily-stat-value" id="stat-feeling-today">--</div>
            <div class="feeling-indicator" id="feeling-indicator">
                <span class="feeling-dot" data-level="1"></span>
                <span class="feeling-dot" data-level="2"></span>
                <span class="feeling-dot" data-level="3"></span>
                <span class="feeling-dot" data-level="4"></span>
                <span class="feeling-dot" data-level="5"></span>
            </div>
        </div>
    </div>
	
	<!-- Titre Section Hebdomadaire -->
<div class="stats-section-title weekly">
    <i class="fas fa-calendar-week"></i> Statistiques des 7 derniers jours
</div>

<div class="weekly-stats-grid">
    <div class="weekly-chart-card tours-weekly">
        <div class="weekly-chart-header">
            <div class="weekly-chart-icon"><i class="fas fa-redo-alt"></i></div>
            <div class="weekly-chart-title">Tours effectués</div>
        </div>
        <div class="weekly-chart-container">
            <canvas id="chart-tours-weekly"></canvas>
        </div>
        <div class="weekly-chart-summary">
            <span class="summary-label">Total semaine :</span>
            <span class="summary-value" id="weekly-tours-total">0</span>
        </div>
    </div>
    
    <div class="weekly-chart-card time-weekly">
        <div class="weekly-chart-header">
            <div class="weekly-chart-icon"><i class="fas fa-hourglass-half"></i></div>
            <div class="weekly-chart-title">Temps de travail</div>
        </div>
        <div class="weekly-chart-container">
            <canvas id="chart-time-weekly"></canvas>
        </div>
        <div class="weekly-chart-summary">
            <span class="summary-label">Total semaine :</span>
            <span class="summary-value" id="weekly-time-total">0h00</span>
        </div>
    </div>
    
    <div class="weekly-chart-card feeling-weekly">
        <div class="weekly-chart-header">
            <div class="weekly-chart-icon"><i class="fas fa-smile"></i></div>
            <div class="weekly-chart-title">Ressenti moyen</div>
        </div>
        <div class="weekly-chart-container">
            <canvas id="chart-feeling-weekly"></canvas>
        </div>
        <div class="weekly-chart-summary">
            <span class="summary-label">Moyenne semaine :</span>
            <span class="summary-value" id="weekly-feeling-avg">--</span>
        </div>
    </div>
</div>

    <!-- Titre Section Générale -->
    <div class="stats-section-title general">
        <i class="fas fa-chart-pie"></i> Statistiques Générales
    </div>
    
    <div class="stats-grid">
        <div class="stat-card blue">
            <div class="stat-icon blue"><i class="fas fa-book-open"></i></div>
            <div class="stat-value" id="stat-items-done">0</div>
            <div class="stat-label">Items révisés (≥1 tour)</div>
            <div class="stat-progress"><div class="progress-bar"><div class="progress-fill blue" id="progress-items" style="width: 0%"></div></div></div>
        </div>
        <div class="stat-card green">
            <div class="stat-icon green"><i class="fas fa-check-double"></i></div>
            <div class="stat-value" id="stat-tours-done">0</div>
            <div class="stat-label">Tours effectués</div>
            <div class="stat-progress"><div class="progress-bar"><div class="progress-fill green" id="progress-tours" style="width: 0%"></div></div></div>
        </div>
        <div class="stat-card orange">
            <div class="stat-icon orange"><i class="fas fa-trophy"></i></div>
            <div class="stat-value" id="stat-specialties-done">0</div>
            <div class="stat-label">Spécialités terminées</div>
            <div class="stat-sublabel">(tous items vus ≥1 fois)</div>
        </div>
        <div class="stat-card purple">
            <div class="stat-icon purple"><i class="fas fa-clock"></i></div>
            <div class="stat-value" id="stat-total-time">0h00</div>
            <div class="stat-label">Temps de travail total</div>
            <div class="stat-sublabel">Cumulé sur tous les tours</div>
        </div>
    </div>
	
	

</div>



<div class="app-page active" id="page-dashboard">

    
    <div class="section-card">
        <div class="section-header"><h2 class="section-title"><i class="fas fa-chart-line"></i> Progression par spécialité</h2></div>
        <div class="section-body"><div class="specialties-grid" id="dashboard-specialties"></div></div>
    </div>
	
	   
	
</div>

        <div class="app-page" id="page-items">
				<div class="filter-bar">
					<div class="search-box"><i class="fas fa-search"></i><input type="text" id="search-item" placeholder="Rechercher un item..."></div>
					<div class="custom-select" id="specialty-dropdown">
						<button class="custom-select-btn" type="button">
							<span class="custom-select-icon"><i class="fas fa-list"></i></span>
							<span class="custom-select-text">Toutes les spécialités</span>
							<i class="fas fa-chevron-down custom-select-arrow"></i>
						</button>
						<div class="custom-select-menu" id="specialty-menu"></div>
						<input type="hidden" id="filter-item-specialty" value="all">
					</div>

					<div class="custom-select" id="status-dropdown">
						<button class="custom-select-btn" type="button">
							<span class="custom-select-icon"><i class="fas fa-tasks"></i></span>
							<span class="custom-select-text">Tous les statuts</span>
							<i class="fas fa-chevron-down custom-select-arrow"></i>
						</button>
						<div class="custom-select-menu">
							<div class="custom-select-option selected" data-value="all">
								<span class="option-icon"><i class="fas fa-tasks"></i></span>
								<span>Tous les statuts</span>
							</div>
							<div class="custom-select-option" data-value="not-started">
								<span class="option-icon"><i class="fas fa-circle"></i></span>
								<span>Non commencés</span>
							</div>
							<div class="custom-select-option" data-value="in-progress">
								<span class="option-icon"><i class="fas fa-spinner"></i></span>
								<span>En cours</span>
							</div>
						</div>
						<input type="hidden" id="filter-item-status" value="all">
					</div>
				</div>

            <div class="section-card">
					<div class="section-header">
						<h2 class="section-title"><i class="fas fa-list-check"></i> Liste des Items</h2>
						<div class="support-legend">
							<span class="legend-item qcm"><strong>QCM</strong> QCM/DP</span>
							<span class="legend-item college"><strong>COL</strong> Collèges</span>
							<span class="legend-item anki"><strong>ANK</strong> Anki</span>
							<span class="legend-item perso"><strong>PER</strong> Fiche perso</span>
							<span class="legend-item codex"><strong>COD</strong> EDNi/Codex</span>
							<span class="legend-item conf"><strong>CNF</strong> Conférence</span>
						</div>
						<div class="quick-actions"><button class="quick-action-btn" id="btn-reset-filters"><i class="fas fa-filter-circle-xmark"></i> Réinitialiser</button></div>
					</div>
                <div class="section-body">
                    <div class="items-container">
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th data-sort="num">N° <i class="fas fa-sort sort-icon"></i></th>
                                    <th data-sort="name">Nom <i class="fas fa-sort sort-icon"></i></th>
                                    <th data-sort="specialty">Spécialité <i class="fas fa-sort sort-icon"></i></th>
                                    <th>Tours (T1-T8)</th>
                                    <th>Ressources</th>
                                    <th data-sort="days">Dernière révision <i class="fas fa-sort sort-icon"></i></th>
                                </tr>
                            </thead>
                            <tbody id="items-table-body"></tbody>
                        </table>
                    </div>
                    <div class="empty-state" id="items-empty" style="display: none;"><i class="fas fa-search"></i><p>Aucun item ne correspond</p></div>
                </div>
            </div>
        </div>
    </div>
</section>

<div class="modal" id="confidence-modal">
    <div class="modal-content">
        <button class="modal-close" id="confidence-close"><i class="fas fa-xmark"></i></button>
        <h3 class="modal-title">Enregistrer le tour</h3>
        
        <div class="modal-section">
            <label class="modal-label">Confiance</label>
            <div class="confidence-buttons">
                <button class="confidence-btn c1" data-confidence="1">1</button>
                <button class="confidence-btn c2" data-confidence="2">2</button>
                <button class="confidence-btn c3" data-confidence="3">3</button>
                <button class="confidence-btn c4" data-confidence="4">4</button>
                <button class="confidence-btn c5" data-confidence="5">5</button>
            </div>
        </div>
        
        <div class="modal-section">
            <label class="modal-label">Date</label>
            <input type="date" id="tour-date" class="modal-input">
        </div>
        
        <div class="modal-section">
            <label class="modal-label">Durée</label>
            <div class="duration-input-wrapper">
                <input type="number" id="tour-duration-hours" class="duration-input" min="0" max="23" placeholder="0">
                <span class="duration-separator">h</span>
                <input type="number" id="tour-duration-minutes" class="duration-input" min="0" max="59" step="5" placeholder="00">
                <span class="duration-separator">min</span>
            </div>
        </div>
        
        <div class="modal-section">
            <label class="modal-label">Support</label>
            <div class="support-buttons">
                <button class="support-btn" data-support="qcm"><i class="fas fa-list-check"></i> QCM/DP</button>
                <button class="support-btn" data-support="college"><i class="fas fa-book"></i> Collèges</button>
                <button class="support-btn" data-support="anki"><i class="fas fa-clone"></i> Anki</button>
                <button class="support-btn" data-support="perso"><i class="fas fa-pen"></i> Fiche perso</button>
                <button class="support-btn" data-support="codex"><i class="fas fa-file-lines"></i> EDNi/Codex</button>
                <button class="support-btn" data-support="conf"><i class="fas fa-chalkboard-user"></i> Conf</button>
            </div>
        </div>
        
        <div class="modal-actions">
            <button class="btn-validate" id="btn-save-tour"><i class="fas fa-check"></i> Valider</button>
            <button class="btn-reset" id="btn-reset-tour"><i class="fas fa-trash"></i> Réinitialiser</button>
        </div>
    </div>
</div>

<div class="saving-indicator" id="saving-indicator"><i class="fas fa-spinner"></i><span>Sauvegarde...</span></div>
<div class="back-to-top" id="back-to-top"><i class="fas fa-arrow-up"></i></div>

<!-- Footer -->
<footer class="footer">
    <div class="container">
        <div class="footer-container">
            <div class="footer-brand">
                <div class="footer-logo">TypixClin</div>
                <p class="footer-description">Plateforme d'aide à la rédaction des examens cliniques pour étudiants en médecine.</p>
                <div class="footer-social">
                    <a href="https://github.com/JEZENN/TypixClin" class="social-link"><i class="fab fa-github"></i></a>
                </div>
            </div>
            
            <div class="footer-nav">
                <h4 class="footer-nav-title">Outils</h4>
                <div class="footer-nav-links">
                    <a href="examen-adulte.html" class="footer-nav-link">Examen Adulte</a>
                    <a href="examen-pédiatrique.html" class="footer-nav-link">Examen Pédiatrique</a>
                    <a href="examen-réanimation.html" class="footer-nav-link">Examen Réanimation</a>
                    <a href="ecg.html" class="footer-nav-link">ECG</a>
                    <a href="gds.html" class="footer-nav-link">Gaz du sang</a>
                    <a href="Troubles ioniques.html" class="footer-nav-link">Troubles ioniques</a>
                </div>
            </div>
            
            <div class="footer-nav">
                <h4 class="footer-nav-title">Ressources</h4>
                <div class="footer-nav-links">
                    <a href="Fiche-examen-clinique.html" class="footer-nav-link">Fiche Examen Clinique</a>
                    <a href="Fiche-ECG.html" class="footer-nav-link">Fiche ECG</a>
					<a href="FichierGsheet.html" class="footer-nav-link">Tableur Gsheet Externat</a>
					<a href="TableurEnLigne.html" class="footer-nav-link">Tableur en ligne Externat</a>
					<a href="Carnet-de-stage.html" class="footer-nav-link">Carnet de stage</a>

                </div>
            </div>
            
            <div class="footer-nav">
                <h4 class="footer-nav-title">À propos</h4>
                <div class="footer-nav-links">
                    <a href="index.html#tools" class="footer-nav-link">Outils</a>
                    <a href="index.html#ai" class="footer-nav-link">IA</a>
                    <a href="index.html#feedback" class="footer-nav-link">Feedback</a>
					<a href="MentionsLégales.html" class="footer-nav-link">Mentions légales</a>
                </div>
            </div>
        </div>
        
        <div class="footer-bottom">
            <div class="footer-copyright">TypixClin © 2025, Jean ZENNARO</div>
        </div>
    </div>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBSJPwPWOAGnWwQN3j2qwu8pxf2iCdO-Gc",
    authDomain: "typixclin-b5fa9.firebaseapp.com",
    projectId: "typixclin-b5fa9",
    storageBucket: "typixclin-b5fa9.firebasestorage.app",
    messagingSenderId: "726560091078",
    appId: "1:726560091078:web:5ce8b31da0bfbbc1f720c7",
    measurementId: "G-9CZ2QB6TNK"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const SPECIALTY_CONFIG = {
    'cardiologie': { color: '#ef4444', icon: 'fa-heart-pulse' },
    'hge': { color: '#f97316', icon: 'fa-poop' },
    'pneumologie': { color: '#3b82f6', icon: 'fa-lungs' },
    'gynecologie': { color: '#ec4899', icon: 'fa-venus' },
    'orl': { color: '#8b5cf6', icon: 'fa-ear-listen' },
    'neurologie': { color: '#6366f1', icon: 'fa-brain' },
    'psychiatrie': { color: '#a855f7', icon: 'fa-masks-theater' },
    'osteo': { color: '#14b8a6', icon: 'fa-bone' },
    'pediatrie': { color: '#f472b6', icon: 'fa-baby' },
    'hematologie': { color: '#dc2626', icon: 'fa-droplet' },
    'endocrinologie': { color: '#eab308', icon: 'fa-dna' },
    'mir': { color: '#ef4444', icon: 'fa-truck-medical' },
    'nephrologie': { color: '#0ea5e9', icon: 'fa-filter' },
    'infectiologie': { color: '#22c55e', icon: 'fa-virus' },
    'dermatologie': { color: '#f59e0b', icon: 'fa-hand-dots' },
    'therapeutique': { color: '#6366f1', icon: 'fa-pills' },
    'geriatrie': { color: '#78716c', icon: 'fa-wheelchair' },
    'douleur': { color: '#a855f7', icon: 'fa-hand-holding-medical' },
    'medecine-interne': { color: '#0d9488', icon: 'fa-stethoscope' },
    'oncologie': { color: '#be123c', icon: 'fa-disease' },
    'ophtalmologie': { color: '#0284c7', icon: 'fa-eye' },
    'urologie': { color: '#ca8a04', icon: 'fa-mars' },
    'medecine-legale': { color: '#475569', icon: 'fa-scale-balanced' },
    'sante-publique': { color: '#059669', icon: 'fa-chart-pie' }
};

const SPECIALTIES_DATA = [
  {"id":"cardiologie","name":"Cardiologie - Chir Vasc.","items":[{"fc":"FC01","num":"113","name":"Hémangiomes et malformations vasc cutanées"},{"fc":"FC02","num":"153","name":"Surveillance des porteurs de valves"},{"fc":"FC03","num":"221","name":"Athérome et patient polyathéromateux"},{"fc":"FC04","num":"222","name":"Facteurs de risque CV et prévention"},{"fc":"FC05","num":"224","name":"HTA"},{"fc":"FC06","num":"230","name":"Douleur thoracique"},{"fc":"FC07","num":"231","name":"ECG"},{"fc":"FC08","num":"232","name":"Fibrillation atriale"},{"fc":"FC09","num":"233","name":"Valvulopathies"},{"fc":"FC10","num":"227","name":"Insuffisance veineuse chronique"},{"fc":"FC11","num":"235","name":"Péricardite aigue"},{"fc":"FC12","num":"236","name":"Troubles de la conduction"},{"fc":"FC13","num":"237","name":"Palpitations et trouble du rythme"},{"fc":"FC14","num":"342","name":"Malaise et perte de connaissance"},{"fc":"FC15","num":"339","name":"Angor chronique stable et SCA"},{"fc":"FC16","num":"225","name":"Artériopathies aorte, MI"},{"fc":"FC17","num":"223","name":"Dyslipidémies"},{"fc":"FC18","num":"234","name":"Insuffisance cardiaque"},{"fc":"FC19","num":"238","name":"Souffle cardiaque enfant"},{"fc":"FC20","num":"331","name":"Arrêt cardiocirculatoire"},{"fc":"FC21","num":"226","name":"TVP et EP"},{"fc":"FC22","num":"330","name":"AAP, anticoagulants"},{"fc":"FC23","num":"152","name":"Endocardite infectieuse"},{"fc":"FC24","num":"228","name":"Ulcère de jambe"},{"fc":"FC25","num":"239","name":"Acrosyndromes"}]},
  {"id":"hge","name":"HGE - Chirurgie digestive","items":[{"fc":"FC01","num":"167","name":"Hépatites virales"},{"fc":"FC02","num":"219","name":"Pathologies du fer"},{"fc":"FC03","num":"269","name":"Douleurs abdominales aigues"},{"fc":"FC04","num":"271","name":"RGO et Hernie hiatale"},{"fc":"FC05","num":"272","name":"Ulcère gastrique et duodénal"},{"fc":"FC06","num":"273","name":"Dysphagie oro-pharyngée"},{"fc":"FC07","num":"274","name":"Vomissements de l'adulte"},{"fc":"FC08","num":"276","name":"Hépatomégalie"},{"fc":"FC09","num":"277","name":"Lithiase biliaire"},{"fc":"FC10","num":"278","name":"Ictère de l'adulte"},{"fc":"FC11","num":"279","name":"Cirrhose"},{"fc":"FC12","num":"280","name":"Ascite"},{"fc":"FC13","num":"281","name":"Pancréatite chronique"},{"fc":"FC14","num":"282","name":"MICI"},{"fc":"FC15","num":"283","name":"Constipation"},{"fc":"FC16","num":"284","name":"Colopathie fonctionnelle"},{"fc":"FC17","num":"285","name":"Diarrhée chronique"},{"fc":"FC18","num":"286","name":"Diarrhée aigue"},{"fc":"FC19","num":"287","name":"Diverticulose"},{"fc":"FC20","num":"288","name":"Pathologie hémorroidaire"},{"fc":"FC21","num":"301","name":"Tumeurs colorectales"},{"fc":"FC22","num":"303","name":"Tumeurs estomac"},{"fc":"FC23","num":"304","name":"Tumeurs foie"},{"fc":"FC24","num":"305","name":"Tumeurs oesophage"},{"fc":"FC25","num":"308","name":"Tumeurs pancréas"},{"fc":"FC26","num":"355","name":"Hémorragie digestive"},{"fc":"FC27","num":"358","name":"Pancréatite aigue"},{"fc":"FC28","num":"354","name":"Syndrome occlusif"},{"fc":"FC29","num":"356","name":"Appendicite"},{"fc":"FC30","num":"357","name":"Péritonite aigue"},{"fc":"FC31","num":"201","name":"Transplantation hépatique"},{"fc":"FC32","num":"289","name":"Hernie pariétale"}]},
  {"id":"pneumologie","name":"Pneumologie","items":[{"fc":"FC01","num":"186","name":"Allergies respiratoires"},{"fc":"FC02","num":"188","name":"Asthme, rhinite"},{"fc":"FC03","num":"209","name":"BPCO"},{"fc":"FC04","num":"204","name":"Toux chez l'adulte"},{"fc":"FC05","num":"226","name":"TVP et EP"},{"fc":"FC06","num":"203","name":"Dyspnée aigue et chronique"},{"fc":"FC07","num":"360","name":"Pneumothorax"},{"fc":"FC08","num":"159","name":"Tuberculose"},{"fc":"FC09","num":"206","name":"Epanchement pleural"},{"fc":"FC10","num":"211","name":"Sarcoidose"},{"fc":"FC11","num":"210","name":"PID"},{"fc":"FC12","num":"208","name":"Insuffisance respiratoire chronique"},{"fc":"FC13","num":"75","name":"Addiction tabac"},{"fc":"FC14","num":"205","name":"Hémoptysie"},{"fc":"FC15","num":"359","name":"Détresse respiratoire"},{"fc":"FC16","num":"207","name":"Opacités intrathoraciques"},{"fc":"FC17","num":"306","name":"Tumeurs poumon"},{"fc":"FC18","num":"155","name":"Infections broncho-pulmonaires"}]},
  {"id":"gynecologie","name":"Gynécologie - Obstétrique","items":[{"fc":"FC01","num":"34","name":"Anomalies du cycle menstruel"},{"fc":"FC02","num":"35","name":"Contraception"},{"fc":"FC03","num":"36","name":"IVG"},{"fc":"FC04","num":"37","name":"Infertilité du couple"},{"fc":"FC05","num":"38","name":"AMP"},{"fc":"FC06","num":"39","name":"Algies pelviennes"},{"fc":"FC07","num":"40","name":"Aménorrhée"},{"fc":"FC08","num":"41","name":"Hémorragie génitale"},{"fc":"FC09","num":"42","name":"Tuméfaction pelvienne"},{"fc":"FC10","num":"43","name":"Ménopause"},{"fc":"FC11","num":"22","name":"Grossesse normale"},{"fc":"FC12","num":"23","name":"Complications grossesse"},{"fc":"FC13","num":"24","name":"GEU"},{"fc":"FC14","num":"25","name":"Douleur abdo enceinte"},{"fc":"FC15","num":"26","name":"Prévention risques foetaux"},{"fc":"FC16","num":"27","name":"Infection urinaire grossesse"},{"fc":"FC17","num":"28","name":"VIH grossesse"},{"fc":"FC18","num":"29","name":"Prématurité et RCIU"},{"fc":"FC19","num":"30","name":"Accouchement normal"},{"fc":"FC20","num":"31","name":"Hémorragie post-partum"},{"fc":"FC21","num":"32","name":"Allaitement"},{"fc":"FC22","num":"33","name":"Suites de couches"},{"fc":"FC23","num":"162","name":"Infections génitales"},{"fc":"FC24","num":"302","name":"Tumeurs col utérin"},{"fc":"FC25","num":"300","name":"Tumeurs sein"},{"fc":"FC26","num":"309","name":"Tumeurs ovariennes"},{"fc":"FC27","num":"307","name":"Tumeurs utérus"}]},
  {"id":"orl","name":"ORL - CMF","items":[{"fc":"FC01","num":"87","name":"Epistaxis"},{"fc":"FC02","num":"88","name":"Glandes salivaires"},{"fc":"FC03","num":"89","name":"Fonction auditive"},{"fc":"FC04","num":"90","name":"Annexes oeil"},{"fc":"FC05","num":"99","name":"Paralysie faciale"},{"fc":"FC06","num":"101","name":"Vertige"},{"fc":"FC07","num":"148","name":"Angines"},{"fc":"FC08","num":"149","name":"Otites"},{"fc":"FC09","num":"150","name":"Rhinites sinusites"},{"fc":"FC10","num":"216","name":"Adénopathie"},{"fc":"FC11","num":"270","name":"Dysphagie"},{"fc":"FC12","num":"275","name":"Otalgie otorrhée"},{"fc":"FC13","num":"298","name":"Tumeurs cavum"},{"fc":"FC14","num":"299","name":"Tumeurs buccales"}]},
  {"id":"neurologie","name":"Neurologie - Neurochirurgie","items":[{"fc":"FC01","num":"91","name":"Compression médullaire"},{"fc":"FC02","num":"92","name":"Rachialgie"},{"fc":"FC03","num":"93","name":"Radiculalgie"},{"fc":"FC04","num":"94","name":"Neuropathies périphériques"},{"fc":"FC05","num":"95","name":"Polyradiculonévrite"},{"fc":"FC06","num":"96","name":"Myasthénie"},{"fc":"FC07","num":"97","name":"Migraine, névralgie"},{"fc":"FC08","num":"98","name":"Céphalée"},{"fc":"FC09","num":"100","name":"Diplopie"},{"fc":"FC10","num":"102","name":"SEP"},{"fc":"FC11","num":"103","name":"Épilepsie"},{"fc":"FC12","num":"104","name":"Parkinson"},{"fc":"FC13","num":"105","name":"Mouvements anormaux"},{"fc":"FC14","num":"106","name":"Confusion, démences"},{"fc":"FC15","num":"107","name":"Troubles marche"},{"fc":"FC16","num":"108","name":"Troubles cognitifs"},{"fc":"FC17","num":"336","name":"AVC"},{"fc":"FC18","num":"337","name":"Malaise, crise comitiale"},{"fc":"FC19","num":"338","name":"État confusionnel"},{"fc":"FC20","num":"340","name":"Coma non traumatique"},{"fc":"FC21","num":"341","name":"Hémorragie méningée"},{"fc":"FC22","num":"344","name":"HTIC"},{"fc":"FC23","num":"296","name":"Tumeurs intracrâniennes"},{"fc":"FC24","num":"332","name":"Traumatisé crânien"}]},
  {"id":"psychiatrie","name":"Psychiatrie","items":[{"fc":"FC01","num":"63","name":"Trouble dépressif"},{"fc":"FC02","num":"64","name":"Trouble bipolaire"},{"fc":"FC03","num":"65","name":"Troubles anxieux"},{"fc":"FC04","num":"66","name":"TOC"},{"fc":"FC05","num":"67","name":"Troubles grossesse post-partum"},{"fc":"FC06","num":"68","name":"Troubles sujet âgé"},{"fc":"FC07","num":"69","name":"TCA"},{"fc":"FC08","num":"70","name":"Troubles somatoformes"},{"fc":"FC09","num":"71","name":"Psychothérapies"},{"fc":"FC10","num":"72","name":"Troubles somatiques"},{"fc":"FC11","num":"73","name":"Addiction tabac"},{"fc":"FC12","num":"74","name":"Addiction alcool"},{"fc":"FC13","num":"75","name":"Addiction tabac"},{"fc":"FC14","num":"76","name":"Addiction alcool"},{"fc":"FC15","num":"77","name":"Addiction psychotropes"},{"fc":"FC16","num":"78","name":"Addiction cannabis cocaïne"},{"fc":"FC17","num":"79","name":"Addictions comportementales"},{"fc":"FC18","num":"80","name":"Troubles psychotiques"},{"fc":"FC19","num":"81","name":"Personnalité"},{"fc":"FC20","num":"82","name":"Risque suicidaire"},{"fc":"FC21","num":"83","name":"Psychotropes"},{"fc":"FC22","num":"349","name":"Agitation délire"}]},
  {"id":"osteo","name":"Ostéo-articulaire","items":[{"fc":"FC01","num":"92","name":"Rachialgie"},{"fc":"FC02","num":"93","name":"Radiculalgie"},{"fc":"FC03","num":"125","name":"Arthrose"},{"fc":"FC04","num":"126","name":"PR"},{"fc":"FC05","num":"127","name":"Psoriasis"},{"fc":"FC06","num":"128","name":"Ostéopathies fragilisantes"},{"fc":"FC07","num":"129","name":"Arthropathie microcristalline"},{"fc":"FC08","num":"130","name":"Spondyloarthrite"},{"fc":"FC09","num":"153","name":"Prothèses"},{"fc":"FC10","num":"192","name":"Pathologies auto-immunes"},{"fc":"FC11","num":"193","name":"Raynaud"},{"fc":"FC12","num":"194","name":"Lupus"},{"fc":"FC13","num":"195","name":"Artérite cellules géantes"},{"fc":"FC14","num":"199","name":"SDRC"},{"fc":"FC15","num":"357","name":"Lésion genou"},{"fc":"FC16","num":"358","name":"Prothèses ostéosynthèses"},{"fc":"FC17","num":"359","name":"Fractures adulte"},{"fc":"FC18","num":"360","name":"Fractures enfant"},{"fc":"FC19","num":"361","name":"Malade sous plâtre"},{"fc":"FC20","num":"362","name":"Tumeurs os"}]},
  {"id":"pediatrie","name":"Pédiatrie","items":[{"fc":"FC01","num":"45","name":"Alimentation nourrisson"},{"fc":"FC02","num":"46","name":"Développement buccodentaire"},{"fc":"FC03","num":"47","name":"Puberté"},{"fc":"FC04","num":"48","name":"Pathologie génitoscrotale"},{"fc":"FC05","num":"49","name":"Troubles miction enfant"},{"fc":"FC06","num":"50","name":"Strabisme enfant"},{"fc":"FC07","num":"51","name":"Retard croissance"},{"fc":"FC08","num":"52","name":"Boiterie enfant"},{"fc":"FC09","num":"53","name":"Développement psychomoteur"},{"fc":"FC10","num":"54","name":"Enfant handicapé"},{"fc":"FC11","num":"55","name":"Maltraitance"},{"fc":"FC12","num":"56","name":"Sexualité"},{"fc":"FC13","num":"57","name":"Précarité"},{"fc":"FC14","num":"58","name":"Classifications troubles mentaux"},{"fc":"FC15","num":"59","name":"Troubles langage"},{"fc":"FC16","num":"60","name":"Autisme"},{"fc":"FC17","num":"61","name":"TDAH"},{"fc":"FC18","num":"62","name":"Trouble dépressif"},{"fc":"FC19","num":"151","name":"Infections bronchopulmonaires"},{"fc":"FC20","num":"340","name":"Malaise nourrisson"},{"fc":"FC21","num":"341","name":"Convulsions enfant"},{"fc":"FC22","num":"344","name":"Détresse respiratoire enfant"}]},
  {"id":"hematologie","name":"Hématologie","items":[{"fc":"FC01","num":"209","name":"Anémie"},{"fc":"FC02","num":"210","name":"Thrombopénie"},{"fc":"FC03","num":"211","name":"Purpuras"},{"fc":"FC04","num":"212","name":"Syndrome hémorragique"},{"fc":"FC05","num":"213","name":"Syndrome mononucléosique"},{"fc":"FC06","num":"214","name":"Éosinophilie"},{"fc":"FC07","num":"215","name":"Pathologie fer"},{"fc":"FC08","num":"216","name":"Adénopathie"},{"fc":"FC09","num":"217","name":"Amylose"},{"fc":"FC10","num":"218","name":"Splénomégalie"},{"fc":"FC11","num":"313","name":"SMD"},{"fc":"FC12","num":"314","name":"SMP"},{"fc":"FC13","num":"315","name":"LLC"},{"fc":"FC14","num":"316","name":"Lymphomes"},{"fc":"FC15","num":"317","name":"Myélome"},{"fc":"FC16","num":"318","name":"Leucémies aiguës"},{"fc":"FC17","num":"319","name":"Transfusion"},{"fc":"FC18","num":"320","name":"TVP EP"},{"fc":"FC19","num":"321","name":"Anticoagulants"},{"fc":"FC20","num":"208","name":"Hémogramme"}]},
  {"id":"endocrinologie","name":"Endocrinologie - Nutrition","items":[{"fc":"FC01","num":"220","name":"Adénome hypophysaire"},{"fc":"FC02","num":"221","name":"Insuffisance surrénale"},{"fc":"FC03","num":"222","name":"Hypercalcémie"},{"fc":"FC04","num":"223","name":"Dyslipidémies"},{"fc":"FC05","num":"224","name":"Hyperthyroïdie"},{"fc":"FC06","num":"225","name":"Hypothyroïdie"},{"fc":"FC07","num":"226","name":"Goitre nodules cancers thyroïdiens"},{"fc":"FC08","num":"227","name":"Diabète type 1 et 2"},{"fc":"FC09","num":"228","name":"Complications diabète"},{"fc":"FC10","num":"229","name":"Diabète gestationnel"},{"fc":"FC11","num":"230","name":"Hypoglycémie"},{"fc":"FC12","num":"231","name":"Obésité"},{"fc":"FC13","num":"232","name":"Dénutrition"},{"fc":"FC14","num":"247","name":"Mode de vie"},{"fc":"FC15","num":"248","name":"Régime diététique"},{"fc":"FC16","num":"249","name":"Besoins nutritionnels"},{"fc":"FC17","num":"250","name":"Troubles nutritionnels sujet âgé"},{"fc":"FC18","num":"251","name":"TCA"}]},
  {"id":"mir","name":"MIR - Anesthésie","items":[{"fc":"FC01","num":"329","name":"Prise en charge pré-hospitalière"},{"fc":"FC02","num":"330","name":"Traumatisme crânien"},{"fc":"FC03","num":"331","name":"Coma non traumatique"},{"fc":"FC04","num":"332","name":"État de choc"},{"fc":"FC05","num":"333","name":"Œdème Quincke anaphylaxie"},{"fc":"FC06","num":"334","name":"Arrêt cardiocirculatoire"},{"fc":"FC07","num":"335","name":"AVC"},{"fc":"FC08","num":"336","name":"Hémorragie méningée"},{"fc":"FC09","num":"337","name":"Malaise crise comitiale"},{"fc":"FC10","num":"338","name":"État confusionnel"},{"fc":"FC11","num":"339","name":"SCA"},{"fc":"FC12","num":"340","name":"Malaise nourrisson"},{"fc":"FC13","num":"341","name":"Convulsions enfant"},{"fc":"FC14","num":"343","name":"IRA Anurie"},{"fc":"FC15","num":"344","name":"Détresse respiratoire nourrisson"},{"fc":"FC16","num":"345","name":"Grosse jambe rouge"},{"fc":"FC17","num":"346","name":"Agitation délire"},{"fc":"FC18","num":"347","name":"Rétention urine"},{"fc":"FC19","num":"349","name":"Syndrome occlusif"},{"fc":"FC20","num":"350","name":"Hémorragie digestive"},{"fc":"FC21","num":"351","name":"Appendicite"},{"fc":"FC22","num":"352","name":"Péritonite"},{"fc":"FC23","num":"353","name":"Pancréatite aiguë"},{"fc":"FC24","num":"354","name":"Détresse respiratoire adulte"},{"fc":"FC25","num":"355","name":"Insuffisance respiratoire"},{"fc":"FC26","num":"356","name":"Pneumothorax"},{"fc":"FC27","num":"133","name":"Anesthésie"}]},
  {"id":"nephrologie","name":"Néphrologie","items":[{"fc":"FC01","num":"256","name":"Protéinurie syndrome néphrotique"},{"fc":"FC02","num":"257","name":"Hématurie"},{"fc":"FC03","num":"258","name":"Néphropathie glomérulaire"},{"fc":"FC04","num":"259","name":"Néphropathie vasculaire"},{"fc":"FC05","num":"260","name":"IRC"},{"fc":"FC06","num":"261","name":"IRA"},{"fc":"FC07","num":"262","name":"Troubles acido-basiques"},{"fc":"FC08","num":"263","name":"Hyperkaliémie Hypokaliémie"},{"fc":"FC09","num":"264","name":"Hyponatrémie Hypernatrémie"},{"fc":"FC10","num":"265","name":"Lithiase urinaire"},{"fc":"FC11","num":"266","name":"Hypercalcémie"},{"fc":"FC12","num":"267","name":"Diurétiques"},{"fc":"FC13","num":"310","name":"Tumeurs prostate"},{"fc":"FC14","num":"311","name":"Tumeur rein"},{"fc":"FC15","num":"161","name":"Infections urinaires"},{"fc":"FC16","num":"201","name":"Transplantation"}]},
  {"id":"infectiologie","name":"Infectiologie","items":[{"fc":"FC01","num":"145","name":"Surveillance maladies infectieuses"},{"fc":"FC02","num":"146","name":"Vaccinations"},{"fc":"FC03","num":"147","name":"Fièvre aiguë"},{"fc":"FC04","num":"148","name":"Méningites"},{"fc":"FC05","num":"149","name":"Endocardite"},{"fc":"FC06","num":"150","name":"Infections broncho-pulmonaires"},{"fc":"FC07","num":"151","name":"Infections cutanéo-muqueuses"},{"fc":"FC08","num":"152","name":"Infections ostéo-articulaires"},{"fc":"FC09","num":"153","name":"Infections urinaires"},{"fc":"FC10","num":"154","name":"IST"},{"fc":"FC11","num":"155","name":"Infections digestives"},{"fc":"FC12","num":"156","name":"Herpès virus"},{"fc":"FC13","num":"157","name":"VIH"},{"fc":"FC14","num":"158","name":"Paludisme"},{"fc":"FC15","num":"159","name":"Tuberculose"},{"fc":"FC16","num":"160","name":"Zoonoses"},{"fc":"FC17","num":"161","name":"Voyages"},{"fc":"FC18","num":"162","name":"Grippe"},{"fc":"FC19","num":"163","name":"Hépatites virales"},{"fc":"FC20","num":"172","name":"Anti-infectieux"}]},
  {"id":"dermatologie","name":"Dermatologie","items":[{"fc":"FC01","num":"109","name":"Dermatoses faciales"},{"fc":"FC02","num":"110","name":"Dermatose bulleuse"},{"fc":"FC03","num":"111","name":"Hémangiomes"},{"fc":"FC04","num":"112","name":"Exanthème érythrodermie"},{"fc":"FC05","num":"113","name":"Prurit"},{"fc":"FC06","num":"114","name":"Psoriasis"},{"fc":"FC07","num":"115","name":"Toxidermies"},{"fc":"FC08","num":"116","name":"Dermatoses eczématiformes"},{"fc":"FC09","num":"117","name":"Lupus cutané"},{"fc":"FC10","num":"118","name":"Maladies solaires"},{"fc":"FC11","num":"119","name":"Gale pédiculose"},{"fc":"FC12","num":"151","name":"Infections cutanées"},{"fc":"FC13","num":"164","name":"Herpès"},{"fc":"FC14","num":"300","name":"Tumeurs cutanées"},{"fc":"FC15","num":"345","name":"Grosse jambe rouge"},{"fc":"FC16","num":"228","name":"Ulcère jambe"}]},
  {"id":"therapeutique","name":"Thérapeutique","items":[{"fc":"FC01","num":"322","name":"Risques médicaments"},{"fc":"FC02","num":"323","name":"Études cliniques"},{"fc":"FC03","num":"324","name":"Thérapeutiques non médicamenteuses"},{"fc":"FC04","num":"325","name":"Bon usage médicament"},{"fc":"FC05","num":"326","name":"Médicaments courants"},{"fc":"FC06","num":"83","name":"Psychotropes"},{"fc":"FC07","num":"84","name":"Antithrombotiques"},{"fc":"FC08","num":"172","name":"Anti-infectieux"},{"fc":"FC09","num":"202","name":"Accidents iatrogènes"},{"fc":"FC10","num":"267","name":"Diurétiques"},{"fc":"FC11","num":"319","name":"Transfusion"},{"fc":"FC12","num":"320","name":"Douleur postopératoire"},{"fc":"FC13","num":"321","name":"Éducation thérapeutique"},{"fc":"FC14","num":"131","name":"Douleur"},{"fc":"FC15","num":"132","name":"Antalgiques"}]},
  {"id":"geriatrie","name":"Gériatrie - MPR","items":[{"fc":"FC01","num":"106","name":"Confusion démences"},{"fc":"FC02","num":"107","name":"Troubles marche équilibre"},{"fc":"FC03","num":"108","name":"Troubles cognitifs sujet âgé"},{"fc":"FC04","num":"126","name":"Personne âgée malade"},{"fc":"FC05","num":"127","name":"Déficit neurosensoriel"},{"fc":"FC06","num":"128","name":"Autonomie dépendance"},{"fc":"FC07","num":"129","name":"Troubles marche"},{"fc":"FC08","num":"130","name":"Chutes sujet âgé"},{"fc":"FC09","num":"119","name":"Vieillissement normal"},{"fc":"FC10","num":"120","name":"Ménopause andropause"},{"fc":"FC11","num":"123","name":"Ostéopathies fragilisantes"},{"fc":"FC12","num":"124","name":"Arthrose"},{"fc":"FC13","num":"118","name":"Rééducation réadaptation"},{"fc":"FC14","num":"359","name":"Fractures adulte sujet âgé"},{"fc":"FC15","num":"136","name":"Soins palliatifs"}]},
  {"id":"douleur","name":"Douleur - Soins palliatifs","items":[{"fc":"FC01","num":"131","name":"Douleur aiguë chronique"},{"fc":"FC02","num":"132","name":"Antalgiques"},{"fc":"FC03","num":"133","name":"Anesthésie"},{"fc":"FC04","num":"134","name":"Évaluation douleur"},{"fc":"FC05","num":"135","name":"Douleur enfant"},{"fc":"FC06","num":"136","name":"Soins palliatifs"},{"fc":"FC07","num":"137","name":"Repères cliniques palliatifs"},{"fc":"FC08","num":"138","name":"Sédation"},{"fc":"FC09","num":"139","name":"Palliatifs pédiatrie"},{"fc":"FC10","num":"140","name":"Palliatifs réanimation"},{"fc":"FC11","num":"141","name":"Deuil"},{"fc":"FC12","num":"320","name":"Douleur postopératoire"},{"fc":"FC13","num":"292","name":"Accompagnement cancéreux"},{"fc":"FC14","num":"14","name":"La mort"}]},
  {"id":"medecine-interne","name":"Médecine interne","items":[{"fc":"FC01","num":"185","name":"Réaction inflammatoire"},{"fc":"FC02","num":"186","name":"Fièvre prolongée"},{"fc":"FC03","num":"187","name":"Allergies cutanéo-muqueuses"},{"fc":"FC04","num":"188","name":"Allergies respiratoires"},{"fc":"FC05","num":"189","name":"Anaphylaxie"},{"fc":"FC06","num":"190","name":"Lupus"},{"fc":"FC07","num":"191","name":"Vascularites"},{"fc":"FC08","num":"192","name":"PR"},{"fc":"FC09","num":"193","name":"Spondyloarthrite"},{"fc":"FC10","num":"194","name":"Arthropathie microcristalline"},{"fc":"FC11","num":"195","name":"Raynaud"},{"fc":"FC12","num":"196","name":"Artérite cellules géantes"},{"fc":"FC13","num":"197","name":"Sarcoïdose"},{"fc":"FC14","num":"198","name":"Gougerot-Sjögren"},{"fc":"FC15","num":"199","name":"SDRC"},{"fc":"FC16","num":"200","name":"Déficit immunitaire"},{"fc":"FC17","num":"217","name":"Amylose"},{"fc":"FC18","num":"218","name":"Splénomégalie"}]},
  {"id":"oncologie","name":"Oncologie - Immunologie","items":[{"fc":"FC01","num":"290","name":"Épidémiologie cancers"},{"fc":"FC02","num":"291","name":"Traitements cancers"},{"fc":"FC03","num":"292","name":"Accompagnement cancéreux"},{"fc":"FC04","num":"293","name":"Agranulocytose"},{"fc":"FC05","num":"294","name":"Cancer enfant"},{"fc":"FC06","num":"295","name":"Tumeurs buccales"},{"fc":"FC07","num":"296","name":"Tumeurs intracrâniennes"},{"fc":"FC08","num":"297","name":"Tumeurs utérus"},{"fc":"FC09","num":"298","name":"Tumeurs colorectales"},{"fc":"FC10","num":"299","name":"Tumeurs cutanées"},{"fc":"FC11","num":"300","name":"Tumeurs estomac"},{"fc":"FC12","num":"301","name":"Tumeurs foie"},{"fc":"FC13","num":"302","name":"Tumeurs oesophage"},{"fc":"FC14","num":"303","name":"Tumeurs ovaire"},{"fc":"FC15","num":"304","name":"Tumeurs os"},{"fc":"FC16","num":"305","name":"Tumeurs pancréas"},{"fc":"FC17","num":"306","name":"Tumeurs poumon"},{"fc":"FC18","num":"307","name":"Tumeurs prostate"},{"fc":"FC19","num":"308","name":"Tumeurs rein"},{"fc":"FC20","num":"309","name":"Tumeurs sein"},{"fc":"FC21","num":"200","name":"Déficit immunitaire"},{"fc":"FC22","num":"201","name":"Transplantation"}]},
  {"id":"ophtalmologie","name":"Ophtalmologie","items":[{"fc":"FC01","num":"79","name":"Altération fonction visuelle"},{"fc":"FC02","num":"80","name":"Anomalie vision brutale"},{"fc":"FC03","num":"81","name":"Œil rouge douloureux"},{"fc":"FC04","num":"82","name":"Glaucome chronique"},{"fc":"FC05","num":"83","name":"Troubles réfraction"},{"fc":"FC06","num":"84","name":"Pathologie paupières"},{"fc":"FC07","num":"50","name":"Strabisme enfant"},{"fc":"FC08","num":"127","name":"Déficit neurosensoriel"},{"fc":"FC09","num":"100","name":"Diplopie"},{"fc":"FC10","num":"164","name":"Herpès"},{"fc":"FC11","num":"247","name":"Rétinopathie diabétique"},{"fc":"FC12","num":"224","name":"Rétinopathie hypertensive"}]},
  {"id":"urologie","name":"Urologie","items":[{"fc":"FC01","num":"125","name":"Troubles miction incontinence"},{"fc":"FC02","num":"126","name":"Troubles érection"},{"fc":"FC03","num":"127","name":"HBP"},{"fc":"FC04","num":"260","name":"Hématurie"},{"fc":"FC05","num":"265","name":"Lithiase urinaire"},{"fc":"FC06","num":"310","name":"Tumeurs prostate"},{"fc":"FC07","num":"311","name":"Tumeur rein"},{"fc":"FC08","num":"313","name":"Tumeurs testicule"},{"fc":"FC09","num":"314","name":"Tumeurs vésicales"},{"fc":"FC10","num":"347","name":"Rétention urine"},{"fc":"FC11","num":"36","name":"Contraception masculine"},{"fc":"FC12","num":"161","name":"Infections urinaires"},{"fc":"FC13","num":"201","name":"Transplantation"},{"fc":"FC14","num":"348","name":"IRA Anurie"}]},
  {"id":"medecine-legale","name":"MT - Médecine légale","items":[{"fc":"FC01","num":"05","name":"Responsabilités médicales"},{"fc":"FC02","num":"07","name":"Droits du patient"},{"fc":"FC03","num":"09","name":"Éthique médicale"},{"fc":"FC04","num":"11","name":"Violence et santé"},{"fc":"FC05","num":"12","name":"Violences sexuelles"},{"fc":"FC06","num":"13","name":"Certificats médicaux décès"},{"fc":"FC07","num":"14","name":"La mort"},{"fc":"FC08","num":"57","name":"Maltraitance enfants"},{"fc":"FC09","num":"182","name":"Environnement travail"},{"fc":"FC10","num":"183","name":"Services santé travail"},{"fc":"FC11","num":"184","name":"Accidents travail"}]},
  {"id":"sante-publique","name":"Santé publique","items":[{"fc":"FC01","num":"03","name":"Raisonnement décision médecine"},{"fc":"FC02","num":"04","name":"Infections associées soins"},{"fc":"FC03","num":"05","name":"Responsabilité médicale"},{"fc":"FC04","num":"06","name":"Organisation exercice clinique"},{"fc":"FC05","num":"08","name":"Discriminations santé"},{"fc":"FC06","num":"16","name":"Organisation système soins"},{"fc":"FC07","num":"17","name":"Télémédecine"},{"fc":"FC08","num":"18","name":"Santé numérique"},{"fc":"FC09","num":"19","name":"Protection sociale"},{"fc":"FC10","num":"20","name":"Recherche en santé"},{"fc":"FC11","num":"21","name":"Mesure état santé"},{"fc":"FC12","num":"145","name":"Surveillance maladies infectieuses"},{"fc":"FC13","num":"146","name":"Vaccinations"},{"fc":"FC14","num":"290","name":"Épidémiologie cancers"},{"fc":"FC15","num":"323","name":"Études cliniques"}]}
];

const TOTAL_ITEMS = SPECIALTIES_DATA.reduce((sum, s) => sum + s.items.length, 0);
const MAX_TOURS = 8;

const loader = document.getElementById('loader');
const header = document.getElementById('header');
const mobileMenuBtn = document.getElementById('mobile-menu-btn');
const mobileMenu = document.getElementById('mobile-menu');
const themeToggle = document.getElementById('theme-toggle');
const themeIcon = themeToggle.querySelector('i');
const backToTop = document.getElementById('back-to-top');
const userAuth = document.getElementById('user-auth');
const userAvatar = document.getElementById('user-avatar');
const avatarInitials = document.getElementById('avatar-initials');
const profileDropdown = document.getElementById('profile-dropdown');
const profileName = document.getElementById('profile-name');
const profileEmail = document.getElementById('profile-email');
const logoutBtn = document.getElementById('logout-btn');
const loginRequired = document.getElementById('login-required');
const mainContent = document.getElementById('main-content');
const savingIndicator = document.getElementById('saving-indicator');
const confidenceModal = document.getElementById('confidence-modal');
const statItemsDone = document.getElementById('stat-items-done');
const statToursDone = document.getElementById('stat-tours-done');
const statSpecialtiesDone = document.getElementById('stat-specialties-done');
const progressItems = document.getElementById('progress-items');
const progressTours = document.getElementById('progress-tours');

let currentUser = null;
let userData = null;
let unsubscribe = null;
let saveTimeout = null;
let currentSort = { field: 'num', direction: 'asc' };
let pendingTour = null;



currentUser = null

window.addEventListener('load', () => { setTimeout(() => { loader.style.opacity = '0'; setTimeout(() => loader.style.display = 'none', 500); }, 800); });

mobileMenuBtn?.addEventListener('click', () => {
    mobileMenu.classList.toggle('active');
    mobileMenuBtn.innerHTML = mobileMenu.classList.contains('active') ? '<i class="fas fa-times"></i>' : '<i class="fas fa-bars"></i>';
});

function setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
    themeIcon.classList.remove('fa-sun', 'fa-moon');
    themeIcon.classList.add(theme === 'dark' ? 'fa-moon' : 'fa-sun');
}
setTheme(localStorage.getItem('theme') || 'light');
themeToggle?.addEventListener('click', () => setTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'));

window.addEventListener('scroll', () => {
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    header?.classList.toggle('scrolled', scrollTop > 0);
    backToTop?.classList.toggle('visible', scrollTop > 600);
});
backToTop?.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

document.querySelectorAll('.app-nav-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.app-nav-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.app-page').forEach(p => p.classList.remove('active'));
        this.classList.add('active');
        document.getElementById('page-' + this.dataset.page).classList.add('active');
        
        // Scroll jusqu'aux boutons de navigation
        const appNav = document.querySelector('.app-nav');
        if (appNav) {
            const headerHeight = 70;
            const navPosition = appNav.getBoundingClientRect().top + window.pageYOffset - headerHeight - 10;
            window.scrollTo({ top: navPosition, behavior: 'smooth' });
        }
    });
});

function getInitials(name) {
    if (!name) return 'U';
    const names = name.trim().split(' ');
    return names.length >= 2 ? (names[0][0] + names[names.length-1][0]).toUpperCase() : name.substring(0,2).toUpperCase();
}

async function updateUserUI(user) {
    if (user) {
        currentUser = user;
        userAuth.classList.add('logged-in');
        loginRequired.style.display = 'none';
        mainContent.classList.add('active');
        try {
            const userDoc = await getDoc(doc(db, 'users', user.uid));
            const userInfo = userDoc.exists() ? userDoc.data() : {};
            const displayName = userInfo.displayName || user.displayName || 'Utilisateur';
            avatarInitials.textContent = getInitials(displayName);
            profileName.textContent = displayName;
            profileEmail.textContent = user.email || '';
            updateWelcomeMessage(displayName); // <-- Ajoute cette ligne
        } catch (e) {
            avatarInitials.textContent = getInitials(user.displayName || user.email);
            profileName.textContent = user.displayName || 'Utilisateur';
            profileEmail.textContent = user.email || '';
            updateWelcomeMessage(user.displayName || 'Utilisateur'); // <-- Ajoute cette ligne aussi
        }
        loadUserData(user.uid);
    } else {
        currentUser = null;
        userAuth.classList.remove('logged-in');
        loginRequired.style.display = 'block';
        mainContent.classList.remove('active');
        if (unsubscribe) { unsubscribe(); unsubscribe = null; }
    }
}

onAuthStateChanged(auth, updateUserUI);


userAvatar?.addEventListener('click', e => { e.stopPropagation(); profileDropdown.classList.toggle('active'); });
document.addEventListener('click', e => { if (profileDropdown && !profileDropdown.contains(e.target) && !userAvatar?.contains(e.target)) profileDropdown.classList.remove('active'); });
logoutBtn?.addEventListener('click', async () => { try { await signOut(auth); profileDropdown.classList.remove('active'); } catch (e) { console.error(e); } });

function initializeUserData() { return { items: {}, lastUpdated: new Date().toISOString() }; }

function loadUserData(userId) {
    if (userId) {
        // Utilisateur connecté → Firebase
        unsubscribe = onSnapshot(doc(db, 'planningRevision', userId), docSnap => {
            userData = docSnap.exists() ? docSnap.data() : initializeUserData();
            if (!docSnap.exists()) saveUserData();
            localStorage.setItem('planningRevision_backup', JSON.stringify(userData));
            renderAll();
        }, e => { console.error(e); userData = initializeUserData(); renderAll(); });
    } else {
        // Pas connecté → localStorage
        const saved = localStorage.getItem('planningRevision_local');
        userData = saved ? JSON.parse(saved) : initializeUserData();
        renderAll();
    }
}

async function saveUserData() {
    if (!currentUser || !userData) return;
    savingIndicator.classList.add('visible');
    savingIndicator.innerHTML = '<i class="fas fa-spinner"></i><span>Sauvegarde...</span>';
    try {
        userData.lastUpdated = new Date().toISOString();
        await setDoc(doc(db, 'planningRevision', currentUser.uid), userData);
        savingIndicator.innerHTML = '<i class="fas fa-check"></i><span>Sauvegardé</span>';
        savingIndicator.classList.add('saved');
        setTimeout(() => savingIndicator.classList.remove('visible', 'saved'), 1500);
    } catch (e) {
        console.error(e);
        savingIndicator.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Erreur</span>';
        setTimeout(() => savingIndicator.classList.remove('visible'), 2000);
    }
}

function debouncedSave() { if (saveTimeout) clearTimeout(saveTimeout); saveTimeout = setTimeout(saveUserData, 1000); }

function getItemKey(sId, fc) { return sId + '-' + fc; }

function getItemData(sId, fc) {
    const key = getItemKey(sId, fc);
    if (!userData.items[key]) userData.items[key] = { tours: [null,null,null,null,null,null,null,null], tourDates: [null,null,null,null,null,null,null,null], tourDurations: [null,null,null,null,null,null,null,null], tourSupports: [null,null,null,null,null,null,null,null], resources: { edni: false, hypocampus: false, fichesPerso: false, anki: false }, lastRevision: null };
    const d = userData.items[key];
    if (d.tours && typeof d.tours[0] === 'boolean') d.tours = d.tours.map(t => t ? 3 : null);
    if (!d.tourDates) d.tourDates = [null,null,null,null,null,null,null,null];
    if (!d.tourDurations) d.tourDurations = [null,null,null,null,null,null,null,null];
    if (!d.tourSupports) d.tourSupports = [null,null,null,null,null,null,null,null];
    if (!d.resources) d.resources = { edni: false, hypocampus: false, fichesPerso: false, anki: false };
    return d;
}

function calculateStats() {
    let itemsWithOneTour = 0, totalTours = 0, specialtiesComplete = 0;
    let totalMinutes = 0;
    
    SPECIALTIES_DATA.forEach(s => {
        let allSeen = true;
        s.items.forEach(item => {
            const d = getItemData(s.id, item.fc);
            const tc = d.tours.filter(t => t !== null).length;
            if (tc > 0) itemsWithOneTour++; else allSeen = false;
            totalTours += tc;
            
            if (d.tourDurations) {
                d.tourDurations.forEach(dur => {
                    if (dur) {
                        const parts = dur.split(':');
                        const hours = parseInt(parts[0]) || 0;
                        const minutes = parseInt(parts[1]) || 0;
                        totalMinutes += hours * 60 + minutes;
                    }
                });
            }
        });
        if (allSeen && s.items.length > 0) specialtiesComplete++;
    });
    
    return { itemsWithOneTour, totalTours, specialtiesComplete, maxTours: TOTAL_ITEMS * MAX_TOURS, totalMinutes };
}

function calculateDailyStats() {
    const today = new Date();
    const todayStr = today.getFullYear() + '-' + 
                     String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                     String(today.getDate()).padStart(2, '0');
    
    let toursToday = 0;
    let delayCaught = 0;
    let minutesToday = 0;
    let feelingsToday = [];
    
    SPECIALTIES_DATA.forEach(s => {
        s.items.forEach(item => {
            const d = getItemData(s.id, item.fc);
            
            if (d.tourDates) {
                // Chercher si cet item a été révisé aujourd'hui
                let revisedToday = false;
                let lastDateBeforeToday = null;
                
                d.tourDates.forEach((dateStr, i) => {
                    if (dateStr) {
                        const tourDateStr = dateStr.split('T')[0];
                        
                        if (tourDateStr === todayStr) {
                            // Tour fait aujourd'hui
                            revisedToday = true;
                            toursToday++;
                            
                            // Temps aujourd'hui
                            if (d.tourDurations && d.tourDurations[i]) {
                                const parts = d.tourDurations[i].split(':');
                                const hours = parseInt(parts[0]) || 0;
                                const minutes = parseInt(parts[1]) || 0;
                                minutesToday += hours * 60 + minutes;
                            }
                            
                            // Ressenti du jour
                            if (d.tours[i]) {
                                feelingsToday.push(d.tours[i]);
                            }
                        } else {
                            // Tour fait avant aujourd'hui - garder la date la plus récente
                            const tourDate = new Date(dateStr);
                            if (!lastDateBeforeToday || tourDate > lastDateBeforeToday) {
                                lastDateBeforeToday = tourDate;
                            }
                        }
                    }
                });
                
                // Calculer le retard rattrapé pour cet item
                if (revisedToday && lastDateBeforeToday) {
                    const todayDate = new Date(todayStr);
                    const daysSinceLastRevision = Math.floor((todayDate - lastDateBeforeToday) / (1000 * 60 * 60 * 24));
                    if (daysSinceLastRevision > 0) {
                        delayCaught += daysSinceLastRevision;
                    }
                }
            }
        });
    });
    
    const avgFeeling = feelingsToday.length > 0 
        ? Math.round((feelingsToday.reduce((a, b) => a + b, 0) / feelingsToday.length) * 10) / 10
        : null;
    
    return { toursToday, delayCaught, minutesToday, avgFeeling };
}

function formatTime(minutes) {
    const h = Math.floor(minutes / 60);
    const m = minutes % 60;
    return h + 'h' + m.toString().padStart(2, '0');
}

function getSpecialtyProgress(s) {
    let itemsSeen = 0, totalTours = 0;
    s.items.forEach(item => {
        const d = getItemData(s.id, item.fc);
        const tc = d.tours.filter(t => t !== null).length;
        if (tc > 0) itemsSeen++;
        totalTours += tc;
    });
    return { itemsSeen, totalItems: s.items.length, totalTours, percentage: s.items.length > 0 ? Math.round((itemsSeen / s.items.length) * 100) : 0 };
}

function getDaysSince(dateStr) {
    if (!dateStr) return null;
    return Math.floor(Math.abs(new Date() - new Date(dateStr)) / (1000 * 60 * 60 * 24));
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    return new Date(dateStr).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
}

function renderAll() {
    if (!userData) return;
    renderStats();
    renderDashboardSpecialties();
    renderItemsTable();
    populateFilters();
	if (typeof initWeeklyCharts === 'function') initWeeklyCharts();

}

function renderStats() {
    const stats = calculateStats();
    const dailyStats = calculateDailyStats();
    
    // Stats générales
    statItemsDone.textContent = stats.itemsWithOneTour;
    statToursDone.textContent = stats.totalTours;
    statSpecialtiesDone.textContent = stats.specialtiesComplete;
    progressItems.style.width = Math.round((stats.itemsWithOneTour / TOTAL_ITEMS) * 100) + '%';
    progressTours.style.width = Math.round((stats.totalTours / stats.maxTours) * 100) + '%';
    
    // Temps total
    const statTotalTime = document.getElementById('stat-total-time');
    if (statTotalTime) statTotalTime.textContent = formatTime(stats.totalMinutes);
    
    // Stats quotidiennes
    const statItemsToday = document.getElementById('stat-items-today');
    const statDelayCaught = document.getElementById('stat-delay-caught');
    const statTimeToday = document.getElementById('stat-time-today');
    const statFeelingToday = document.getElementById('stat-feeling-today');
    const feelingIndicator = document.getElementById('feeling-indicator');
    
    if (statItemsToday) statItemsToday.textContent = dailyStats.toursToday;
    if (statDelayCaught) statDelayCaught.innerHTML = dailyStats.delayCaught + '<span class="daily-stat-unit">jours</span>';
    if (statTimeToday) statTimeToday.textContent = formatTime(dailyStats.minutesToday);
    
    if (statFeelingToday) {
        statFeelingToday.textContent = dailyStats.avgFeeling !== null ? dailyStats.avgFeeling.toFixed(1) + '/5' : '--';
    }
    
    if (feelingIndicator) {
        const dots = feelingIndicator.querySelectorAll('.feeling-dot');
        dots.forEach(dot => dot.classList.remove('active', 'c1', 'c2', 'c3', 'c4', 'c5'));
        
        if (dailyStats.avgFeeling !== null) {
            const roundedFeeling = Math.round(dailyStats.avgFeeling);
            dots.forEach(dot => {
                const level = parseInt(dot.dataset.level);
                if (level <= roundedFeeling) dot.classList.add('active', 'c' + roundedFeeling);
            });
        }
    }
}

function renderDashboardSpecialties() {
    const container = document.getElementById('dashboard-specialties');
    container.innerHTML = SPECIALTIES_DATA.map(s => {
        const cfg = SPECIALTY_CONFIG[s.id] || { color: '#6b7280', icon: 'fa-book-medical' };
        const prog = getSpecialtyProgress(s);
        return '<div class="specialty-card" onclick="navigateToSpecialty(\'' + s.id + '\')" style="border-left: 4px solid ' + cfg.color + ';">' +
            '<div class="specialty-header"><span class="specialty-name"><span class="specialty-icon" style="background:' + cfg.color + ';"><i class="fas ' + cfg.icon + '"></i></span>' + s.name + '</span><span class="specialty-badge" style="background:' + cfg.color + ';">' + s.items.length + '</span></div>' +
            '<div class="specialty-stats"><span class="specialty-stat ' + (prog.percentage === 100 ? 'completed' : '') + '"><i class="fas fa-check-circle"></i> ' + prog.itemsSeen + '/' + prog.totalItems + ' items</span><span class="specialty-stat"><i class="fas fa-redo"></i> ' + prog.totalTours + ' tours</span></div>' +
            '<div class="specialty-progress"><div class="progress-bar"><div class="progress-fill" style="width:' + prog.percentage + '%;background:linear-gradient(135deg,' + cfg.color + ',' + cfg.color + 'dd);"></div></div></div></div>';
    }).join('');
}

function renderItemsTable() {
    const tbody = document.getElementById('items-table-body');
    const emptyState = document.getElementById('items-empty');
    const searchTerm = (document.getElementById('search-item')?.value || '').toLowerCase();
    const filterSpecialty = document.getElementById('filter-item-specialty')?.value || 'all';
    const filterStatus = document.getElementById('filter-item-status')?.value || 'all';
    
    let allItems = [];
    SPECIALTIES_DATA.forEach(s => {
        s.items.forEach(item => {
            const d = getItemData(s.id, item.fc);
            const lastDate = d.tourDates.filter(x => x).pop() || d.lastRevision;
            allItems.push({ ...item, specialtyId: s.id, specialtyName: s.name, daysSince: getDaysSince(lastDate), toursCompleted: d.tours.filter(t => t !== null).length });
        });
    });
    
    let filtered = allItems.filter(item => {
        const matchSearch = item.name.toLowerCase().includes(searchTerm) || item.num.includes(searchTerm);
        const matchSpec = filterSpecialty === 'all' || item.specialtyId === filterSpecialty;
        let matchStatus = true;
        if (filterStatus === 'not-started') matchStatus = item.toursCompleted === 0;
        else if (filterStatus === 'in-progress') matchStatus = item.toursCompleted > 0 && item.toursCompleted < MAX_TOURS;
        else if (filterStatus === 'completed') matchStatus = item.toursCompleted === MAX_TOURS;
        return matchSearch && matchSpec && matchStatus;
    });
    
    filtered.sort((a, b) => {
        let cmp = 0;
        if (currentSort.field === 'num') cmp = parseInt(a.num) - parseInt(b.num);
        else if (currentSort.field === 'name') cmp = a.name.localeCompare(b.name);
        else if (currentSort.field === 'specialty') cmp = a.specialtyName.localeCompare(b.specialtyName);
        else if (currentSort.field === 'days') cmp = (a.daysSince ?? 9999) - (b.daysSince ?? 9999);
        return currentSort.direction === 'desc' ? -cmp : cmp;
    });
    
    if (filtered.length === 0) { tbody.innerHTML = ''; emptyState.style.display = 'block'; return; }
    emptyState.style.display = 'none';
    
    tbody.innerHTML = filtered.map(item => {
        const d = getItemData(item.specialtyId, item.fc);
        
const tourBadges = d.tours.map((c, i) => {
    const duration = d.tourDurations ? d.tourDurations[i] : null;
    const support = d.tourSupports ? d.tourSupports[i] : null;
    const supportLabels = { qcm: 'QCM', college: 'COL', anki: 'ANK', perso: 'PER', codex: 'COD', conf: 'CNF' };
    
    // Trouver l'index du dernier tour fait
    const lastDoneIndex = d.tours.reduce((last, t, idx) => t !== null ? idx : last, -1);
    const nextTourIndex = lastDoneIndex + 1;
    
    // Un tour est éditable si c'est le dernier fait OU le prochain à faire
    const isEditable = (c !== null && i === lastDoneIndex) || (c === null && i === nextTourIndex);
    
    // Un tour est locked (grisé) si non fait ET pas le prochain
    const isLocked = c === null && i !== nextTourIndex;
    
    let info = '';
    if (c) {
        info = '<div class="tour-info">';
        if (duration) info += '<span class="tour-duration">' + duration + '</span>';
        if (support) info += '<span class="tour-support ' + support + '">' + supportLabels[support] + '</span>';
        info += '</div>';
    }
    
    if (isLocked) {
        return '<div class="tour-badge-wrapper"><span class="tour-badge locked">T' + (i + 1) + '</span></div>';
    }
    
    if (isEditable) {
        return '<div class="tour-badge-wrapper"><span class="tour-badge ' + (c ? 'c' + c : '') + '" data-specialty="' + item.specialtyId + '" data-fc="' + item.fc + '" data-tour="' + i + '" onclick="openConfidenceModal(this)">T' + (i + 1) + '</span>' + info + '</div>';
    }
    
    // Tour fait mais pas le dernier → affiché avec couleur mais non cliquable
    return '<div class="tour-badge-wrapper"><span class="tour-badge ' + (c ? 'c' + c : '') + '" style="cursor: default;">T' + (i + 1) + '</span>' + info + '</div>';
}).join('');

        const tourDates = d.tourDates.map(dt => '<span class="tour-date">' + formatDate(dt) + '</span>').join('');
        const days = item.daysSince;
        let daysBadge = '<span class="days-badge never">Jamais</span>';
        if (days !== null) {
            if (days <= 7) daysBadge = '<span class="days-badge recent">' + days + 'j</span>';
            else if (days <= 30) daysBadge = '<span class="days-badge moderate">' + days + 'j</span>';
            else daysBadge = '<span class="days-badge old">' + days + 'j</span>';
        }
        const res = d.resources;
        const resourcesHtml = '<label class="resource-check ' + (res.edni ? 'checked' : '') + '"><input type="checkbox" ' + (res.edni ? 'checked' : '') + ' onchange="toggleResource(\'' + item.specialtyId + '\',\'' + item.fc + '\',\'edni\',this.checked)"> QCM EDNi</label>' +
            '<label class="resource-check ' + (res.hypocampus ? 'checked' : '') + '"><input type="checkbox" ' + (res.hypocampus ? 'checked' : '') + ' onchange="toggleResource(\'' + item.specialtyId + '\',\'' + item.fc + '\',\'hypocampus\',this.checked)"> QCM Hypo</label>' +
            '<label class="resource-check ' + (res.fichesPerso ? 'checked' : '') + '"><input type="checkbox" ' + (res.fichesPerso ? 'checked' : '') + ' onchange="toggleResource(\'' + item.specialtyId + '\',\'' + item.fc + '\',\'fichesPerso\',this.checked)"> Fiches Perso</label>' +
            '<label class="resource-check ' + (res.anki ? 'checked' : '') + '"><input type="checkbox" ' + (res.anki ? 'checked' : '') + ' onchange="toggleResource(\'' + item.specialtyId + '\',\'' + item.fc + '\',\'anki\',this.checked)"> Anki</label>';
        
        const specCfg = SPECIALTY_CONFIG[item.specialtyId] || { color: '#6b7280' };
        return '<tr><td class="item-num">' + item.num + '</td><td class="item-name">' + item.name + '</td><td class="item-specialty" style="background-color:' + specCfg.color + '20; color:' + specCfg.color + '; font-weight: 500;">' + item.specialtyName + '</td>' +
            '<td class="tour-cell"><div class="tour-badges">' + tourBadges + '</div><div class="tour-dates">' + tourDates + '</div></td>' +
            '<td class="resources-cell">' + resourcesHtml + '</td><td class="days-cell">' + daysBadge + '</td></tr>';
    }).join('');
}

// ===== CUSTOM SELECT DROPDOWNS =====
function initCustomSelects() {
    // Peupler le menu des spécialités
    const specialtyMenu = document.getElementById('specialty-menu');
    if (specialtyMenu && typeof SPECIALTIES_DATA !== 'undefined') {
        let optionsHtml = '<div class="custom-select-option selected" data-value="all"><span class="option-icon"><i class="fas fa-list"></i></span><span>Toutes les spécialités</span></div>';
        SPECIALTIES_DATA.forEach(s => {
            const cfg = SPECIALTY_CONFIG[s.id] || { icon: 'fa-folder', color: '#6b7280' };
            optionsHtml += '<div class="custom-select-option" data-value="' + s.id + '"><span class="option-icon" style="color:' + cfg.color + '"><i class="fas ' + cfg.icon + '"></i></span><span>' + s.name + '</span></div>';
        });
        specialtyMenu.innerHTML = optionsHtml;
    }

    // Gestion ouverture/fermeture
    document.querySelectorAll('.custom-select-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const parent = this.closest('.custom-select');
            const wasOpen = parent.classList.contains('open');
            
            // Fermer tous les autres
            document.querySelectorAll('.custom-select').forEach(s => s.classList.remove('open'));
            
            if (!wasOpen) {
                parent.classList.add('open');
            }
        });
    });

    // Gestion sélection d'option
    document.querySelectorAll('.custom-select-menu').forEach(menu => {
        menu.addEventListener('click', function(e) {
            const option = e.target.closest('.custom-select-option');
            if (!option) return;
            
            const parent = this.closest('.custom-select');
            const value = option.dataset.value;
            const text = option.querySelector('span:last-child').textContent;
            const iconHtml = option.querySelector('.option-icon').innerHTML;
            
            // Mettre à jour le bouton
            parent.querySelector('.custom-select-text').textContent = text;
            parent.querySelector('.custom-select-icon').innerHTML = iconHtml;
            
            // Mettre à jour la classe selected
            this.querySelectorAll('.custom-select-option').forEach(o => o.classList.remove('selected'));
            option.classList.add('selected');
            
            // Mettre à jour l'input hidden
            parent.querySelector('input[type="hidden"]').value = value;
            
            // Fermer le menu
            parent.classList.remove('open');
            
            // Déclencher le rendu
            renderItemsTable();
        });
    });

    // Fermer au clic extérieur
    document.addEventListener('click', function() {
        document.querySelectorAll('.custom-select').forEach(s => s.classList.remove('open'));
    });
}

// Appeler après le chargement des données
setTimeout(initCustomSelects, 500);



function populateFilters() {
    const specialtyMenu = document.getElementById('specialty-menu');
    const customSelect = document.getElementById('specialty-dropdown');
    if (!specialtyMenu || !customSelect) return;
    
    // IMPORTANT : le bon ID est filter-item-specialty
    const filterInput = document.getElementById('filter-item-specialty');
    const currentValue = filterInput ? filterInput.value : 'all';
    
    // Reconstruire les options du menu
    let optionsHtml = '';
    optionsHtml += '<div class="custom-select-option' + (currentValue === 'all' ? ' selected' : '') + '" data-value="all"><span class="option-icon"><i class="fas fa-list"></i></span><span>Toutes les spécialités</span></div>';
    
    SPECIALTIES_DATA.forEach(s => {
        const cfg = SPECIALTY_CONFIG[s.id] || { icon: 'fa-folder', color: '#6b7280' };
        const isSelected = (currentValue === s.id) ? ' selected' : '';
        optionsHtml += '<div class="custom-select-option' + isSelected + '" data-value="' + s.id + '"><span class="option-icon" style="color:' + cfg.color + '"><i class="fas ' + cfg.icon + '"></i></span><span>' + s.name + '</span></div>';
    });
    
    specialtyMenu.innerHTML = optionsHtml;
    
    // Mettre à jour le bouton affiché
    const selectText = customSelect.querySelector('.custom-select-text');
    const selectIcon = customSelect.querySelector('.custom-select-icon');
    
    if (currentValue === 'all') {
        selectText.textContent = 'Toutes les spécialités';
        selectIcon.innerHTML = '<i class="fas fa-list"></i>';
    } else {
        const spec = SPECIALTIES_DATA.find(s => s.id === currentValue);
        if (spec) {
            const cfg = SPECIALTY_CONFIG[spec.id] || { icon: 'fa-folder', color: '#6b7280' };
            selectText.textContent = spec.name;
            selectIcon.innerHTML = '<i class="fas ' + cfg.icon + '" style="color:' + cfg.color + '"></i>';
        }
    }
}

let selectedConfidence = null;
let selectedSupport = null;

window.openConfidenceModal = function(el) {
    pendingTour = { specialtyId: el.dataset.specialty, fc: el.dataset.fc, tour: parseInt(el.dataset.tour) };
    
    const d = getItemData(pendingTour.specialtyId, pendingTour.fc);
    const tourIndex = pendingTour.tour;
    
    selectedConfidence = d.tours[tourIndex];
    selectedSupport = d.tourSupports ? d.tourSupports[tourIndex] : null;
    
    // Reset UI
    document.querySelectorAll('.confidence-btn').forEach(b => b.classList.remove('selected'));
    document.querySelectorAll('.support-btn').forEach(b => b.classList.remove('selected'));
    
    if (selectedConfidence) {
        document.querySelector('.confidence-btn[data-confidence="' + selectedConfidence + '"]')?.classList.add('selected');
    }
    if (selectedSupport) {
        document.querySelector('.support-btn[data-support="' + selectedSupport + '"]')?.classList.add('selected');
    }
    
    // Date : existante ou aujourd'hui
    const dateInput = document.getElementById('tour-date');
    if (d.tourDates && d.tourDates[tourIndex]) {
        dateInput.value = d.tourDates[tourIndex].split('T')[0];
    } else {
        dateInput.value = new Date().toISOString().split('T')[0];
    }
    
    // Durée
    const existingDuration = d.tourDurations ? d.tourDurations[tourIndex] : null;
    if (existingDuration) {
        const parts = existingDuration.split(':');
        document.getElementById('tour-duration-hours').value = parseInt(parts[0]) || '';
        document.getElementById('tour-duration-minutes').value = parts[1] || '';
    } else {
        document.getElementById('tour-duration-hours').value = '';
        document.getElementById('tour-duration-minutes').value = '';
    }
    
    confidenceModal.classList.add('active');
};

document.querySelectorAll('.confidence-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        selectedConfidence = parseInt(this.dataset.confidence);
        document.querySelectorAll('.confidence-btn').forEach(b => b.classList.remove('selected'));
        this.classList.add('selected');
    });
});

document.querySelectorAll('.support-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        selectedSupport = this.dataset.support;
        document.querySelectorAll('.support-btn').forEach(b => b.classList.remove('selected'));
        this.classList.add('selected');
    });
});

document.getElementById('btn-save-tour')?.addEventListener('click', function() {
    if (!pendingTour || !selectedConfidence) return;
    
    const d = getItemData(pendingTour.specialtyId, pendingTour.fc);
    const tourIndex = pendingTour.tour;
    
    if (!d.tourDurations) d.tourDurations = [null,null,null,null,null,null,null,null];
    if (!d.tourSupports) d.tourSupports = [null,null,null,null,null,null,null,null];
    
    d.tours[tourIndex] = selectedConfidence;
    
    // Date personnalisée
    const dateInput = document.getElementById('tour-date');
    const selectedDate = dateInput.value ? new Date(dateInput.value).toISOString() : new Date().toISOString();
    d.tourDates[tourIndex] = selectedDate;
    
    // Durée
    const hours = document.getElementById('tour-duration-hours').value || '0';
    const minutes = document.getElementById('tour-duration-minutes').value || '00';
    d.tourDurations[tourIndex] = hours + ':' + minutes.padStart(2, '0');
    
    d.tourSupports[tourIndex] = selectedSupport;
    d.lastRevision = selectedDate;
    
    confidenceModal.classList.remove('active');
    pendingTour = null;
    selectedConfidence = null;
    selectedSupport = null;
    debouncedSave();
    renderAll();
});

document.getElementById('btn-reset-tour')?.addEventListener('click', function() {
    if (!pendingTour) return;
    
    const d = getItemData(pendingTour.specialtyId, pendingTour.fc);
    const tourIndex = pendingTour.tour;
    
    d.tours[tourIndex] = null;
    d.tourDates[tourIndex] = null;
    if (d.tourDurations) d.tourDurations[tourIndex] = null;
    if (d.tourSupports) d.tourSupports[tourIndex] = null;
    
    const remainingDates = d.tourDates.filter(x => x);
    d.lastRevision = remainingDates.length > 0 ? remainingDates[remainingDates.length - 1] : null;
    
    confidenceModal.classList.remove('active');
    pendingTour = null;
    selectedConfidence = null;
    selectedSupport = null;
    debouncedSave();
    renderAll();
});

document.getElementById('confidence-close')?.addEventListener('click', () => { 
    confidenceModal.classList.remove('active'); 
    pendingTour = null; 
    selectedConfidence = null;
    selectedSupport = null;
});

confidenceModal?.addEventListener('click', e => { 
    if (e.target === confidenceModal) { 
        confidenceModal.classList.remove('active'); 
        pendingTour = null;
        selectedConfidence = null;
        selectedSupport = null;
    } 
});


window.toggleResource = function(sId, fc, resource, checked) {
    const d = getItemData(sId, fc);
    d.resources[resource] = checked;
    debouncedSave();
    renderItemsTable();
};

window.navigateToSpecialty = function(sId) {
    document.querySelectorAll('.app-nav-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.app-page').forEach(p => p.classList.remove('active'));
    document.querySelector('[data-page="items"]').classList.add('active');
    document.getElementById('page-items').classList.add('active');
    
    // Mettre à jour l'input hidden
    const select = document.getElementById('filter-item-specialty');
    if (select) { select.value = sId; }
    
    // Mettre à jour le dropdown personnalisé
    const specialtyDropdown = document.getElementById('specialty-dropdown');
    if (specialtyDropdown) {
        // Trouver la spécialité correspondante
        const specialty = SPECIALTIES_DATA.find(s => s.id === sId);
        const cfg = SPECIALTY_CONFIG[sId] || { icon: 'fa-folder', color: '#6b7280' };
        
        // Mettre à jour le texte et l'icône du bouton
        specialtyDropdown.querySelector('.custom-select-text').textContent = specialty ? specialty.name : 'Toutes les spécialités';
        specialtyDropdown.querySelector('.custom-select-icon').innerHTML = '<i class="fas ' + cfg.icon + '" style="color:' + cfg.color + '"></i>';
        
        // Mettre à jour la sélection dans le menu
        specialtyDropdown.querySelectorAll('.custom-select-option').forEach(opt => {
            opt.classList.remove('selected');
            if (opt.dataset.value === sId) {
                opt.classList.add('selected');
            }
        });
    }
    
renderItemsTable();
    
    // Scroll jusqu'aux boutons de navigation
    const appNav = document.querySelector('.app-nav');
    if (appNav) {
        const headerHeight = 70;
        const navPosition = appNav.getBoundingClientRect().top + window.pageYOffset - headerHeight - 10;
        window.scrollTo({ top: navPosition, behavior: 'smooth' });
    }
};

document.querySelectorAll('.items-table th[data-sort]').forEach(th => {
    th.addEventListener('click', function() {
        const field = this.dataset.sort;
        if (currentSort.field === field) currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        else { currentSort.field = field; currentSort.direction = 'asc'; }
        document.querySelectorAll('.items-table th').forEach(h => h.classList.remove('sorted'));
        this.classList.add('sorted');
        renderItemsTable();
    });
});

document.getElementById('search-item')?.addEventListener('input', renderItemsTable);
document.getElementById('filter-item-specialty')?.addEventListener('change', renderItemsTable);
document.getElementById('filter-item-status')?.addEventListener('change', renderItemsTable);
document.getElementById('btn-reset-filters')?.addEventListener('click', () => {
    // Reset search
    document.getElementById('search-item').value = '';
    
    // Reset specialty dropdown
    document.getElementById('filter-item-specialty').value = 'all';
    const specialtyDropdown = document.getElementById('specialty-dropdown');
    if (specialtyDropdown) {
        specialtyDropdown.querySelector('.custom-select-text').textContent = 'Toutes les spécialités';
        specialtyDropdown.querySelector('.custom-select-icon').innerHTML = '<i class="fas fa-list"></i>';
        specialtyDropdown.querySelectorAll('.custom-select-option').forEach(o => o.classList.remove('selected'));
        specialtyDropdown.querySelector('[data-value="all"]').classList.add('selected');
    }
    
    // Reset status dropdown
    document.getElementById('filter-item-status').value = 'all';
    const statusDropdown = document.getElementById('status-dropdown');
    if (statusDropdown) {
        statusDropdown.querySelector('.custom-select-text').textContent = 'Tous les statuts';
        statusDropdown.querySelector('.custom-select-icon').innerHTML = '<i class="fas fa-tasks"></i>';
        statusDropdown.querySelectorAll('.custom-select-option').forEach(o => o.classList.remove('selected'));
        statusDropdown.querySelector('[data-value="all"]').classList.add('selected');
    }
    
renderItemsTable();
    
    // Scroll jusqu'aux boutons de navigation
    const appNav = document.querySelector('.app-nav');
    if (appNav) {
        const headerHeight = 70;
        const navPosition = appNav.getBoundingClientRect().top + window.pageYOffset - headerHeight - 10;
        window.scrollTo({ top: navPosition, behavior: 'smooth' });
    }
});


// ===== GRAPHIQUES HEBDOMADAIRES =====
let chartToursWeekly, chartTimeWeekly, chartFeelingWeekly;

function getLast7Days() {
    const days = [];
    const labels = [];
    for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        days.push(date.toISOString().split('T')[0]);
        labels.push(date.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric' }));
    }
    return { days, labels };
}

function getWeeklyData() {
    const { days, labels } = getLast7Days();
    const toursPerDay = {};
    const timePerDay = {};
    const feelingsPerDay = {};
    
    // Initialiser tous les jours à 0
    days.forEach(day => {
        toursPerDay[day] = 0;
        timePerDay[day] = 0;
        feelingsPerDay[day] = [];
    });
    
    // Parcourir toutes les données
    SPECIALTIES_DATA.forEach(specialty => {
        specialty.items.forEach(item => {
            const fc = item.fc || item.num;
            const d = getItemData(specialty.id, fc);
            
            if (d.tourDates) {
                d.tourDates.forEach((dateStr, idx) => {
                    if (!dateStr) return;
                    const day = dateStr.split('T')[0];
                    
                    if (toursPerDay.hasOwnProperty(day)) {
                        // Compter les tours
                        toursPerDay[day]++;
                        
                        // Temps de travail
                        if (d.tourDurations && d.tourDurations[idx]) {
                            const parts = d.tourDurations[idx].split(':');
                            const hours = parseInt(parts[0]) || 0;
                            const mins = parseInt(parts[1]) || 0;
                            timePerDay[day] += hours * 60 + mins;
                        }
                        
                        // Ressenti
                        if (d.tours[idx]) {
                            feelingsPerDay[day].push(d.tours[idx]);
                        }
                    }
                });
            }
        });
    });
    
    // Convertir en tableaux
    const toursData = days.map(d => toursPerDay[d]);
    const timeData = days.map(d => Math.round(timePerDay[d] / 60 * 10) / 10); // en heures
    const feelingData = days.map(d => {
        const arr = feelingsPerDay[d];
        if (arr.length === 0) return null;
        return Math.round((arr.reduce((a, b) => a + b, 0) / arr.length) * 10) / 10;
    });
    
    // Totaux
    const totalTours = toursData.reduce((a, b) => a + b, 0);
    const totalTime = timeData.reduce((a, b) => a + b, 0);
    const allFeelings = days.flatMap(d => feelingsPerDay[d]);
    const avgFeeling = allFeelings.length > 0 
        ? Math.round((allFeelings.reduce((a, b) => a + b, 0) / allFeelings.length) * 10) / 10 
        : null;
    
    return { labels, toursData, timeData, feelingData, totalTours, totalTime, avgFeeling };
}

function createChartConfig(label, data, color, yAxisConfig = {}) {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.06)';
    const textColor = isDark ? '#9ca3af' : '#6b7280';
    
    return {
        type: 'line',
        data: {
            labels: data.labels,
            datasets: [{
                label: label,
                data: data.values,
                borderColor: color,
                backgroundColor: color + '20',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: color,
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointHoverBackgroundColor: color,
                pointHoverBorderColor: '#fff',
                pointHoverBorderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: isDark ? '#1e293b' : '#fff',
                    titleColor: isDark ? '#f9fafb' : '#111827',
                    bodyColor: isDark ? '#d1d5db' : '#4b5563',
                    borderColor: isDark ? '#374151' : '#e5e7eb',
                    borderWidth: 1,
                    padding: 12,
                    cornerRadius: 8,
                    displayColors: false,
                    titleFont: { weight: '600', size: 13 },
                    bodyFont: { size: 12 },
                    callbacks: {
                        label: function(context) {
                            return label + ' : ' + (context.parsed.y !== null ? context.parsed.y : '--') + (yAxisConfig.unit || '');
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: textColor,
                        font: { size: 11, weight: '500' }
                    }
                },
                y: {
                    beginAtZero: true,
                    ...yAxisConfig,
                    grid: {
                        color: gridColor,
                        drawBorder: false
                    },
                    ticks: {
                        color: textColor,
                        font: { size: 11 },
                        padding: 8,
                        callback: function(value) {
                            return value + (yAxisConfig.unit || '');
                        }
                    }
                }
            }
        }
    };
}

function initWeeklyCharts() {
    const { labels, toursData, timeData, feelingData, totalTours, totalTime, avgFeeling } = getWeeklyData();
    
    // Détruire les anciens graphiques s'ils existent
    if (chartToursWeekly) chartToursWeekly.destroy();
    if (chartTimeWeekly) chartTimeWeekly.destroy();
    if (chartFeelingWeekly) chartFeelingWeekly.destroy();
    
    // Graphique Tours
    const ctxTours = document.getElementById('chart-tours-weekly');
    if (ctxTours) {
        chartToursWeekly = new Chart(ctxTours, createChartConfig(
            'Tours',
            { labels, values: toursData },
            '#3b82f6',
            { unit: '' }
        ));
    }
    
    // Graphique Temps
    const ctxTime = document.getElementById('chart-time-weekly');
    if (ctxTime) {
        chartTimeWeekly = new Chart(ctxTime, createChartConfig(
            'Temps',
            { labels, values: timeData },
            '#f59e0b',
            { unit: 'h' }
        ));
    }
    
    // Graphique Ressenti
    const ctxFeeling = document.getElementById('chart-feeling-weekly');
    if (ctxFeeling) {
        chartFeelingWeekly = new Chart(ctxFeeling, createChartConfig(
            'Ressenti',
            { labels, values: feelingData },
            '#ec4899',
            { min: 0, max: 5, unit: '' }
        ));
    }
    
    // Mettre à jour les totaux
    document.getElementById('weekly-tours-total').textContent = totalTours;
    document.getElementById('weekly-time-total').textContent = formatDuration(totalTime * 60);
    document.getElementById('weekly-feeling-avg').textContent = avgFeeling !== null ? avgFeeling + '/5' : '--';
}

function formatDuration(minutes) {
    const h = Math.floor(minutes / 60);
    const m = Math.round(minutes % 60);
    return h + 'h' + (m < 10 ? '0' : '') + m;
}

// Mettre à jour les graphiques quand le thème change
const originalThemeToggle = document.getElementById('theme-toggle');
if (originalThemeToggle) {
    originalThemeToggle.addEventListener('click', function() {
        setTimeout(initWeeklyCharts, 100);
    });
}


// ===== MESSAGE DE BIENVENUE =====
function updateWelcomeMessage(userName) {
    const welcomeEl = document.getElementById('welcome-message');
    if (welcomeEl && userName) {
        const hour = new Date().getHours();
        let greeting = 'Bienvenue';
        
        if (hour >= 5 && hour < 12) {
            greeting = 'Bonjour';
        } else if (hour >= 12 && hour < 18) {
            greeting = 'Bon après-midi';
        } else {
            greeting = 'Bonsoir';
        }
        
        welcomeEl.innerHTML = greeting + ', <span class="user-name">' + userName + '</span> !';
        welcomeEl.classList.add('visible');
    }
}


</script>
</body>
</html>

